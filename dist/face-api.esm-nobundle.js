
  /*
  Face-API
  homepage: <https://github.com/vladmandic/face-api>
  author: <https://github.com/vladmandic>'
  */

var yn=Object.create,Je=Object.defineProperty,vn=Object.getPrototypeOf,Tn=Object.prototype.hasOwnProperty,Fn=Object.getOwnPropertyNames,wn=Object.getOwnPropertyDescriptor;var Ar=o=>Je(o,"__esModule",{value:!0});var Sr=(o,t)=>()=>(t||(t={exports:{}},o(t.exports,t)),t.exports),Wr=(o,t)=>{for(var e in t)Je(o,e,{get:t[e],enumerable:!0})},vt=(o,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Fn(t))!Tn.call(o,r)&&r!=="default"&&Je(o,r,{get:()=>t[r],enumerable:!(e=wn(t,r))||e.enumerable});return o},Pn=o=>vt(Ar(Je(o!=null?yn(vn(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);import*as Aa from"@tensorflow/tfjs/dist/index.js";import*as Sa from"@tensorflow/tfjs-backend-wasm";var F=Sr(_n=>{Ar(_n);vt(_n,Aa);vt(_n,Sa)});var Do=Sr((Ln,_o)=>{Ar(Ln);Wr(Ln,{isNodejs:()=>kn});function kn(){return typeof global=="object"&&!0&&typeof _o!="undefined"&&typeof process!="undefined"&&!!process.version}});var Mo=Sr((_t,Eo)=>{var At=function(o){function t(){this.fetch=!1,this.DOMException=o.DOMException}return t.prototype=o,new t}(typeof self!="undefined"?self:_t);(function(o){var t=function(e){var r={searchParams:"URLSearchParams"in o,iterable:"Symbol"in o&&"iterator"in Symbol,blob:"FileReader"in o&&"Blob"in o&&function(){try{return new Blob,!0}catch(d){return!1}}(),formData:"FormData"in o,arrayBuffer:"ArrayBuffer"in o};function n(d){return d&&DataView.prototype.isPrototypeOf(d)}if(r.arrayBuffer)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],s=ArrayBuffer.isView||function(d){return d&&a.indexOf(Object.prototype.toString.call(d))>-1};function i(d){if(typeof d!="string"&&(d=String(d)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(d))throw new TypeError("Invalid character in header field name");return d.toLowerCase()}function c(d){return typeof d!="string"&&(d=String(d)),d}function m(d){var l={next:function(){var y=d.shift();return{done:y===void 0,value:y}}};return r.iterable&&(l[Symbol.iterator]=function(){return l}),l}function p(d){this.map={},d instanceof p?d.forEach(function(l,y){this.append(y,l)},this):Array.isArray(d)?d.forEach(function(l){this.append(l[0],l[1])},this):d&&Object.getOwnPropertyNames(d).forEach(function(l){this.append(l,d[l])},this)}p.prototype.append=function(d,l){d=i(d),l=c(l);var y=this.map[d];this.map[d]=y?y+", "+l:l},p.prototype.delete=function(d){delete this.map[i(d)]},p.prototype.get=function(d){return d=i(d),this.has(d)?this.map[d]:null},p.prototype.has=function(d){return this.map.hasOwnProperty(i(d))},p.prototype.set=function(d,l){this.map[i(d)]=c(l)},p.prototype.forEach=function(d,l){for(var y in this.map)this.map.hasOwnProperty(y)&&d.call(l,this.map[y],y,this)},p.prototype.keys=function(){var d=[];return this.forEach(function(l,y){d.push(y)}),m(d)},p.prototype.values=function(){var d=[];return this.forEach(function(l){d.push(l)}),m(d)},p.prototype.entries=function(){var d=[];return this.forEach(function(l,y){d.push([y,l])}),m(d)},r.iterable&&(p.prototype[Symbol.iterator]=p.prototype.entries);function u(d){if(d.bodyUsed)return Promise.reject(new TypeError("Already read"));d.bodyUsed=!0}function f(d){return new Promise(function(l,y){d.onload=function(){l(d.result)},d.onerror=function(){y(d.error)}})}function h(d){var l=new FileReader,y=f(l);return l.readAsArrayBuffer(d),y}function v(d){var l=new FileReader,y=f(l);return l.readAsText(d),y}function _(d){for(var l=new Uint8Array(d),y=new Array(l.length),B=0;B<l.length;B++)y[B]=String.fromCharCode(l[B]);return y.join("")}function b(d){if(d.slice)return d.slice(0);var l=new Uint8Array(d.byteLength);return l.set(new Uint8Array(d)),l.buffer}function g(){return this.bodyUsed=!1,this._initBody=function(d){this._bodyInit=d,d?typeof d=="string"?this._bodyText=d:r.blob&&Blob.prototype.isPrototypeOf(d)?this._bodyBlob=d:r.formData&&FormData.prototype.isPrototypeOf(d)?this._bodyFormData=d:r.searchParams&&URLSearchParams.prototype.isPrototypeOf(d)?this._bodyText=d.toString():r.arrayBuffer&&r.blob&&n(d)?(this._bodyArrayBuffer=b(d.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):r.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(d)||s(d))?this._bodyArrayBuffer=b(d):this._bodyText=d=Object.prototype.toString.call(d):this._bodyText="",this.headers.get("content-type")||(typeof d=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):r.searchParams&&URLSearchParams.prototype.isPrototypeOf(d)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},r.blob&&(this.blob=function(){var d=u(this);if(d)return d;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?u(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(h)}),this.text=function(){var d=u(this);if(d)return d;if(this._bodyBlob)return v(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(_(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},r.formData&&(this.formData=function(){return this.text().then(z)}),this.json=function(){return this.text().then(JSON.parse)},this}var P=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function w(d){var l=d.toUpperCase();return P.indexOf(l)>-1?l:d}function C(d,l){l=l||{};var y=l.body;if(d instanceof C){if(d.bodyUsed)throw new TypeError("Already read");this.url=d.url,this.credentials=d.credentials,l.headers||(this.headers=new p(d.headers)),this.method=d.method,this.mode=d.mode,this.signal=d.signal,!y&&d._bodyInit!=null&&(y=d._bodyInit,d.bodyUsed=!0)}else this.url=String(d);if(this.credentials=l.credentials||this.credentials||"same-origin",(l.headers||!this.headers)&&(this.headers=new p(l.headers)),this.method=w(l.method||this.method||"GET"),this.mode=l.mode||this.mode||null,this.signal=l.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&y)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(y)}C.prototype.clone=function(){return new C(this,{body:this._bodyInit})};function z(d){var l=new FormData;return d.trim().split("&").forEach(function(y){if(y){var B=y.split("="),O=B.shift().replace(/\+/g," "),N=B.join("=").replace(/\+/g," ");l.append(decodeURIComponent(O),decodeURIComponent(N))}}),l}function K(d){var l=new p,y=d.replace(/\r?\n[\t ]+/g," ");return y.split(/\r?\n/).forEach(function(B){var O=B.split(":"),N=O.shift().trim();if(N){var Le=O.join(":").trim();l.append(N,Le)}}),l}g.call(C.prototype);function W(d,l){l||(l={}),this.type="default",this.status=l.status===void 0?200:l.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in l?l.statusText:"OK",this.headers=new p(l.headers),this.url=l.url||"",this._initBody(d)}g.call(W.prototype),W.prototype.clone=function(){return new W(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new p(this.headers),url:this.url})},W.error=function(){var d=new W(null,{status:0,statusText:""});return d.type="error",d};var X=[301,302,303,307,308];W.redirect=function(d,l){if(X.indexOf(l)===-1)throw new RangeError("Invalid status code");return new W(null,{status:l,headers:{location:d}})},e.DOMException=o.DOMException;try{new e.DOMException}catch(d){e.DOMException=function(l,y){this.message=l,this.name=y;var B=Error(l);this.stack=B.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function rt(d,l){return new Promise(function(y,B){var O=new C(d,l);if(O.signal&&O.signal.aborted)return B(new e.DOMException("Aborted","AbortError"));var N=new XMLHttpRequest;function Le(){N.abort()}N.onload=function(){var se={status:N.status,statusText:N.statusText,headers:K(N.getAllResponseHeaders()||"")};se.url="responseURL"in N?N.responseURL:se.headers.get("X-Request-URL");var kr="response"in N?N.response:N.responseText;y(new W(kr,se))},N.onerror=function(){B(new TypeError("Network request failed"))},N.ontimeout=function(){B(new TypeError("Network request failed"))},N.onabort=function(){B(new e.DOMException("Aborted","AbortError"))},N.open(O.method,O.url,!0),O.credentials==="include"?N.withCredentials=!0:O.credentials==="omit"&&(N.withCredentials=!1),"responseType"in N&&r.blob&&(N.responseType="blob"),O.headers.forEach(function(se,kr){N.setRequestHeader(kr,se)}),O.signal&&(O.signal.addEventListener("abort",Le),N.onreadystatechange=function(){N.readyState===4&&O.signal.removeEventListener("abort",Le)}),N.send(typeof O._bodyInit=="undefined"?null:O._bodyInit)})}return rt.polyfill=!0,o.fetch||(o.fetch=rt,o.Headers=p,o.Request=C,o.Response=W),e.Headers=p,e.Request=C,e.Response=W,e.fetch=rt,e}({})})(At);delete At.fetch.polyfill;_t=At.fetch;_t.default=At.fetch;_t.fetch=At.fetch;_t.Headers=At.Headers;_t.Request=At.Request;_t.Response=At.Response;Eo.exports=_t});var Ca=F();var co={};Wr(co,{AnchorPosition:()=>bt,DrawBox:()=>tr,DrawBoxOptions:()=>Zr,DrawFaceLandmarks:()=>io,DrawFaceLandmarksOptions:()=>so,DrawTextField:()=>kt,DrawTextFieldOptions:()=>We,drawContour:()=>Tt,drawDetections:()=>Wn,drawFaceExpressions:()=>jn,drawFaceLandmarks:()=>Hn});function Tt(o,t,e=!1){if(o.beginPath(),t.slice(1).forEach(({x:r,y:n},a)=>{let s=t[a];o.moveTo(s.x,s.y),o.lineTo(r,n)}),e){let r=t[t.length-1],n=t[0];if(!r||!n)return;o.moveTo(r.x,r.y),o.lineTo(n.x,n.y)}o.stroke()}var Br={};Wr(Br,{computeReshapedDimensions:()=>$r,getCenterPoint:()=>zt,isDimensions:()=>Ke,isEven:()=>Ze,isFloat:()=>Or,isTensor:()=>Yt,isTensor1D:()=>Dn,isTensor2D:()=>Rr,isTensor3D:()=>Ft,isTensor4D:()=>Q,isValidNumber:()=>mt,isValidProbablitiy:()=>ie,range:()=>lt,round:()=>Gt});var Fo=F();var j=class{constructor(t,e){if(!mt(t)||!mt(e))throw new Error(`Dimensions.constructor - expected width and height to be valid numbers, instead have ${JSON.stringify({width:t,height:e})}`);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}reverse(){return new j(1/this.width,1/this.height)}};function Yt(o,t){return o instanceof Fo.Tensor&&o.shape.length===t}function Dn(o){return Yt(o,1)}function Rr(o){return Yt(o,2)}function Ft(o){return Yt(o,3)}function Q(o){return Yt(o,4)}function Or(o){return o%1!=0}function Ze(o){return o%2==0}function Gt(o,t=2){let e=10**t;return Math.floor(o*e)/e}function Ke(o){return o&&o.width&&o.height}function $r({width:o,height:t},e){let r=e/Math.max(t,o);return new j(Math.round(o*r),Math.round(t*r))}function zt(o){return o.reduce((t,e)=>t.add(e),new T(0,0)).div(new T(o.length,o.length))}function lt(o,t,e){return Array(o).fill(0).map((r,n)=>t+n*e)}function mt(o){return!!o&&o!==Infinity&&o!==-Infinity&&!Number.isNaN(o)||o===0}function ie(o){return mt(o)&&o>=0&&o<=1}var T=class{constructor(t,e){this._x=t,this._y=e}get x(){return this._x}get y(){return this._y}add(t){return new T(this.x+t.x,this.y+t.y)}sub(t){return new T(this.x-t.x,this.y-t.y)}mul(t){return new T(this.x*t.x,this.y*t.y)}div(t){return new T(this.x/t.x,this.y/t.y)}abs(){return new T(Math.abs(this.x),Math.abs(this.y))}magnitude(){return Math.sqrt(this.x**2+this.y**2)}floor(){return new T(Math.floor(this.x),Math.floor(this.y))}};var E=class{static isRect(t){return!!t&&[t.x,t.y,t.width,t.height].every(mt)}static assertIsValidBox(t,e,r=!1){if(!E.isRect(t))throw new Error(`${e} - invalid box: ${JSON.stringify(t)}, expected object with properties x, y, width, height`);if(!r&&(t.width<0||t.height<0))throw new Error(`${e} - width (${t.width}) and height (${t.height}) must be positive numbers`)}constructor(t,e=!0){let r=t||{},n=[r.left,r.top,r.right,r.bottom].every(mt),a=[r.x,r.y,r.width,r.height].every(mt);if(!a&&!n)throw new Error(`Box.constructor - expected box to be IBoundingBox | IRect, instead have ${JSON.stringify(r)}`);let[s,i,c,m]=a?[r.x,r.y,r.width,r.height]:[r.left,r.top,r.right-r.left,r.bottom-r.top];E.assertIsValidBox({x:s,y:i,width:c,height:m},"Box.constructor",e),this._x=s,this._y=i,this._width=c,this._height=m}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get area(){return this.width*this.height}get topLeft(){return new T(this.left,this.top)}get topRight(){return new T(this.right,this.top)}get bottomLeft(){return new T(this.left,this.bottom)}get bottomRight(){return new T(this.right,this.bottom)}round(){let[t,e,r,n]=[this.x,this.y,this.width,this.height].map(a=>Math.round(a));return new E({x:t,y:e,width:r,height:n})}floor(){let[t,e,r,n]=[this.x,this.y,this.width,this.height].map(a=>Math.floor(a));return new E({x:t,y:e,width:r,height:n})}toSquare(){let{x:t,y:e,width:r,height:n}=this,a=Math.abs(r-n);return r<n&&(t-=a/2,r+=a),n<r&&(e-=a/2,n+=a),new E({x:t,y:e,width:r,height:n})}rescale(t){let e=Ke(t)?t.width:t,r=Ke(t)?t.height:t;return new E({x:this.x*e,y:this.y*r,width:this.width*e,height:this.height*r})}pad(t,e){let[r,n,a,s]=[this.x-t/2,this.y-e/2,this.width+t,this.height+e];return new E({x:r,y:n,width:a,height:s})}clipAtImageBorders(t,e){let{x:r,y:n,right:a,bottom:s}=this,i=Math.max(r,0),c=Math.max(n,0),m=a-i,p=s-c,u=Math.min(m,t-i),f=Math.min(p,e-c);return new E({x:i,y:c,width:u,height:f}).floor()}shift(t,e){let{width:r,height:n}=this,a=this.x+t,s=this.y+e;return new E({x:a,y:s,width:r,height:n})}padAtBorders(t,e){let r=this.width+1,n=this.height+1,a=1,s=1,i=r,c=n,m=this.left,p=this.top,u=this.right,f=this.bottom;return u>e&&(i=-u+e+r,u=e),f>t&&(c=-f+t+n,f=t),m<1&&(c=2-m,m=1),p<1&&(c=2-p,p=1),{dy:s,edy:c,dx:a,edx:i,y:p,ey:f,x:m,ex:u,w:r,h:n}}calibrate(t){return new E({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()}};var ce=class extends E{constructor(t,e,r,n,a=!1){super({left:t,top:e,right:r,bottom:n},a)}};var It=class{constructor(t,e,r,n,a){this._imageDims=new j(a.width,a.height),this._score=t,this._classScore=e,this._className=r,this._box=new E(n).rescale(this._imageDims)}get score(){return this._score}get classScore(){return this._classScore}get className(){return this._className}get box(){return this._box}get imageDims(){return this._imageDims}get imageWidth(){return this.imageDims.width}get imageHeight(){return this.imageDims.height}get relativeBox(){return new E(this._box).rescale(this.imageDims.reverse())}forSize(t,e){return new It(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:e})}};var L=class extends It{constructor(t,e,r){super(t,t,"",e,r)}forSize(t,e){let{score:r,relativeBox:n,imageDims:a}=super.forSize(t,e);return new L(r,n,a)}};function jr(o,t,e=!0){let r=Math.max(0,Math.min(o.right,t.right)-Math.max(o.left,t.left)),n=Math.max(0,Math.min(o.bottom,t.bottom)-Math.max(o.top,t.top)),a=r*n;return e?a/(o.area+t.area-a):a/Math.min(o.area,t.area)}function Hr(o){let t=o.map(i=>i.x),e=o.map(i=>i.y),r=t.reduce((i,c)=>c<i?c:i,Infinity),n=e.reduce((i,c)=>c<i?c:i,Infinity),a=t.reduce((i,c)=>i<c?c:i,0),s=e.reduce((i,c)=>i<c?c:i,0);return new ce(r,n,a,s)}function Yr(o,t,e,r=!0){let n=t.map((s,i)=>({score:s,boxIndex:i})).sort((s,i)=>s.score-i.score).map(s=>s.boxIndex),a=[];for(;n.length>0;){let s=n.pop();a.push(s);let i=n,c=[];for(let m=0;m<i.length;m++){let p=i[m],u=o[s],f=o[p];c.push(jr(u,f,r))}n=n.filter((m,p)=>c[p]<=e)}return a}var ht=F();function pt(o,t){return ht.tidy(()=>{let[e,r,n]=t,a=ht.fill([...o.shape.slice(0,3),1],e,"float32"),s=ht.fill([...o.shape.slice(0,3),1],r,"float32"),i=ht.fill([...o.shape.slice(0,3),1],n,"float32"),c=ht.concat([a,s,i],3);return ht.sub(o,c)})}var Lt=F();function Gr(o,t=!1){return Lt.tidy(()=>{let[e,r]=o.shape.slice(1);if(e===r)return o;let n=Math.abs(e-r),a=Math.round(n*(t?.5:1)),s=e>r?2:1,i=f=>{let h=o.shape.slice();return h[s]=f,Lt.fill(h,0,"float32")},c=i(a),m=n-c.shape[s],u=[t&&m?i(m):null,o,c].filter(f=>!!f).map(f=>Lt.cast(f,"float32"));return Lt.concat(u,s)})}function En(o){let t=o.slice();for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[r],t[r]=n}return t}function ke(o){return 1/(1+Math.exp(-o))}function Mn(o){return Math.log(o/(1-o))}var me=class extends E{constructor(t,e,r,n,a=!1){super({x:t,y:e,width:r,height:n},a)}};var Cn=.5,Nn=.43,In=.45,tt=class{constructor(t,e,r=new T(0,0)){let{width:n,height:a}=e;this._imgDims=new j(n,a),this._shift=r,this._positions=t.map(s=>s.mul(new T(n,a)).add(r))}get shift(){return new T(this._shift.x,this._shift.y)}get imageWidth(){return this._imgDims.width}get imageHeight(){return this._imgDims.height}get positions(){return this._positions}get relativePositions(){return this._positions.map(t=>t.sub(this._shift).div(new T(this.imageWidth,this.imageHeight)))}forSize(t,e){return new this.constructor(this.relativePositions,{width:t,height:e})}shiftBy(t,e){return new this.constructor(this.relativePositions,this._imgDims,new T(t,e))}shiftByPoint(t){return this.shiftBy(t.x,t.y)}align(t,e={}){if(t){let a=t instanceof L?t.box.floor():new E(t);return this.shiftBy(a.x,a.y).align(null,e)}let{useDlibAlignment:r,minBoxPadding:n}={useDlibAlignment:!1,minBoxPadding:.2,...e};return r?this.alignDlib():this.alignMinBbox(n)}alignDlib(){let t=this.getRefPointsForAlignment(),[e,r,n]=t,a=u=>n.sub(u).magnitude(),s=(a(e)+a(r))/2,i=Math.floor(s/In),c=zt(t),m=Math.floor(Math.max(0,c.x-Cn*i)),p=Math.floor(Math.max(0,c.y-Nn*i));return new me(m,p,Math.min(i,this.imageWidth+m),Math.min(i,this.imageHeight+p))}alignMinBbox(t){let e=Hr(this.positions);return e.pad(e.width*t,e.height*t)}getRefPointsForAlignment(){throw new Error("getRefPointsForAlignment not implemented by base class")}};var wo=class extends tt{getRefPointsForAlignment(){let t=this.positions;return[t[0],t[1],zt([t[3],t[4]])]}};var pe=class extends tt{getJawOutline(){return this.positions.slice(0,17)}getLeftEyeBrow(){return this.positions.slice(17,22)}getRightEyeBrow(){return this.positions.slice(22,27)}getNose(){return this.positions.slice(27,36)}getLeftEye(){return this.positions.slice(36,42)}getRightEye(){return this.positions.slice(42,48)}getMouth(){return this.positions.slice(48,68)}getRefPointsForAlignment(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(zt)}};var Ae=class{constructor(t,e){this._label=t,this._distance=e}get label(){return this._label}get distance(){return this._distance}toString(t=!0){return`${this.label}${t?` (${Gt(this.distance)})`:""}`}};var Se=class extends E{static assertIsValidLabeledBox(t,e){if(E.assertIsValidBox(t,e),!mt(t.label))throw new Error(`${e} - expected property label (${t.label}) to be a number`)}constructor(t,e){super(t);this._label=e}get label(){return this._label}};var wt=class{constructor(t,e){if(typeof t!="string")throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(r=>!(r instanceof Float32Array)))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=t,this._descriptors=e}get label(){return this._label}get descriptors(){return this._descriptors}toJSON(){return{label:this.label,descriptors:this.descriptors.map(t=>Array.from(t))}}static fromJSON(t){let e=t.descriptors.map(r=>new Float32Array(r));return new wt(t.label,e)}};var Po=class extends Se{static assertIsValidPredictedBox(t,e){if(Se.assertIsValidLabeledBox(t,e),!ie(t.score)||!ie(t.classScore))throw new Error(`${e} - expected properties score (${t.score}) and (${t.classScore}) to be a number between [0, 1]`)}constructor(t,e,r,n){super(t,e);this._score=r,this._classScore=n}get score(){return this._score}get classScore(){return this._classScore}};function xt(o){return o.detection instanceof L}function Ut(o,t){return{...o,...{detection:t}}}function zr(){let o=window.fetch;if(!o)throw new Error("fetch - missing fetch implementation for browser environment");return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:()=>document.createElement("canvas"),createImageElement:()=>document.createElement("img"),fetch:o,readFile:()=>{throw new Error("readFile - filesystem not available for browser environment")}}}function Qe(o){let t="";if(!o)try{o=require("fs")}catch(r){t=r.toString()}return{readFile:o?r=>new Promise((n,a)=>{o.readFile(r,(s,i)=>s?a(s):n(i))}):()=>{throw new Error(`readFile - failed to require fs in nodejs environment with error: ${t}`)}}}function Ur(){let o=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,e=()=>{if(o)return new o;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},r=()=>{if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},n=global.fetch,a=Qe();return{Canvas:o||class{},CanvasRenderingContext2D:global.CanvasRenderingContext2D||class{},Image:t||class{},ImageData:global.ImageData||class{},Video:global.HTMLVideoElement||class{},createCanvasElement:e,createImageElement:r,fetch:n,...a}}function Vr(){return typeof window=="object"&&typeof document!="undefined"&&typeof HTMLImageElement!="undefined"&&typeof HTMLCanvasElement!="undefined"&&typeof HTMLVideoElement!="undefined"&&typeof ImageData!="undefined"&&typeof CanvasRenderingContext2D!="undefined"}var Xr=Pn(Do()),R;function An(){if(!R)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return R}function qr(o){R=o}function Jr(){return Vr()?qr(zr()):(0,Xr.isNodejs)()?qr(Ur()):null}function Sn(o){if(R||Jr(),!R)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");let{Canvas:t=R.Canvas,Image:e=R.Image}=o;R.Canvas=t,R.Image=e,R.createCanvasElement=o.createCanvasElement||(()=>new t),R.createImageElement=o.createImageElement||(()=>new e),R.ImageData=o.ImageData||R.ImageData,R.Video=o.Video||R.Video,R.fetch=o.fetch||R.fetch,R.readFile=o.readFile||R.readFile}var M={getEnv:An,setEnv:qr,initialize:Jr,createBrowserEnv:zr,createFileSystem:Qe,createNodejsEnv:Ur,monkeyPatch:Sn,isBrowser:Vr,isNodejs:Xr.isNodejs};Jr();function Vt(o){return!M.isNodejs()&&typeof o=="string"?document.getElementById(o):o}function U(o){let{Canvas:t,CanvasRenderingContext2D:e}=M.getEnv();if(o instanceof e)return o;let r=Vt(o);if(!(r instanceof t))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");let n=r.getContext("2d");if(!n)throw new Error("resolveContext2d - canvas 2d context is null");return n}var bt;(function(o){o.TOP_LEFT="TOP_LEFT",o.TOP_RIGHT="TOP_RIGHT",o.BOTTOM_LEFT="BOTTOM_LEFT",o.BOTTOM_RIGHT="BOTTOM_RIGHT"})(bt||(bt={}));var We=class{constructor(t={}){let{anchorPosition:e,backgroundColor:r,fontColor:n,fontSize:a,fontStyle:s,padding:i}=t;this.anchorPosition=e||bt.TOP_LEFT,this.backgroundColor=r||"rgba(0, 0, 0, 0.5)",this.fontColor=n||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=s||"Georgia",this.padding=i||4}},kt=class{constructor(t,e,r={}){this.text=typeof t=="string"?[t]:t instanceof kt?t.text:t,this.anchor=e,this.options=new We(r)}measureWidth(t){let{padding:e}=this.options;return this.text.map(r=>t.measureText(r).width).reduce((r,n)=>r<n?n:r,0)+2*e}measureHeight(){let{fontSize:t,padding:e}=this.options;return this.text.length*t+2*e}getUpperLeft(t,e){let{anchorPosition:r}=this.options,n=r===bt.BOTTOM_RIGHT||r===bt.TOP_RIGHT,a=r===bt.BOTTOM_LEFT||r===bt.BOTTOM_RIGHT,s=this.measureWidth(t),i=this.measureHeight(),c=n?this.anchor.x-s:this.anchor.x,m=a?this.anchor.y-i:this.anchor.y;if(e){let{width:p,height:u}=e,f=Math.max(Math.min(c,p-s),0),h=Math.max(Math.min(m,u-i),0);return{x:f,y:h}}return{x:c,y:m}}draw(t){let e=Vt(t),r=U(e),{backgroundColor:n,fontColor:a,fontSize:s,fontStyle:i,padding:c}=this.options;r.font=`${s}px ${i}`;let m=this.measureWidth(r),p=this.measureHeight();r.fillStyle=n;let u=this.getUpperLeft(r,e);r.fillRect(u.x,u.y,m,p),r.fillStyle=a,this.text.forEach((f,h)=>{let v=c+u.x,_=c+u.y+(h+1)*s;r.fillText(f,v,_)})}};var Zr=class{constructor(t={}){let{boxColor:e,lineWidth:r,label:n,drawLabelOptions:a}=t;this.boxColor=e||"rgba(0, 0, 255, 1)",this.lineWidth=r||2,this.label=n;let s={anchorPosition:bt.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new We({...s,...a})}},tr=class{constructor(t,e={}){this.box=new E(t),this.options=new Zr(e)}draw(t){let e=U(t),{boxColor:r,lineWidth:n}=this.options,{x:a,y:s,width:i,height:c}=this.box;e.strokeStyle=r,e.lineWidth=n,e.strokeRect(a,s,i,c);let{label:m}=this.options;m&&new kt([m],{x:a-n/2,y:s},this.options.drawLabelOptions).draw(t)}};function Wn(o,t){(Array.isArray(t)?t:[t]).forEach(r=>{let n=r instanceof L?r.score:xt(r)?r.detection.score:void 0,a=r instanceof L?r.box:xt(r)?r.detection.box:new E(r),s=n?`${Gt(n)}`:void 0;new tr(a,{label:s}).draw(o)})}var ge=F();function Be(o){let{Image:t,Video:e}=M.getEnv();return o instanceof t&&o.complete||o instanceof e&&o.readyState>=3}function Kr(o){return new Promise((t,e)=>{if(o instanceof M.getEnv().Canvas||Be(o))return t(null);function r(a){!a.currentTarget||(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",r),e(a))}function n(a){!a.currentTarget||(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",r),t(a))}o.addEventListener("load",n),o.addEventListener("error",r)})}function Qr(o){return new Promise((t,e)=>{o instanceof Blob||e(new Error("bufferToImage - expected buf to be of type: Blob"));let r=new FileReader;r.onload=()=>{typeof r.result!="string"&&e(new Error("bufferToImage - expected reader.result to be a string, in onload"));let n=M.getEnv().createImageElement();n.onload=()=>t(n),n.onerror=e,n.src=r.result},r.onerror=e,r.readAsDataURL(o)})}function Xt(o){let{Image:t,Video:e}=M.getEnv();return o instanceof t?new j(o.naturalWidth,o.naturalHeight):o instanceof e?new j(o.videoWidth,o.videoHeight):new j(o.width,o.height)}function qt({width:o,height:t}){let{createCanvasElement:e}=M.getEnv(),r=e();return r.width=o,r.height=t,r}function Re(o,t){let{ImageData:e}=M.getEnv();if(!(o instanceof e)&&!Be(o))throw new Error("createCanvasFromMedia - media has not finished loading yet");let{width:r,height:n}=t||Xt(o),a=qt({width:r,height:n});return o instanceof e?U(a).putImageData(o,0,0):U(a).drawImage(o,0,0,r,n),a}var er=F();async function to(o,t){let e=t||M.getEnv().createCanvasElement(),[r,n,a]=o.shape.slice(Q(o)?1:0),s=er.tidy(()=>o.as3D(r,n,a).toInt());return await er.browser.toPixels(s,e),s.dispose(),e}function rr(o){let{Image:t,Canvas:e,Video:r}=M.getEnv();return o instanceof t||o instanceof e||o instanceof r}var ot=F();function eo(o,t,e=!1){let{Image:r,Canvas:n}=M.getEnv();if(!(o instanceof r||o instanceof n))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");if(t<=0)return qt({width:1,height:1});let a=Xt(o),s=t/Math.max(a.height,a.width),i=s*a.width,c=s*a.height,m=qt({width:t,height:t}),p=o instanceof n?o:Re(o),u=Math.abs(i-c)/2,f=e&&i<c?u:0,h=e&&c<i?u:0;return p.width>0&&p.height>0&&U(m).drawImage(p,f,h,i,c),m}var Pt=class{constructor(t,e=!1){this._imageTensors=[];this._canvases=[];this._treatAsBatchInput=!1;this._inputDimensions=[];if(!Array.isArray(t))throw new Error(`NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have ${t}`);this._treatAsBatchInput=e,this._batchSize=t.length,t.forEach((r,n)=>{if(Ft(r)){this._imageTensors[n]=r,this._inputDimensions[n]=r.shape;return}if(Q(r)){let s=r.shape[0];if(s!==1)throw new Error(`NetInput - tf.Tensor4D with batchSize ${s} passed, but not supported in input array`);this._imageTensors[n]=r,this._inputDimensions[n]=r.shape.slice(1);return}let a=r instanceof M.getEnv().Canvas?r:Re(r);this._canvases[n]=a,this._inputDimensions[n]=[a.height,a.width,3]})}get imageTensors(){return this._imageTensors}get canvases(){return this._canvases}get isBatchInput(){return this.batchSize>1||this._treatAsBatchInput}get batchSize(){return this._batchSize}get inputDimensions(){return this._inputDimensions}get inputSize(){return this._inputSize}get reshapedInputDimensions(){return lt(this.batchSize,0,1).map((t,e)=>this.getReshapedInputDimensions(e))}getInput(t){return this.canvases[t]||this.imageTensors[t]}getInputDimensions(t){return this._inputDimensions[t]}getInputHeight(t){return this._inputDimensions[t][0]}getInputWidth(t){return this._inputDimensions[t][1]}getReshapedInputDimensions(t){if(typeof this.inputSize!="number")throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");let e=this.getInputWidth(t),r=this.getInputHeight(t);return $r({width:e,height:r},this.inputSize)}toBatchTensor(t,e=!0){return this._inputSize=t,ot.tidy(()=>{let r=lt(this.batchSize,0,1).map(a=>{let s=this.getInput(a);if(s instanceof ot.Tensor){let i=Q(s)?s:s.expandDims();return i=Gr(i,e),(i.shape[1]!==t||i.shape[2]!==t)&&(i=ot.image.resizeBilinear(i,[t,t])),i.as3D(t,t,3)}if(s instanceof M.getEnv().Canvas)return ot.browser.fromPixels(eo(s,t,e));throw new Error(`toBatchTensor - at batchIdx ${a}, expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have ${s}`)});return ot.stack(r.map(a=>ot.cast(a,"float32"))).as4D(this.batchSize,t,t,3)})}};async function I(o){if(o instanceof Pt)return o;let t=Array.isArray(o)?o:[o];if(!t.length)throw new Error("toNetInput - empty array passed as input");let e=n=>Array.isArray(o)?` at input index ${n}:`:"",r=t.map(Vt);return r.forEach((n,a)=>{if(!rr(n)&&!Ft(n)&&!Q(n))throw typeof t[a]=="string"?new Error(`toNetInput -${e(a)} string passed, but could not resolve HTMLElement for element id ${t[a]}`):new Error(`toNetInput -${e(a)} expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id`);if(Q(n)){let s=n.shape[0];if(s!==1)throw new Error(`toNetInput -${e(a)} tf.Tensor4D with batchSize ${s} passed, but not supported in input array`)}}),await Promise.all(r.map(n=>rr(n)&&Kr(n))),new Pt(r,Array.isArray(o))}async function de(o,t){let{Canvas:e}=M.getEnv(),r=o;if(!(o instanceof e)){let s=await I(o);if(s.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");let i=s.getInput(0);r=i instanceof e?i:await to(i)}let n=U(r);return t.map(s=>s instanceof L?s.forSize(r.width,r.height).box.floor():s).map(s=>s.clipAtImageBorders(r.width,r.height)).map(({x:s,y:i,width:c,height:m})=>{let p=qt({width:c,height:m});return c>0&&m>0&&U(p).putImageData(n.getImageData(s,i,c,m),0,0),p})}var or=F();async function ue(o,t){if(!Ft(o)&&!Q(o))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(Q(o)&&o.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return or.tidy(()=>{let[e,r,n]=o.shape.slice(Q(o)?1:0);return t.map(i=>i instanceof L?i.forSize(r,e).box:i).map(i=>i.clipAtImageBorders(r,e)).map(({x:i,y:c,width:m,height:p})=>or.slice3d(o.as3D(e,r,n),[c,i,0],[p,m,n]))})}var Bn=Mo();async function Jt(o,t){let e=await Bn(o,t);if(!(e.status<400))throw console.log(`failed to fetch: (${e.status}) ${e.statusText}, from url: ${e.url}`),new Error(`failed to fetch: (${e.status}) ${e.statusText}, from url: ${e.url}`);return e}async function Rn(o){let t=await Jt(o),e=await t.blob();if(!e.type.startsWith("image/"))throw new Error(`fetchImage - expected blob type to be of type image/*, instead have: ${e.type}, for url: ${t.url}`);return Qr(e)}async function ro(o){return(await Jt(o)).json()}async function On(o){return new Float32Array(await(await Jt(o)).arrayBuffer())}var Co=F();function nr(o,t){let e=`${t}-weights_manifest.json`;if(!o)return{modelBaseUri:"",manifestUri:e};if(o==="/")return{modelBaseUri:"/",manifestUri:`/${e}`};let r=o.startsWith("http://")?"http://":o.startsWith("https://")?"https://":"";o=o.replace(r,"");let n=o.split("/").filter(i=>i),a=o.endsWith(".json")?n[n.length-1]:e,s=r+(o.endsWith(".json")?n.slice(0,n.length-1):n).join("/");return s=o.startsWith("/")?`/${s}`:s,{modelBaseUri:s,manifestUri:s==="/"?`/${a}`:`${s}/${a}`}}async function oo(o,t){let{manifestUri:e,modelBaseUri:r}=nr(o,t),n=await ro(e);return Co.io.loadWeights(n,r)}function $n(o,t,e=!1){let{width:r,height:n}=e?Xt(t):t;return o.width=r,o.height=n,{width:r,height:n}}var Wt=F();var Dt=F();var $=class{constructor(t){this._params=void 0;this._paramMappings=[];this._name=t}get params(){return this._params}get paramMappings(){return this._paramMappings}get isLoaded(){return!!this.params}getParamFromPath(t){let{obj:e,objProp:r}=this.traversePropertyPath(t);return e[r]}reassignParamFromPath(t,e){let{obj:r,objProp:n}=this.traversePropertyPath(t);r[n].dispose(),r[n]=e}getParamList(){return this._paramMappings.map(({paramPath:t})=>({path:t,tensor:this.getParamFromPath(t)}))}getTrainableParams(){return this.getParamList().filter(t=>t.tensor instanceof Dt.Variable)}getFrozenParams(){return this.getParamList().filter(t=>!(t.tensor instanceof Dt.Variable))}variable(){this.getFrozenParams().forEach(({path:t,tensor:e})=>{this.reassignParamFromPath(t,e.variable())})}freeze(){this.getTrainableParams().forEach(({path:t,tensor:e})=>{let r=Dt.tensor(e.dataSync());e.dispose(),this.reassignParamFromPath(t,r)})}dispose(t=!0){this.getParamList().forEach(e=>{if(t&&e.tensor.isDisposed)throw new Error(`param tensor has already been disposed for path ${e.path}`);e.tensor.dispose()}),this._params=void 0}serializeParams(){return new Float32Array(this.getParamList().map(({tensor:t})=>Array.from(t.dataSync())).reduce((t,e)=>t.concat(e)))}async load(t){if(t instanceof Float32Array){this.extractWeights(t);return}await this.loadFromUri(t)}async loadFromUri(t){if(t&&typeof t!="string")throw new Error(`${this._name}.loadFromUri - expected model uri`);let e=await oo(t,this.getDefaultModelName());this.loadFromWeightMap(e)}async loadFromDisk(t){if(t&&typeof t!="string")throw new Error(`${this._name}.loadFromDisk - expected model file path`);let{readFile:e}=M.getEnv(),{manifestUri:r,modelBaseUri:n}=nr(t,this.getDefaultModelName()),a=m=>Promise.all(m.map(p=>e(p).then(u=>u.buffer))),s=Dt.io.weightsLoaderFactory(a),i=JSON.parse((await e(r)).toString()),c=await s(i,n);this.loadFromWeightMap(c)}loadFromWeightMap(t){let{paramMappings:e,params:r}=this.extractParamsFromWeightMap(t);this._paramMappings=e,this._params=r}extractWeights(t){let{paramMappings:e,params:r}=this.extractParams(t);this._paramMappings=e,this._params=r}traversePropertyPath(t){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");let e=t.split("/").reduce((a,s)=>{if(!a.nextObj.hasOwnProperty(s))throw new Error(`traversePropertyPath - object does not have property ${s}, for path ${t}`);return{obj:a.nextObj,objProp:s,nextObj:a.nextObj[s]}},{nextObj:this.params}),{obj:r,objProp:n}=e;if(!r||!n||!(r[n]instanceof Dt.Tensor))throw new Error(`traversePropertyPath - parameter is not a tensor, for path ${t}`);return{obj:r,objProp:n}}};var k=F();var fe=F();function V(o,t,e){return fe.tidy(()=>{let r=fe.separableConv2d(o,t.depthwise_filter,t.pointwise_filter,e,"same");return r=fe.add(r,t.bias),r})}function ar(o,t,e=!1){return k.tidy(()=>{let r=k.relu(e?k.add(k.conv2d(o,t.conv0.filters,[2,2],"same"),t.conv0.bias):V(o,t.conv0,[2,2])),n=V(r,t.conv1,[1,1]),a=k.relu(k.add(r,n)),s=V(a,t.conv2,[1,1]);return k.relu(k.add(r,k.add(n,s)))})}function Oe(o,t,e=!1,r=!0){return k.tidy(()=>{let n=k.relu(e?k.add(k.conv2d(o,t.conv0.filters,r?[2,2]:[1,1],"same"),t.conv0.bias):V(o,t.conv0,r?[2,2]:[1,1])),a=V(n,t.conv1,[1,1]),s=k.relu(k.add(n,a)),i=V(s,t.conv2,[1,1]),c=k.relu(k.add(n,k.add(a,i))),m=V(c,t.conv3,[1,1]);return k.relu(k.add(n,k.add(a,k.add(i,m))))})}var St=F();function Zt(o,t,e="same",r=!1){return St.tidy(()=>{let n=St.add(St.conv2d(o,t.filters,[1,1],e),t.bias);return r?St.relu(n):n})}function H(o,t){Object.keys(o).forEach(e=>{t.some(r=>r.originalPath===e)||o[e].dispose()})}var sr=F();function le(o,t){return(e,r,n,a)=>{let s=sr.tensor4d(o(e*r*n*n),[n,n,e,r]),i=sr.tensor1d(o(r));return t.push({paramPath:`${a}/filters`},{paramPath:`${a}/bias`}),{filters:s,bias:i}}}var ir=F();function cr(o,t){return(e,r,n)=>{let a=ir.tensor2d(o(e*r),[e,r]),s=ir.tensor1d(o(r));return t.push({paramPath:`${n}/weights`},{paramPath:`${n}/bias`}),{weights:a,bias:s}}}var $e=F();var mr=class{constructor(t,e,r){this.depthwise_filter=t;this.pointwise_filter=e;this.bias=r}};function he(o,t){return(e,r,n)=>{let a=$e.tensor4d(o(3*3*e),[3,3,e,1]),s=$e.tensor4d(o(e*r),[1,1,e,r]),i=$e.tensor1d(o(r));return t.push({paramPath:`${n}/depthwise_filter`},{paramPath:`${n}/pointwise_filter`},{paramPath:`${n}/bias`}),new mr(a,s,i)}}function xe(o){return t=>{let e=o(`${t}/depthwise_filter`,4),r=o(`${t}/pointwise_filter`,4),n=o(`${t}/bias`,1);return new mr(e,r,n)}}function q(o,t){return(e,r,n)=>{let a=o[e];if(!Yt(a,r))throw new Error(`expected weightMap[${e}] to be a Tensor${r}D, instead have ${a}`);return t.push({originalPath:e,paramPath:n||e}),a}}function Y(o){let t=o;function e(n){let a=t.slice(0,n);return t=t.slice(n),a}function r(){return t}return{extractWeights:e,getRemainingWeights:r}}function pr(o,t){let e=le(o,t),r=he(o,t);function n(s,i,c,m=!1){let p=m?e(s,i,3,`${c}/conv0`):r(s,i,`${c}/conv0`),u=r(i,i,`${c}/conv1`),f=r(i,i,`${c}/conv2`);return{conv0:p,conv1:u,conv2:f}}function a(s,i,c,m=!1){let{conv0:p,conv1:u,conv2:f}=n(s,i,c,m),h=r(i,i,`${c}/conv3`);return{conv0:p,conv1:u,conv2:f,conv3:h}}return{extractDenseBlock3Params:n,extractDenseBlock4Params:a}}function No(o){let t=[],{extractWeights:e,getRemainingWeights:r}=Y(o),{extractDenseBlock4Params:n}=pr(e,t),a=n(3,32,"dense0",!0),s=n(32,64,"dense1"),i=n(64,128,"dense2"),c=n(128,256,"dense3");if(r().length!==0)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{dense0:a,dense1:s,dense2:i,dense3:c}}}function dr(o){return t=>{let e=o(`${t}/filters`,4),r=o(`${t}/bias`,1);return{filters:e,bias:r}}}function ur(o,t){let e=q(o,t),r=dr(e),n=xe(e);function a(i,c=!1){let m=c?r(`${i}/conv0`):n(`${i}/conv0`),p=n(`${i}/conv1`),u=n(`${i}/conv2`);return{conv0:m,conv1:p,conv2:u}}function s(i,c=!1){let m=c?r(`${i}/conv0`):n(`${i}/conv0`),p=n(`${i}/conv1`),u=n(`${i}/conv2`),f=n(`${i}/conv3`);return{conv0:m,conv1:p,conv2:u,conv3:f}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:s}}function Io(o){let t=[],{extractDenseBlock4Params:e}=ur(o,t),r={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2"),dense3:e("dense3")};return H(o,t),{params:r,paramMappings:t}}var je=class extends ${constructor(){super("FaceFeatureExtractor")}forwardInput(t){let{params:e}=this;if(!e)throw new Error("FaceFeatureExtractor - load model before inference");return Wt.tidy(()=>{let r=Wt.cast(t.toBatchTensor(112,!0),"float32"),a=pt(r,[122.782,117.001,104.298]).div(Wt.scalar(255)),s=Oe(a,e.dense0,!0);return s=Oe(s,e.dense1),s=Oe(s,e.dense2),s=Oe(s,e.dense3),s=Wt.avgPool(s,[7,7],[2,2],"valid"),s})}async forward(t){return this.forwardInput(await I(t))}getDefaultModelName(){return"face_feature_extractor_model"}extractParamsFromWeightMap(t){return Io(t)}extractParams(t){return No(t)}};var Ao=F();var be=F();function He(o,t){return be.tidy(()=>be.add(be.matMul(o,t.weights),t.bias))}function Lo(o,t,e){let r=[],{extractWeights:n,getRemainingWeights:a}=Y(o),i=cr(n,r)(t,e,"fc");if(a().length!==0)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:r,params:{fc:i}}}function ko(o){let t=[],e=q(o,t);function r(a){let s=e(`${a}/weights`,2),i=e(`${a}/bias`,1);return{weights:s,bias:i}}let n={fc:r("fc")};return H(o,t),{params:n,paramMappings:t}}function fr(o){let t={},e={};return Object.keys(o).forEach(r=>{let n=r.startsWith("fc")?e:t;n[r]=o[r]}),{featureExtractorMap:t,classifierMap:e}}var Ye=class extends ${constructor(t,e){super(t);this._faceFeatureExtractor=e}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(t){let{params:e}=this;if(!e)throw new Error(`${this._name} - load model before inference`);return Ao.tidy(()=>{let r=t instanceof Pt?this.faceFeatureExtractor.forwardInput(t):t;return He(r.as2D(r.shape[0],-1),e.fc)})}dispose(t=!0){this.faceFeatureExtractor.dispose(t),super.dispose(t)}loadClassifierParams(t){let{params:e,paramMappings:r}=this.extractClassifierParams(t);this._params=e,this._paramMappings=r}extractClassifierParams(t){return Lo(t,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())}extractParamsFromWeightMap(t){let{featureExtractorMap:e,classifierMap:r}=fr(t);return this.faceFeatureExtractor.loadFromWeightMap(e),ko(r)}extractParams(t){let e=this.getClassifierChannelsIn(),r=this.getClassifierChannelsOut(),n=r*e+r,a=t.slice(0,t.length-n),s=t.slice(t.length-n);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(s)}};var no=["neutral","happy","sad","angry","fearful","disgusted","surprised"],Bt=class{constructor(t){if(t.length!==7)throw new Error(`FaceExpressions.constructor - expected probabilities.length to be 7, have: ${t.length}`);no.forEach((e,r)=>{this[e]=t[r]})}asSortedArray(){return no.map(t=>({expression:t,probability:this[t]})).sort((t,e)=>e.probability-t.probability)}};var lr=class extends Ye{constructor(t=new je){super("FaceExpressionNet",t)}forwardInput(t){return ge.tidy(()=>ge.softmax(this.runNet(t)))}async forward(t){return this.forwardInput(await I(t))}async predictExpressions(t){let e=await I(t),r=await this.forwardInput(e),n=await Promise.all(ge.unstack(r).map(async s=>{let i=await s.data();return s.dispose(),i}));r.dispose();let a=n.map(s=>new Bt(s));return e.isBatchInput?a:a[0]}getDefaultModelName(){return"face_expression_model"}getClassifierChannelsIn(){return 256}getClassifierChannelsOut(){return 7}};function ao(o){return o.expressions instanceof Bt}function hr(o,t){return{...o,...{expressions:t}}}function jn(o,t,e=.1,r){(Array.isArray(t)?t:[t]).forEach(a=>{let s=a instanceof Bt?a:ao(a)?a.expressions:void 0;if(!s)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");let c=s.asSortedArray().filter(u=>u.probability>e),m=xt(a)?a.detection.box.bottomLeft:r||new T(0,0);new kt(c.map(u=>`${u.expression} (${Gt(u.probability)})`),m).draw(o)})}function Kt(o){return xt(o)&&o.landmarks instanceof tt&&o.unshiftedLandmarks instanceof tt&&o.alignedRect instanceof L}function ye(o,t){let{box:e}=o.detection,r=t.shiftBy(e.x,e.y),n=r.align(),{imageDims:a}=o.detection,s=new L(o.detection.score,n.rescale(a.reverse()),a);return{...o,...{landmarks:r,unshiftedLandmarks:t,alignedRect:s}}}var so=class{constructor(t={}){let{drawLines:e=!0,drawPoints:r=!0,lineWidth:n,lineColor:a,pointSize:s,pointColor:i}=t;this.drawLines=e,this.drawPoints=r,this.lineWidth=n||1,this.pointSize=s||2,this.lineColor=a||"rgba(0, 255, 255, 1)",this.pointColor=i||"rgba(255, 0, 255, 1)"}},io=class{constructor(t,e={}){this.faceLandmarks=t,this.options=new so(e)}draw(t){let e=U(t),{drawLines:r,drawPoints:n,lineWidth:a,lineColor:s,pointSize:i,pointColor:c}=this.options;if(r&&this.faceLandmarks instanceof pe&&(e.strokeStyle=s,e.lineWidth=a,Tt(e,this.faceLandmarks.getJawOutline()),Tt(e,this.faceLandmarks.getLeftEyeBrow()),Tt(e,this.faceLandmarks.getRightEyeBrow()),Tt(e,this.faceLandmarks.getNose()),Tt(e,this.faceLandmarks.getLeftEye(),!0),Tt(e,this.faceLandmarks.getRightEye(),!0),Tt(e,this.faceLandmarks.getMouth(),!0)),n){e.strokeStyle=c,e.fillStyle=c;let m=p=>{e.beginPath(),e.arc(p.x,p.y,i,0,2*Math.PI),e.fill()};this.faceLandmarks.positions.forEach(m)}}};function Hn(o,t){(Array.isArray(t)?t:[t]).forEach(r=>{let n=r instanceof tt?r:Kt(r)?r.landmarks:void 0;if(!n)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new io(n).draw(o)})}var So="0.30.3";var gt=F();var S=F();function Yn(o,t){let e=le(o,t),r=he(o,t);function n(s,i,c){let m=r(s,i,`${c}/separable_conv0`),p=r(i,i,`${c}/separable_conv1`),u=e(s,i,1,`${c}/expansion_conv`);return{separable_conv0:m,separable_conv1:p,expansion_conv:u}}function a(s,i){let c=r(s,s,`${i}/separable_conv0`),m=r(s,s,`${i}/separable_conv1`),p=r(s,s,`${i}/separable_conv2`);return{separable_conv0:c,separable_conv1:m,separable_conv2:p}}return{extractConvParams:e,extractSeparableConvParams:r,extractReductionBlockParams:n,extractMainBlockParams:a}}function Wo(o,t){let e=[],{extractWeights:r,getRemainingWeights:n}=Y(o),{extractConvParams:a,extractSeparableConvParams:s,extractReductionBlockParams:i,extractMainBlockParams:c}=Yn(r,e),m=a(3,32,3,"entry_flow/conv_in"),p=i(32,64,"entry_flow/reduction_block_0"),u=i(64,128,"entry_flow/reduction_block_1"),f={conv_in:m,reduction_block_0:p,reduction_block_1:u},h={};lt(t,0,1).forEach(g=>{h[`main_block_${g}`]=c(128,`middle_flow/main_block_${g}`)});let v=i(128,256,"exit_flow/reduction_block"),_=s(256,512,"exit_flow/separable_conv"),b={reduction_block:v,separable_conv:_};if(n().length!==0)throw new Error(`weights remaing after extract: ${n().length}`);return{paramMappings:e,params:{entry_flow:f,middle_flow:h,exit_flow:b}}}function Gn(o,t){let e=q(o,t),r=dr(e),n=xe(e);function a(i){let c=n(`${i}/separable_conv0`),m=n(`${i}/separable_conv1`),p=r(`${i}/expansion_conv`);return{separable_conv0:c,separable_conv1:m,expansion_conv:p}}function s(i){let c=n(`${i}/separable_conv0`),m=n(`${i}/separable_conv1`),p=n(`${i}/separable_conv2`);return{separable_conv0:c,separable_conv1:m,separable_conv2:p}}return{extractConvParams:r,extractSeparableConvParams:n,extractReductionBlockParams:a,extractMainBlockParams:s}}function Bo(o,t){let e=[],{extractConvParams:r,extractSeparableConvParams:n,extractReductionBlockParams:a,extractMainBlockParams:s}=Gn(o,e),i=r("entry_flow/conv_in"),c=a("entry_flow/reduction_block_0"),m=a("entry_flow/reduction_block_1"),p={conv_in:i,reduction_block_0:c,reduction_block_1:m},u={};lt(t,0,1).forEach(_=>{u[`main_block_${_}`]=s(`middle_flow/main_block_${_}`)});let f=a("exit_flow/reduction_block"),h=n("exit_flow/separable_conv"),v={reduction_block:f,separable_conv:h};return H(o,e),{params:{entry_flow:p,middle_flow:u,exit_flow:v},paramMappings:e}}function Ro(o,t,e){return S.add(S.conv2d(o,t.filters,e,"same"),t.bias)}function mo(o,t,e=!0){let r=e?S.relu(o):o;return r=V(r,t.separable_conv0,[1,1]),r=V(S.relu(r),t.separable_conv1,[1,1]),r=S.maxPool(r,[3,3],[2,2],"same"),r=S.add(r,Ro(o,t.expansion_conv,[2,2])),r}function zn(o,t){let e=V(S.relu(o),t.separable_conv0,[1,1]);return e=V(S.relu(e),t.separable_conv1,[1,1]),e=V(S.relu(e),t.separable_conv2,[1,1]),e=S.add(e,o),e}var po=class extends ${constructor(t){super("TinyXception");this._numMainBlocks=t}forwardInput(t){let{params:e}=this;if(!e)throw new Error("TinyXception - load model before inference");return S.tidy(()=>{let r=S.cast(t.toBatchTensor(112,!0),"float32"),a=pt(r,[122.782,117.001,104.298]).div(S.scalar(256)),s=S.relu(Ro(a,e.entry_flow.conv_in,[2,2]));return s=mo(s,e.entry_flow.reduction_block_0,!1),s=mo(s,e.entry_flow.reduction_block_1),lt(this._numMainBlocks,0,1).forEach(i=>{s=zn(s,e.middle_flow[`main_block_${i}`])}),s=mo(s,e.exit_flow.reduction_block),s=S.relu(V(s,e.exit_flow.separable_conv,[1,1])),s})}async forward(t){return this.forwardInput(await I(t))}getDefaultModelName(){return"tiny_xception_model"}extractParamsFromWeightMap(t){return Bo(t,this._numMainBlocks)}extractParams(t){return Wo(t,this._numMainBlocks)}};function Oo(o){let t=[],{extractWeights:e,getRemainingWeights:r}=Y(o),n=cr(e,t),a=n(512,1,"fc/age"),s=n(512,2,"fc/gender");if(r().length!==0)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{fc:{age:a,gender:s}}}}function $o(o){let t=[],e=q(o,t);function r(a){let s=e(`${a}/weights`,2),i=e(`${a}/bias`,1);return{weights:s,bias:i}}let n={fc:{age:r("fc/age"),gender:r("fc/gender")}};return H(o,t),{params:n,paramMappings:t}}var Et;(function(o){o.FEMALE="female",o.MALE="male"})(Et||(Et={}));var xr=class extends ${constructor(t=new po(2)){super("AgeGenderNet");this._faceFeatureExtractor=t}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(t){let{params:e}=this;if(!e)throw new Error(`${this._name} - load model before inference`);return gt.tidy(()=>{let r=t instanceof Pt?this.faceFeatureExtractor.forwardInput(t):t,n=gt.avgPool(r,[7,7],[2,2],"valid").as2D(r.shape[0],-1),a=He(n,e.fc.age).as1D(),s=He(n,e.fc.gender);return{age:a,gender:s}})}forwardInput(t){return gt.tidy(()=>{let{age:e,gender:r}=this.runNet(t);return{age:e,gender:gt.softmax(r)}})}async forward(t){return this.forwardInput(await I(t))}async predictAgeAndGender(t){let e=await I(t),r=await this.forwardInput(e),n=gt.unstack(r.age),a=gt.unstack(r.gender),s=n.map((c,m)=>({ageTensor:c,genderTensor:a[m]})),i=await Promise.all(s.map(async({ageTensor:c,genderTensor:m})=>{let p=(await c.data())[0],u=(await m.data())[0],f=u>.5,h=f?Et.MALE:Et.FEMALE,v=f?u:1-u;return c.dispose(),m.dispose(),{age:p,gender:h,genderProbability:v}}));return r.age.dispose(),r.gender.dispose(),e.isBatchInput?i:i[0]}getDefaultModelName(){return"age_gender_model"}dispose(t=!0){this.faceFeatureExtractor.dispose(t),super.dispose(t)}loadClassifierParams(t){let{params:e,paramMappings:r}=this.extractClassifierParams(t);this._params=e,this._paramMappings=r}extractClassifierParams(t){return Oo(t)}extractParamsFromWeightMap(t){let{featureExtractorMap:e,classifierMap:r}=fr(t);return this.faceFeatureExtractor.loadFromWeightMap(e),$o(r)}extractParams(t){let e=512*1+1+(512*2+2),r=t.slice(0,t.length-e),n=t.slice(t.length-e);return this.faceFeatureExtractor.extractWeights(r),this.extractClassifierParams(n)}};var J=F();var Ge=class extends Ye{postProcess(t,e,r){let n=r.map(({width:s,height:i})=>{let c=e/Math.max(i,s);return{width:s*c,height:i*c}}),a=n.length;return J.tidy(()=>{let s=(u,f)=>J.stack([J.fill([68],u,"float32"),J.fill([68],f,"float32")],1).as2D(1,136).as1D(),i=(u,f)=>{let{width:h,height:v}=n[u];return f(h,v)?Math.abs(h-v)/2:0},c=u=>i(u,(f,h)=>f<h),m=u=>i(u,(f,h)=>h<f);return t.mul(J.fill([a,136],e,"float32")).sub(J.stack(Array.from(Array(a),(u,f)=>s(c(f),m(f))))).div(J.stack(Array.from(Array(a),(u,f)=>s(n[f].width,n[f].height))))})}forwardInput(t){return J.tidy(()=>{let e=this.runNet(t);return this.postProcess(e,t.inputSize,t.inputDimensions.map(([r,n])=>({height:r,width:n})))})}async forward(t){return this.forwardInput(await I(t))}async detectLandmarks(t){let e=await I(t),r=J.tidy(()=>J.unstack(this.forwardInput(e))),n=await Promise.all(r.map(async(a,s)=>{let i=Array.from(await a.data()),c=i.filter((p,u)=>Ze(u)),m=i.filter((p,u)=>!Ze(u));return new pe(Array(68).fill(0).map((p,u)=>new T(c[u],m[u])),{height:e.getInputHeight(s),width:e.getInputWidth(s)})}));return r.forEach(a=>a.dispose()),e.isBatchInput?n:n[0]}getClassifierChannelsOut(){return 136}};var ve=class extends Ge{constructor(t=new je){super("FaceLandmark68Net",t)}getDefaultModelName(){return"face_landmark_68_model"}getClassifierChannelsIn(){return 256}};var Rt=F();function jo(o){let t=[],{extractDenseBlock3Params:e}=ur(o,t),r={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2")};return H(o,t),{params:r,paramMappings:t}}function Ho(o){let t=[],{extractWeights:e,getRemainingWeights:r}=Y(o),{extractDenseBlock3Params:n}=pr(e,t),a=n(3,32,"dense0",!0),s=n(32,64,"dense1"),i=n(64,128,"dense2");if(r().length!==0)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{dense0:a,dense1:s,dense2:i}}}var uo=class extends ${constructor(){super("TinyFaceFeatureExtractor")}forwardInput(t){let{params:e}=this;if(!e)throw new Error("TinyFaceFeatureExtractor - load model before inference");return Rt.tidy(()=>{let r=Rt.cast(t.toBatchTensor(112,!0),"float32"),a=pt(r,[122.782,117.001,104.298]).div(Rt.scalar(255)),s=ar(a,e.dense0,!0);return s=ar(s,e.dense1),s=ar(s,e.dense2),s=Rt.avgPool(s,[14,14],[2,2],"valid"),s})}async forward(t){return this.forwardInput(await I(t))}getDefaultModelName(){return"face_feature_extractor_tiny_model"}extractParamsFromWeightMap(t){return jo(t)}extractParams(t){return Ho(t)}};var br=class extends Ge{constructor(t=new uo){super("FaceLandmark68TinyNet",t)}getDefaultModelName(){return"face_landmark_68_tiny_model"}getClassifierChannelsIn(){return 128}};var Yo=class extends ve{};var et=F();var Te=F();var gr=F();function Go(o,t){return gr.add(gr.mul(o,t.weights),t.biases)}function fo(o,t,e,r,n="same"){let{filters:a,bias:s}=t.conv,i=Te.conv2d(o,a,e,n);return i=Te.add(i,s),i=Go(i,t.scale),r?Te.relu(i):i}function zo(o,t){return fo(o,t,[1,1],!0)}function lo(o,t){return fo(o,t,[1,1],!1)}function yr(o,t){return fo(o,t,[2,2],!0,"valid")}var Z=F();function Un(o,t){function e(i,c,m){let p=o(i),u=p.length/(c*m*m);if(Or(u))throw new Error(`depth has to be an integer: ${u}, weights.length: ${p.length}, numFilters: ${c}, filterSize: ${m}`);return Z.tidy(()=>Z.transpose(Z.tensor4d(p,[c,u,m,m]),[2,3,1,0]))}function r(i,c,m,p){let u=e(i,c,m),f=Z.tensor1d(o(c));return t.push({paramPath:`${p}/filters`},{paramPath:`${p}/bias`}),{filters:u,bias:f}}function n(i,c){let m=Z.tensor1d(o(i)),p=Z.tensor1d(o(i));return t.push({paramPath:`${c}/weights`},{paramPath:`${c}/biases`}),{weights:m,biases:p}}function a(i,c,m,p){let u=r(i,c,m,`${p}/conv`),f=n(c,`${p}/scale`);return{conv:u,scale:f}}function s(i,c,m,p,u=!1){let f=a((u?.5:1)*i,c,m,`${p}/conv1`),h=a(i,c,m,`${p}/conv2`);return{conv1:f,conv2:h}}return{extractConvLayerParams:a,extractResidualLayerParams:s}}function Uo(o){let{extractWeights:t,getRemainingWeights:e}=Y(o),r=[],{extractConvLayerParams:n,extractResidualLayerParams:a}=Un(t,r),s=n(4704,32,7,"conv32_down"),i=a(9216,32,3,"conv32_1"),c=a(9216,32,3,"conv32_2"),m=a(9216,32,3,"conv32_3"),p=a(36864,64,3,"conv64_down",!0),u=a(36864,64,3,"conv64_1"),f=a(36864,64,3,"conv64_2"),h=a(36864,64,3,"conv64_3"),v=a(147456,128,3,"conv128_down",!0),_=a(147456,128,3,"conv128_1"),b=a(147456,128,3,"conv128_2"),g=a(589824,256,3,"conv256_down",!0),P=a(589824,256,3,"conv256_1"),w=a(589824,256,3,"conv256_2"),C=a(589824,256,3,"conv256_down_out"),z=Z.tidy(()=>Z.transpose(Z.tensor2d(t(256*128),[128,256]),[1,0]));if(r.push({paramPath:"fc"}),e().length!==0)throw new Error(`weights remaing after extract: ${e().length}`);return{params:{conv32_down:s,conv32_1:i,conv32_2:c,conv32_3:m,conv64_down:p,conv64_1:u,conv64_2:f,conv64_3:h,conv128_down:v,conv128_1:_,conv128_2:b,conv256_down:g,conv256_1:P,conv256_2:w,conv256_down_out:C,fc:z},paramMappings:r}}function Vn(o,t){let e=q(o,t);function r(s){let i=e(`${s}/scale/weights`,1),c=e(`${s}/scale/biases`,1);return{weights:i,biases:c}}function n(s){let i=e(`${s}/conv/filters`,4),c=e(`${s}/conv/bias`,1),m=r(s);return{conv:{filters:i,bias:c},scale:m}}function a(s){return{conv1:n(`${s}/conv1`),conv2:n(`${s}/conv2`)}}return{extractConvLayerParams:n,extractResidualLayerParams:a}}function Vo(o){let t=[],{extractConvLayerParams:e,extractResidualLayerParams:r}=Vn(o,t),n=e("conv32_down"),a=r("conv32_1"),s=r("conv32_2"),i=r("conv32_3"),c=r("conv64_down"),m=r("conv64_1"),p=r("conv64_2"),u=r("conv64_3"),f=r("conv128_down"),h=r("conv128_1"),v=r("conv128_2"),_=r("conv256_down"),b=r("conv256_1"),g=r("conv256_2"),P=r("conv256_down_out"),{fc:w}=o;if(t.push({originalPath:"fc",paramPath:"fc"}),!Rr(w))throw new Error(`expected weightMap[fc] to be a Tensor2D, instead have ${w}`);let C={conv32_down:n,conv32_1:a,conv32_2:s,conv32_3:i,conv64_down:c,conv64_1:m,conv64_2:p,conv64_3:u,conv128_down:f,conv128_1:h,conv128_2:v,conv256_down:_,conv256_1:b,conv256_2:g,conv256_down_out:P,fc:w};return H(o,t),{params:C,paramMappings:t}}var G=F();function dt(o,t){let e=zo(o,t.conv1);return e=lo(e,t.conv2),e=G.add(e,o),e=G.relu(e),e}function ze(o,t){let e=yr(o,t.conv1);e=lo(e,t.conv2);let r=G.avgPool(o,2,2,"valid"),n=G.zeros(r.shape),a=r.shape[3]!==e.shape[3];if(r.shape[1]!==e.shape[1]||r.shape[2]!==e.shape[2]){let i=[...e.shape];i[1]=1;let c=G.zeros(i);e=G.concat([e,c],1);let m=[...e.shape];m[2]=1;let p=G.zeros(m);e=G.concat([e,p],2)}return r=a?G.concat([r,n],3):r,e=G.add(r,e),e=G.relu(e),e}var Fe=class extends ${constructor(){super("FaceRecognitionNet")}forwardInput(t){let{params:e}=this;if(!e)throw new Error("FaceRecognitionNet - load model before inference");return et.tidy(()=>{let r=et.cast(t.toBatchTensor(150,!0),"float32"),a=pt(r,[122.782,117.001,104.298]).div(et.scalar(256)),s=yr(a,e.conv32_down);s=et.maxPool(s,3,2,"valid"),s=dt(s,e.conv32_1),s=dt(s,e.conv32_2),s=dt(s,e.conv32_3),s=ze(s,e.conv64_down),s=dt(s,e.conv64_1),s=dt(s,e.conv64_2),s=dt(s,e.conv64_3),s=ze(s,e.conv128_down),s=dt(s,e.conv128_1),s=dt(s,e.conv128_2),s=ze(s,e.conv256_down),s=dt(s,e.conv256_1),s=dt(s,e.conv256_2),s=ze(s,e.conv256_down_out);let i=s.mean([1,2]);return et.matMul(i,e.fc)})}async forward(t){return this.forwardInput(await I(t))}async computeFaceDescriptor(t){var a;if((a=t==null?void 0:t.shape)==null?void 0:a.some(s=>s<=0))return new Float32Array(128);let e=await I(t),r=et.tidy(()=>et.unstack(this.forwardInput(e))),n=await Promise.all(r.map(s=>s.data()));return r.forEach(s=>s.dispose()),e.isBatchInput?n:n[0]}getDefaultModelName(){return"face_recognition_model"}extractParamsFromWeightMap(t){return Vo(t)}extractParams(t){return Uo(t)}};function Xn(o){let t=new Fe;return t.extractWeights(o),t}function vr(o,t){return{...o,...{descriptor:t}}}function qn(o){return typeof o.age=="number"}function Tr(o,t){return{...o,...{age:t}}}function Jn(o){return(o.gender===Et.MALE||o.gender===Et.FEMALE)&&ie(o.genderProbability)}function Fr(o,t,e){return{...o,...{gender:t,genderProbability:e}}}var ft=F();var ut=F();function Zn(o,t){function e(c,m){let p=ut.tensor4d(o(3*3*c),[3,3,c,1]),u=ut.tensor1d(o(c)),f=ut.tensor1d(o(c)),h=ut.tensor1d(o(c)),v=ut.tensor1d(o(c));return t.push({paramPath:`${m}/filters`},{paramPath:`${m}/batch_norm_scale`},{paramPath:`${m}/batch_norm_offset`},{paramPath:`${m}/batch_norm_mean`},{paramPath:`${m}/batch_norm_variance`}),{filters:p,batch_norm_scale:u,batch_norm_offset:f,batch_norm_mean:h,batch_norm_variance:v}}function r(c,m,p,u,f){let h=ut.tensor4d(o(c*m*p*p),[p,p,c,m]),v=ut.tensor1d(o(m));return t.push({paramPath:`${u}/filters`},{paramPath:`${u}/${f?"batch_norm_offset":"bias"}`}),{filters:h,bias:v}}function n(c,m,p,u){let{filters:f,bias:h}=r(c,m,p,u,!0);return{filters:f,batch_norm_offset:h}}function a(c,m,p){let u=e(c,`${p}/depthwise_conv`),f=n(c,m,1,`${p}/pointwise_conv`);return{depthwise_conv:u,pointwise_conv:f}}function s(){let c=n(3,32,3,"mobilenetv1/conv_0"),m=a(32,64,"mobilenetv1/conv_1"),p=a(64,128,"mobilenetv1/conv_2"),u=a(128,128,"mobilenetv1/conv_3"),f=a(128,256,"mobilenetv1/conv_4"),h=a(256,256,"mobilenetv1/conv_5"),v=a(256,512,"mobilenetv1/conv_6"),_=a(512,512,"mobilenetv1/conv_7"),b=a(512,512,"mobilenetv1/conv_8"),g=a(512,512,"mobilenetv1/conv_9"),P=a(512,512,"mobilenetv1/conv_10"),w=a(512,512,"mobilenetv1/conv_11"),C=a(512,1024,"mobilenetv1/conv_12"),z=a(1024,1024,"mobilenetv1/conv_13");return{conv_0:c,conv_1:m,conv_2:p,conv_3:u,conv_4:f,conv_5:h,conv_6:v,conv_7:_,conv_8:b,conv_9:g,conv_10:P,conv_11:w,conv_12:C,conv_13:z}}function i(){let c=n(1024,256,1,"prediction_layer/conv_0"),m=n(256,512,3,"prediction_layer/conv_1"),p=n(512,128,1,"prediction_layer/conv_2"),u=n(128,256,3,"prediction_layer/conv_3"),f=n(256,128,1,"prediction_layer/conv_4"),h=n(128,256,3,"prediction_layer/conv_5"),v=n(256,64,1,"prediction_layer/conv_6"),_=n(64,128,3,"prediction_layer/conv_7"),b=r(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),g=r(512,9,1,"prediction_layer/box_predictor_0/class_predictor"),P=r(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),w=r(1024,18,1,"prediction_layer/box_predictor_1/class_predictor"),C=r(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),z=r(512,18,1,"prediction_layer/box_predictor_2/class_predictor"),K=r(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),W=r(256,18,1,"prediction_layer/box_predictor_3/class_predictor"),X=r(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),rt=r(256,18,1,"prediction_layer/box_predictor_4/class_predictor"),d=r(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),l=r(128,18,1,"prediction_layer/box_predictor_5/class_predictor");return{conv_0:c,conv_1:m,conv_2:p,conv_3:u,conv_4:f,conv_5:h,conv_6:v,conv_7:_,box_predictor_0:{box_encoding_predictor:b,class_predictor:g},box_predictor_1:{box_encoding_predictor:P,class_predictor:w},box_predictor_2:{box_encoding_predictor:C,class_predictor:z},box_predictor_3:{box_encoding_predictor:K,class_predictor:W},box_predictor_4:{box_encoding_predictor:X,class_predictor:rt},box_predictor_5:{box_encoding_predictor:d,class_predictor:l}}}return{extractMobilenetV1Params:s,extractPredictionLayerParams:i}}function Xo(o){let t=[],{extractWeights:e,getRemainingWeights:r}=Y(o),{extractMobilenetV1Params:n,extractPredictionLayerParams:a}=Zn(e,t),s=n(),i=a(),m={extra_dim:ut.tensor3d(e(5118*4),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),r().length!==0)throw new Error(`weights remaing after extract: ${r().length}`);return{params:{mobilenetv1:s,prediction_layer:i,output_layer:m},paramMappings:t}}function Kn(o,t){let e=q(o,t);function r(m,p,u){let f=e(`${m}/Conv2d_${p}_pointwise/weights`,4,`${u}/filters`),h=e(`${m}/Conv2d_${p}_pointwise/convolution_bn_offset`,1,`${u}/batch_norm_offset`);return{filters:f,batch_norm_offset:h}}function n(m){let p=`mobilenetv1/conv_${m}`,u=`MobilenetV1/Conv2d_${m}_depthwise`,f=`${p}/depthwise_conv`,h=`${p}/pointwise_conv`,v=e(`${u}/depthwise_weights`,4,`${f}/filters`),_=e(`${u}/BatchNorm/gamma`,1,`${f}/batch_norm_scale`),b=e(`${u}/BatchNorm/beta`,1,`${f}/batch_norm_offset`),g=e(`${u}/BatchNorm/moving_mean`,1,`${f}/batch_norm_mean`),P=e(`${u}/BatchNorm/moving_variance`,1,`${f}/batch_norm_variance`);return{depthwise_conv:{filters:v,batch_norm_scale:_,batch_norm_offset:b,batch_norm_mean:g,batch_norm_variance:P},pointwise_conv:r("MobilenetV1",m,h)}}function a(){return{conv_0:r("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:n(1),conv_2:n(2),conv_3:n(3),conv_4:n(4),conv_5:n(5),conv_6:n(6),conv_7:n(7),conv_8:n(8),conv_9:n(9),conv_10:n(10),conv_11:n(11),conv_12:n(12),conv_13:n(13)}}function s(m,p){let u=e(`${m}/weights`,4,`${p}/filters`),f=e(`${m}/biases`,1,`${p}/bias`);return{filters:u,bias:f}}function i(m){let p=s(`Prediction/BoxPredictor_${m}/BoxEncodingPredictor`,`prediction_layer/box_predictor_${m}/box_encoding_predictor`),u=s(`Prediction/BoxPredictor_${m}/ClassPredictor`,`prediction_layer/box_predictor_${m}/class_predictor`);return{box_encoding_predictor:p,class_predictor:u}}function c(){return{conv_0:r("Prediction",0,"prediction_layer/conv_0"),conv_1:r("Prediction",1,"prediction_layer/conv_1"),conv_2:r("Prediction",2,"prediction_layer/conv_2"),conv_3:r("Prediction",3,"prediction_layer/conv_3"),conv_4:r("Prediction",4,"prediction_layer/conv_4"),conv_5:r("Prediction",5,"prediction_layer/conv_5"),conv_6:r("Prediction",6,"prediction_layer/conv_6"),conv_7:r("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:i(0),box_predictor_1:i(1),box_predictor_2:i(2),box_predictor_3:i(3),box_predictor_4:i(4),box_predictor_5:i(5)}}return{extractMobilenetV1Params:a,extractPredictionLayerParams:c}}function qo(o){let t=[],{extractMobilenetV1Params:e,extractPredictionLayerParams:r}=Kn(o,t),n=o["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!Ft(n))throw new Error(`expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have ${n}`);let a={mobilenetv1:e(),prediction_layer:r(),output_layer:{extra_dim:n}};return H(o,t),{params:a,paramMappings:t}}var Mt=F();var Ot=F();function nt(o,t,e){return Ot.tidy(()=>{let r=Ot.conv2d(o,t.filters,e,"same");return r=Ot.add(r,t.batch_norm_offset),Ot.clipByValue(r,0,6)})}var Qn=.0010000000474974513;function ta(o,t,e){return Mt.tidy(()=>{let r=Mt.depthwiseConv2d(o,t.filters,e,"same");return r=Mt.batchNorm(r,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,Qn),Mt.clipByValue(r,0,6)})}function ea(o){return[2,4,6,12].some(t=>t===o)?[2,2]:[1,1]}function Jo(o,t){return Mt.tidy(()=>{let e,r=nt(o,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach((a,s)=>{let i=s+1,c=ea(i);r=ta(r,a.depthwise_conv,c),r=nt(r,a.pointwise_conv,[1,1]),i===11&&(e=r)}),e===null)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:r,conv11:e}})}function ra(o,t,e){let r=o.arraySync(),n=Math.min(r[t][0],r[t][2]),a=Math.min(r[t][1],r[t][3]),s=Math.max(r[t][0],r[t][2]),i=Math.max(r[t][1],r[t][3]),c=Math.min(r[e][0],r[e][2]),m=Math.min(r[e][1],r[e][3]),p=Math.max(r[e][0],r[e][2]),u=Math.max(r[e][1],r[e][3]),f=(s-n)*(i-a),h=(p-c)*(u-m);if(f<=0||h<=0)return 0;let v=Math.max(n,c),_=Math.max(a,m),b=Math.min(s,p),g=Math.min(i,u),P=Math.max(b-v,0)*Math.max(g-_,0);return P/(f+h-P)}function Zo(o,t,e,r,n){let a=o.shape[0],s=Math.min(e,a),i=t.map((p,u)=>({score:p,boxIndex:u})).filter(p=>p.score>n).sort((p,u)=>u.score-p.score),c=p=>p<=r?1:0,m=[];return i.forEach(p=>{if(m.length>=s)return;let u=p.score;for(let f=m.length-1;f>=0;--f){let h=ra(o,p.boxIndex,m[f]);if(h!==0&&(p.score*=c(h),p.score<=n))break}u===p.score&&m.push(p.boxIndex)}),m}var x=F();function oa(o){let t=x.unstack(x.transpose(o,[1,0])),e=[x.sub(t[2],t[0]),x.sub(t[3],t[1])],r=[x.add(t[0],x.div(e[0],x.scalar(2))),x.add(t[1],x.div(e[1],x.scalar(2)))];return{sizes:e,centers:r}}function na(o,t){let{sizes:e,centers:r}=oa(o),n=x.unstack(x.transpose(t,[1,0])),a=x.div(x.mul(x.exp(x.div(n[2],x.scalar(5))),e[0]),x.scalar(2)),s=x.add(x.mul(x.div(n[0],x.scalar(10)),e[0]),r[0]),i=x.div(x.mul(x.exp(x.div(n[3],x.scalar(5))),e[1]),x.scalar(2)),c=x.add(x.mul(x.div(n[1],x.scalar(10)),e[1]),r[1]);return x.transpose(x.stack([x.sub(s,a),x.sub(c,i),x.add(s,a),x.add(c,i)]),[1,0])}function Ko(o,t,e){return x.tidy(()=>{let r=o.shape[0],n=na(x.reshape(x.tile(e.extra_dim,[r,1,1]),[-1,4]),x.reshape(o,[-1,4]));n=x.reshape(n,[r,n.shape[0]/r,4]);let a=x.sigmoid(x.slice(t,[0,0,1],[-1,-1,-1])),s=x.slice(a,[0,0,0],[-1,-1,1]);s=x.reshape(s,[r,s.shape[1]]);let i=x.unstack(n),c=x.unstack(s);return{boxes:i,scores:c}})}var Ve=F();var Ue=F();function Qt(o,t){return Ue.tidy(()=>{let e=o.shape[0],r=Ue.reshape(Zt(o,t.box_encoding_predictor),[e,-1,1,4]),n=Ue.reshape(Zt(o,t.class_predictor),[e,-1,3]);return{boxPredictionEncoding:r,classPrediction:n}})}function Qo(o,t,e){return Ve.tidy(()=>{let r=nt(o,e.conv_0,[1,1]),n=nt(r,e.conv_1,[2,2]),a=nt(n,e.conv_2,[1,1]),s=nt(a,e.conv_3,[2,2]),i=nt(s,e.conv_4,[1,1]),c=nt(i,e.conv_5,[2,2]),m=nt(c,e.conv_6,[1,1]),p=nt(m,e.conv_7,[2,2]),u=Qt(t,e.box_predictor_0),f=Qt(o,e.box_predictor_1),h=Qt(n,e.box_predictor_2),v=Qt(s,e.box_predictor_3),_=Qt(c,e.box_predictor_4),b=Qt(p,e.box_predictor_5),g=Ve.concat([u.boxPredictionEncoding,f.boxPredictionEncoding,h.boxPredictionEncoding,v.boxPredictionEncoding,_.boxPredictionEncoding,b.boxPredictionEncoding],1),P=Ve.concat([u.classPrediction,f.classPrediction,h.classPrediction,v.classPrediction,_.classPrediction,b.classPrediction],1);return{boxPredictions:g,classPredictions:P}})}var at=class{constructor({minConfidence:t,maxResults:e}={}){this._name="SsdMobilenetv1Options";if(this._minConfidence=t||.5,this._maxResults=e||100,typeof this._minConfidence!="number"||this._minConfidence<=0||this._minConfidence>=1)throw new Error(`${this._name} - expected minConfidence to be a number between 0 and 1`);if(typeof this._maxResults!="number")throw new Error(`${this._name} - expected maxResults to be a number`)}get minConfidence(){return this._minConfidence}get maxResults(){return this._maxResults}};var te=class extends ${constructor(){super("SsdMobilenetv1")}forwardInput(t){let{params:e}=this;if(!e)throw new Error("SsdMobilenetv1 - load model before inference");return ft.tidy(()=>{let r=ft.cast(t.toBatchTensor(512,!1),"float32"),n=ft.sub(ft.mul(r,ft.scalar(.007843137718737125)),ft.scalar(1)),a=Jo(n,e.mobilenetv1),{boxPredictions:s,classPredictions:i}=Qo(a.out,a.conv11,e.prediction_layer);return Ko(s,i,e.output_layer)})}async forward(t){return this.forwardInput(await I(t))}async locateFaces(t,e={}){let{maxResults:r,minConfidence:n}=new at(e),a=await I(t),{boxes:s,scores:i}=this.forwardInput(a),c=s[0],m=i[0];for(let w=1;w<s.length;w++)s[w].dispose(),i[w].dispose();let p=Array.from(await m.data()),f=Zo(c,p,r,.5,n),h=a.getReshapedInputDimensions(0),v=a.inputSize,_=v/h.width,b=v/h.height,g=c.arraySync(),P=f.map(w=>{let[C,z]=[Math.max(0,g[w][0]),Math.min(1,g[w][2])].map(X=>X*b),[K,W]=[Math.max(0,g[w][1]),Math.min(1,g[w][3])].map(X=>X*_);return new L(p[w],new me(K,C,W-K,z-C),{height:a.getInputHeight(0),width:a.getInputWidth(0)})});return c.dispose(),m.dispose(),P}getDefaultModelName(){return"ssd_mobilenetv1_model"}extractParamsFromWeightMap(t){return qo(t)}extractParams(t){return Xo(t)}};function tn(o){let t=new te;return t.extractWeights(o),t}function aa(o){return tn(o)}var en=class extends te{};var rn=.4,on=[new T(.738768,.874946),new T(2.42204,2.65704),new T(4.30971,7.04493),new T(10.246,4.59428),new T(12.6868,11.8741)],nn=[new T(1.603231,2.094468),new T(6.041143,7.080126),new T(2.882459,3.518061),new T(4.266906,5.178857),new T(9.041765,10.66308)],an=[117.001,114.697,97.404],sn="tiny_yolov2_model",cn="tiny_yolov2_separable_conv_model";var A=F();var wr=o=>typeof o=="number";function ho(o){if(!o)throw new Error(`invalid config: ${o}`);if(typeof o.withSeparableConvs!="boolean")throw new Error(`config.withSeparableConvs has to be a boolean, have: ${o.withSeparableConvs}`);if(!wr(o.iouThreshold)||o.iouThreshold<0||o.iouThreshold>1)throw new Error(`config.iouThreshold has to be a number between [0, 1], have: ${o.iouThreshold}`);if(!Array.isArray(o.classes)||!o.classes.length||!o.classes.every(t=>typeof t=="string"))throw new Error(`config.classes has to be an array class names: string[], have: ${JSON.stringify(o.classes)}`);if(!Array.isArray(o.anchors)||!o.anchors.length||!o.anchors.map(t=>t||{}).every(t=>wr(t.x)&&wr(t.y)))throw new Error(`config.anchors has to be an array of { x: number, y: number }, have: ${JSON.stringify(o.anchors)}`);if(o.meanRgb&&(!Array.isArray(o.meanRgb)||o.meanRgb.length!==3||!o.meanRgb.every(wr)))throw new Error(`config.meanRgb has to be an array of shape [number, number, number], have: ${JSON.stringify(o.meanRgb)}`)}var it=F();var st=F();function we(o){return st.tidy(()=>{let t=st.mul(o,st.scalar(.10000000149011612));return st.add(st.relu(st.sub(o,t)),t)})}function Ct(o,t){return it.tidy(()=>{let e=it.pad(o,[[0,0],[1,1],[1,1],[0,0]]);return e=it.conv2d(e,t.conv.filters,[1,1],"valid"),e=it.sub(e,t.bn.sub),e=it.mul(e,t.bn.truediv),e=it.add(e,t.conv.bias),we(e)})}var $t=F();function Nt(o,t){return $t.tidy(()=>{let e=$t.pad(o,[[0,0],[1,1],[1,1],[0,0]]);return e=$t.separableConv2d(e,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),e=$t.add(e,t.bias),we(e)})}var xo=F();function sa(o,t){let e=le(o,t);function r(s,i){let c=xo.tensor1d(o(s)),m=xo.tensor1d(o(s));return t.push({paramPath:`${i}/sub`},{paramPath:`${i}/truediv`}),{sub:c,truediv:m}}function n(s,i,c){let m=e(s,i,3,`${c}/conv`),p=r(i,`${c}/bn`);return{conv:m,bn:p}}let a=he(o,t);return{extractConvParams:e,extractConvWithBatchNormParams:n,extractSeparableConvParams:a}}function mn(o,t,e,r){let{extractWeights:n,getRemainingWeights:a}=Y(o),s=[],{extractConvParams:i,extractConvWithBatchNormParams:c,extractSeparableConvParams:m}=sa(n,s),p;if(t.withSeparableConvs){let[u,f,h,v,_,b,g,P,w]=r,C=t.isFirstLayerConv2d?i(u,f,3,"conv0"):m(u,f,"conv0"),z=m(f,h,"conv1"),K=m(h,v,"conv2"),W=m(v,_,"conv3"),X=m(_,b,"conv4"),rt=m(b,g,"conv5"),d=P?m(g,P,"conv6"):void 0,l=w?m(P,w,"conv7"):void 0,y=i(w||P||g,5*e,1,"conv8");p={conv0:C,conv1:z,conv2:K,conv3:W,conv4:X,conv5:rt,conv6:d,conv7:l,conv8:y}}else{let[u,f,h,v,_,b,g,P,w]=r,C=c(u,f,"conv0"),z=c(f,h,"conv1"),K=c(h,v,"conv2"),W=c(v,_,"conv3"),X=c(_,b,"conv4"),rt=c(b,g,"conv5"),d=c(g,P,"conv6"),l=c(P,w,"conv7"),y=i(w,5*e,1,"conv8");p={conv0:C,conv1:z,conv2:K,conv3:W,conv4:X,conv5:rt,conv6:d,conv7:l,conv8:y}}if(a().length!==0)throw new Error(`weights remaing after extract: ${a().length}`);return{params:p,paramMappings:s}}function ia(o,t){let e=q(o,t);function r(i){let c=e(`${i}/sub`,1),m=e(`${i}/truediv`,1);return{sub:c,truediv:m}}function n(i){let c=e(`${i}/filters`,4),m=e(`${i}/bias`,1);return{filters:c,bias:m}}function a(i){let c=n(`${i}/conv`),m=r(`${i}/bn`);return{conv:c,bn:m}}let s=xe(e);return{extractConvParams:n,extractConvWithBatchNormParams:a,extractSeparableConvParams:s}}function pn(o,t){let e=[],{extractConvParams:r,extractConvWithBatchNormParams:n,extractSeparableConvParams:a}=ia(o,e),s;if(t.withSeparableConvs){let i=t.filterSizes&&t.filterSizes.length||9;s={conv0:t.isFirstLayerConv2d?r("conv0"):a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:i>7?a("conv6"):void 0,conv7:i>8?a("conv7"):void 0,conv8:r("conv8")}}else s={conv0:n("conv0"),conv1:n("conv1"),conv2:n("conv2"),conv3:n("conv3"),conv4:n("conv4"),conv5:n("conv5"),conv6:n("conv6"),conv7:n("conv7"),conv8:r("conv8")};return H(o,e),{params:s,paramMappings:e}}var yt=class{constructor({inputSize:t,scoreThreshold:e}={}){this._name="TinyYolov2Options";if(this._inputSize=t||416,this._scoreThreshold=e||.5,typeof this._inputSize!="number"||this._inputSize%32!=0)throw new Error(`${this._name} - expected inputSize to be a number divisible by 32`);if(typeof this._scoreThreshold!="number"||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(`${this._name} - expected scoreThreshold to be a number between 0 and 1`)}get inputSize(){return this._inputSize}get scoreThreshold(){return this._scoreThreshold}};var bo=class extends ${constructor(t){super("TinyYolov2");ho(t),this._config=t}get config(){return this._config}get withClassScores(){return this.config.withClassScores||this.config.classes.length>1}get boxEncodingSize(){return 5+(this.withClassScores?this.config.classes.length:0)}runTinyYolov2(t,e){let r=Ct(t,e.conv0);return r=A.maxPool(r,[2,2],[2,2],"same"),r=Ct(r,e.conv1),r=A.maxPool(r,[2,2],[2,2],"same"),r=Ct(r,e.conv2),r=A.maxPool(r,[2,2],[2,2],"same"),r=Ct(r,e.conv3),r=A.maxPool(r,[2,2],[2,2],"same"),r=Ct(r,e.conv4),r=A.maxPool(r,[2,2],[2,2],"same"),r=Ct(r,e.conv5),r=A.maxPool(r,[2,2],[1,1],"same"),r=Ct(r,e.conv6),r=Ct(r,e.conv7),Zt(r,e.conv8,"valid",!1)}runMobilenet(t,e){let r=this.config.isFirstLayerConv2d?we(Zt(t,e.conv0,"valid",!1)):Nt(t,e.conv0);return r=A.maxPool(r,[2,2],[2,2],"same"),r=Nt(r,e.conv1),r=A.maxPool(r,[2,2],[2,2],"same"),r=Nt(r,e.conv2),r=A.maxPool(r,[2,2],[2,2],"same"),r=Nt(r,e.conv3),r=A.maxPool(r,[2,2],[2,2],"same"),r=Nt(r,e.conv4),r=A.maxPool(r,[2,2],[2,2],"same"),r=Nt(r,e.conv5),r=A.maxPool(r,[2,2],[1,1],"same"),r=e.conv6?Nt(r,e.conv6):r,r=e.conv7?Nt(r,e.conv7):r,Zt(r,e.conv8,"valid",!1)}forwardInput(t,e){let{params:r}=this;if(!r)throw new Error("TinyYolov2 - load model before inference");return A.tidy(()=>{let n=A.cast(t.toBatchTensor(e,!1),"float32");return n=this.config.meanRgb?pt(n,this.config.meanRgb):n,n=n.div(A.scalar(256)),this.config.withSeparableConvs?this.runMobilenet(n,r):this.runTinyYolov2(n,r)})}async forward(t,e){return this.forwardInput(await I(t),e)}async detect(t,e={}){let{inputSize:r,scoreThreshold:n}=new yt(e),a=await I(t),s=await this.forwardInput(a,r),i=A.tidy(()=>A.unstack(s)[0].expandDims()),c={width:a.getInputWidth(0),height:a.getInputHeight(0)},m=await this.extractBoxes(i,a.getReshapedInputDimensions(0),n);s.dispose(),i.dispose();let p=m.map(b=>b.box),u=m.map(b=>b.score),f=m.map(b=>b.classScore),h=m.map(b=>this.config.classes[b.label]);return Yr(p.map(b=>b.rescale(r)),u,this.config.iouThreshold,!0).map(b=>new It(u[b],f[b],h[b],p[b],c))}getDefaultModelName(){return""}extractParamsFromWeightMap(t){return pn(t,this.config)}extractParams(t){let e=this.config.filterSizes||bo.DEFAULT_FILTER_SIZES,r=e?e.length:void 0;if(r!==7&&r!==8&&r!==9)throw new Error(`TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found ${r} filterSizes in config`);return mn(t,this.config,this.boxEncodingSize,e)}async extractBoxes(t,e,r){let{width:n,height:a}=e,s=Math.max(n,a),i=s/n,c=s/a,m=t.shape[1],p=this.config.anchors.length,[u,f,h]=A.tidy(()=>{let g=t.reshape([m,m,p,this.boxEncodingSize]),P=g.slice([0,0,0,0],[m,m,p,4]),w=g.slice([0,0,0,4],[m,m,p,1]),C=this.withClassScores?A.softmax(g.slice([0,0,0,5],[m,m,p,this.config.classes.length]),3):A.scalar(0);return[P,w,C]}),v=[],_=await f.array(),b=await u.array();for(let g=0;g<m;g++)for(let P=0;P<m;P++)for(let w=0;w<p;w++){let C=ke(_[g][P][w][0]);if(!r||C>r){let z=(P+ke(b[g][P][w][0]))/m*i,K=(g+ke(b[g][P][w][1]))/m*c,W=Math.exp(b[g][P][w][2])*this.config.anchors[w].x/m*i,X=Math.exp(b[g][P][w][3])*this.config.anchors[w].y/m*c,rt=z-W/2,d=K-X/2,l={row:g,col:P,anchor:w},{classScore:y,label:B}=this.withClassScores?await this.extractPredictedClass(h,l):{classScore:1,label:0};v.push({box:new ce(rt,d,rt+W,d+X),score:C,classScore:C*y,label:B,...l})}}return u.dispose(),f.dispose(),h.dispose(),v}async extractPredictedClass(t,e){let{row:r,col:n,anchor:a}=e,s=await t.array();return Array(this.config.classes.length).fill(0).map((i,c)=>s[r][n][a][c]).map((i,c)=>({classScore:i,label:c})).reduce((i,c)=>i.classScore>c.classScore?i:c)}},Pe=bo;Pe.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];var _e=class extends Pe{constructor(t=!0){let e={withSeparableConvs:t,iouThreshold:rn,classes:["face"],...t?{anchors:nn,meanRgb:an}:{anchors:on,withClassScores:!0}};super(e)}get withSeparableConvs(){return this.config.withSeparableConvs}get anchors(){return this.config.anchors}async locateFaces(t,e){return(await this.detect(t,e)).map(n=>new L(n.score,n.relativeBox,{width:n.imageWidth,height:n.imageHeight}))}getDefaultModelName(){return this.withSeparableConvs?cn:sn}extractParamsFromWeightMap(t){return super.extractParamsFromWeightMap(t)}};function ca(o,t=!0){let e=new _e(t);return e.extractWeights(o),e}var Pr=class extends yt{constructor(){super(...arguments);this._name="TinyFaceDetectorOptions"}};var ct=class{async then(t){return t(await this.run())}async run(){throw new Error("ComposableTask - run is not implemented")}};var Xe=F();var go=F();async function ee(o,t,e,r,n=({alignedRect:a})=>a){let a=o.map(c=>Kt(c)?n(c):c.detection),s=r||(t instanceof go.Tensor?await ue(t,a):await de(t,a)),i=await e(s);return s.forEach(c=>c instanceof go.Tensor&&c.dispose()),i}async function De(o,t,e,r,n){return ee([o],t,async a=>e(a[0]),r,n)}var dn=.4,un=[new T(1.603231,2.094468),new T(6.041143,7.080126),new T(2.882459,3.518061),new T(4.266906,5.178857),new T(9.041765,10.66308)],fn=[117.001,114.697,97.404];var Ee=class extends Pe{constructor(){let t={withSeparableConvs:!0,iouThreshold:dn,classes:["face"],anchors:un,meanRgb:fn,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};super(t)}get anchors(){return this.config.anchors}async locateFaces(t,e){return(await this.detect(t,e)).map(n=>new L(n.score,n.relativeBox,{width:n.imageWidth,height:n.imageHeight}))}getDefaultModelName(){return"tiny_face_detector_model"}extractParamsFromWeightMap(t){return super.extractParamsFromWeightMap(t)}};var D={ssdMobilenetv1:new te,tinyFaceDetector:new Ee,tinyYolov2:new _e,faceLandmark68Net:new ve,faceLandmark68TinyNet:new br,faceRecognitionNet:new Fe,faceExpressionNet:new lr,ageGenderNet:new xr},ln=(o,t)=>D.ssdMobilenetv1.locateFaces(o,t),ma=(o,t)=>D.tinyFaceDetector.locateFaces(o,t),pa=(o,t)=>D.tinyYolov2.locateFaces(o,t),hn=o=>D.faceLandmark68Net.detectLandmarks(o),da=o=>D.faceLandmark68TinyNet.detectLandmarks(o),ua=o=>D.faceRecognitionNet.computeFaceDescriptor(o),fa=o=>D.faceExpressionNet.predictExpressions(o),la=o=>D.ageGenderNet.predictAgeAndGender(o),xn=o=>D.ssdMobilenetv1.load(o),ha=o=>D.tinyFaceDetector.load(o),xa=o=>D.tinyYolov2.load(o),ba=o=>D.faceLandmark68Net.load(o),ga=o=>D.faceLandmark68TinyNet.load(o),ya=o=>D.faceRecognitionNet.load(o),va=o=>D.faceExpressionNet.load(o),Ta=o=>D.ageGenderNet.load(o),Fa=xn,wa=ln,Pa=hn;var yo=class extends ct{constructor(t,e,r){super();this.parentTask=t;this.input=e;this.extractedFaces=r}},Ne=class extends yo{async run(){let t=await this.parentTask,e=await ee(t,this.input,async r=>Promise.all(r.map(n=>D.faceExpressionNet.predictExpressions(n))),this.extractedFaces);return t.map((r,n)=>hr(r,e[n]))}withAgeAndGender(){return new Me(this,this.input)}},Ie=class extends yo{async run(){let t=await this.parentTask;if(!t)return;let e=await De(t,this.input,r=>D.faceExpressionNet.predictExpressions(r),this.extractedFaces);return hr(t,e)}withAgeAndGender(){return new Ce(this,this.input)}},ne=class extends Ne{withAgeAndGender(){return new re(this,this.input)}withFaceDescriptors(){return new jt(this,this.input)}},ae=class extends Ie{withAgeAndGender(){return new oe(this,this.input)}withFaceDescriptor(){return new Ht(this,this.input)}};var vo=class extends ct{constructor(t,e,r){super();this.parentTask=t;this.input=e;this.extractedFaces=r}},Me=class extends vo{async run(){let t=await this.parentTask,e=await ee(t,this.input,async r=>Promise.all(r.map(n=>D.ageGenderNet.predictAgeAndGender(n))),this.extractedFaces);return t.map((r,n)=>{let{age:a,gender:s,genderProbability:i}=e[n];return Tr(Fr(r,s,i),a)})}withFaceExpressions(){return new Ne(this,this.input)}},Ce=class extends vo{async run(){let t=await this.parentTask;if(!t)return;let{age:e,gender:r,genderProbability:n}=await De(t,this.input,a=>D.ageGenderNet.predictAgeAndGender(a),this.extractedFaces);return Tr(Fr(t,r,n),e)}withFaceExpressions(){return new Ie(this,this.input)}},re=class extends Me{withFaceExpressions(){return new ne(this,this.input)}withFaceDescriptors(){return new jt(this,this.input)}},oe=class extends Ce{withFaceExpressions(){return new ae(this,this.input)}withFaceDescriptor(){return new Ht(this,this.input)}};var _r=class extends ct{constructor(t,e){super();this.parentTask=t;this.input=e}},jt=class extends _r{async run(){let t=await this.parentTask;return(await ee(t,this.input,r=>Promise.all(r.map(n=>D.faceRecognitionNet.computeFaceDescriptor(n))),null,r=>r.landmarks.align(null,{useDlibAlignment:!0}))).map((r,n)=>vr(t[n],r))}withFaceExpressions(){return new ne(this,this.input)}withAgeAndGender(){return new re(this,this.input)}},Ht=class extends _r{async run(){let t=await this.parentTask;if(!t)return;let e=await De(t,this.input,r=>D.faceRecognitionNet.computeFaceDescriptor(r),null,r=>r.landmarks.align(null,{useDlibAlignment:!0}));return vr(t,e)}withFaceExpressions(){return new ae(this,this.input)}withAgeAndGender(){return new oe(this,this.input)}};var Dr=class extends ct{constructor(t,e,r){super();this.parentTask=t;this.input=e;this.useTinyLandmarkNet=r}get landmarkNet(){return this.useTinyLandmarkNet?D.faceLandmark68TinyNet:D.faceLandmark68Net}},Er=class extends Dr{async run(){let t=await this.parentTask,e=t.map(a=>a.detection),r=this.input instanceof Xe.Tensor?await ue(this.input,e):await de(this.input,e),n=await Promise.all(r.map(a=>this.landmarkNet.detectLandmarks(a)));return r.forEach(a=>a instanceof Xe.Tensor&&a.dispose()),t.map((a,s)=>ye(a,n[s]))}withFaceExpressions(){return new ne(this,this.input)}withAgeAndGender(){return new re(this,this.input)}withFaceDescriptors(){return new jt(this,this.input)}},Mr=class extends Dr{async run(){let t=await this.parentTask;if(!t)return;let{detection:e}=t,r=this.input instanceof Xe.Tensor?await ue(this.input,[e]):await de(this.input,[e]),n=await this.landmarkNet.detectLandmarks(r[0]);return r.forEach(a=>a instanceof Xe.Tensor&&a.dispose()),ye(t,n)}withFaceExpressions(){return new ae(this,this.input)}withAgeAndGender(){return new oe(this,this.input)}withFaceDescriptor(){return new Ht(this,this.input)}};var Cr=class extends ct{constructor(t,e=new at){super();this.input=t;this.options=e}},qe=class extends Cr{async run(){let{input:t,options:e}=this,r=e instanceof Pr?n=>D.tinyFaceDetector.locateFaces(n,e):e instanceof at?n=>D.ssdMobilenetv1.locateFaces(n,e):e instanceof yt?n=>D.tinyYolov2.locateFaces(n,e):null;if(!r)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return r(t)}runAndExtendWithFaceDetections(){return new Promise(async t=>{let e=await this.run();t(e.map(r=>Ut({},r)))})}withFaceLandmarks(t=!1){return new Er(this.runAndExtendWithFaceDetections(),this.input,t)}withFaceExpressions(){return new Ne(this.runAndExtendWithFaceDetections(),this.input)}withAgeAndGender(){return new Me(this.runAndExtendWithFaceDetections(),this.input)}},Nr=class extends Cr{async run(){let t=await new qe(this.input,this.options),e=t[0];return t.forEach(r=>{r.score>e.score&&(e=r)}),e}runAndExtendWithFaceDetection(){return new Promise(async t=>{let e=await this.run();t(e?Ut({},e):void 0)})}withFaceLandmarks(t=!1){return new Mr(this.runAndExtendWithFaceDetection(),this.input,t)}withFaceExpressions(){return new Ie(this.runAndExtendWithFaceDetection(),this.input)}withAgeAndGender(){return new Ce(this.runAndExtendWithFaceDetection(),this.input)}};function _a(o,t=new at){return new Nr(o,t)}function Ir(o,t=new at){return new qe(o,t)}async function bn(o,t){return Ir(o,new at(t?{minConfidence:t}:{})).withFaceLandmarks().withFaceDescriptors()}async function Da(o,t={}){return Ir(o,new yt(t)).withFaceLandmarks().withFaceDescriptors()}var Ea=bn;function To(o,t){if(o.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");let e=Array.from(o),r=Array.from(t);return Math.sqrt(e.map((n,a)=>n-r[a]).reduce((n,a)=>n+a**2,0))}var Lr=class{constructor(t,e=.6){this._distanceThreshold=e;let r=Array.isArray(t)?t:[t];if(!r.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");let n=1,a=()=>`person ${n++}`;this._labeledDescriptors=r.map(s=>{if(s instanceof wt)return s;if(s instanceof Float32Array)return new wt(a(),[s]);if(s.descriptor&&s.descriptor instanceof Float32Array)return new wt(a(),[s.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}get labeledDescriptors(){return this._labeledDescriptors}get distanceThreshold(){return this._distanceThreshold}computeMeanDistance(t,e){return e.map(r=>To(r,t)).reduce((r,n)=>r+n,0)/(e.length||1)}matchDescriptor(t){return this.labeledDescriptors.map(({descriptors:e,label:r})=>new Ae(r,this.computeMeanDistance(t,e))).reduce((e,r)=>e.distance<r.distance?e:r)}findBestMatch(t){let e=this.matchDescriptor(t);return e.distance<this.distanceThreshold?e:new Ae("unknown",e.distance)}toJSON(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(t=>t.toJSON())}}static fromJSON(t){let e=t.labeledDescriptors.map(r=>wt.fromJSON(r));return new Lr(e,t.distanceThreshold)}};function Ma(o){let t=new Ee;return t.extractWeights(o),t}function gn(o,t){let{width:e,height:r}=new j(t.width,t.height);if(e<=0||r<=0)throw new Error(`resizeResults - invalid dimensions: ${JSON.stringify({width:e,height:r})}`);if(Array.isArray(o))return o.map(n=>gn(n,{width:e,height:r}));if(Kt(o)){let n=o.detection.forSize(e,r),a=o.unshiftedLandmarks.forSize(n.box.width,n.box.height);return ye(Ut(o,n),a)}return xt(o)?Ut(o,o.detection.forSize(e,r)):o instanceof tt||o instanceof L?o.forSize(e,r):o}var Na=typeof process!="undefined",Ia=typeof navigator!="undefined"&&typeof navigator.userAgent!="undefined",La={faceapi:So,node:Na,browser:Ia};export{xr as AgeGenderNet,ce as BoundingBox,E as Box,ct as ComposableTask,jt as ComputeAllFaceDescriptorsTask,_r as ComputeFaceDescriptorsTaskBase,Ht as ComputeSingleFaceDescriptorTask,Er as DetectAllFaceLandmarksTask,qe as DetectAllFacesTask,Dr as DetectFaceLandmarksTaskBase,Cr as DetectFacesTaskBase,Mr as DetectSingleFaceLandmarksTask,Nr as DetectSingleFaceTask,j as Dimensions,no as FACE_EXPRESSION_LABELS,L as FaceDetection,en as FaceDetectionNet,lr as FaceExpressionNet,Bt as FaceExpressions,ve as FaceLandmark68Net,br as FaceLandmark68TinyNet,Yo as FaceLandmarkNet,tt as FaceLandmarks,wo as FaceLandmarks5,pe as FaceLandmarks68,Ae as FaceMatch,Lr as FaceMatcher,Fe as FaceRecognitionNet,Et as Gender,Se as LabeledBox,wt as LabeledFaceDescriptors,Pt as NetInput,$ as NeuralNetwork,It as ObjectDetection,T as Point,Po as PredictedBox,me as Rect,te as SsdMobilenetv1,at as SsdMobilenetv1Options,Ee as TinyFaceDetector,Pr as TinyFaceDetectorOptions,_e as TinyYolov2,yt as TinyYolov2Options,Ea as allFaces,bn as allFacesSsdMobilenetv1,Da as allFacesTinyYolov2,Kr as awaitMediaLoaded,Qr as bufferToImage,ua as computeFaceDescriptor,qt as createCanvas,Re as createCanvasFromMedia,aa as createFaceDetectionNet,Xn as createFaceRecognitionNet,tn as createSsdMobilenetv1,Ma as createTinyFaceDetector,ca as createTinyYolov2,Ir as detectAllFaces,hn as detectFaceLandmarks,da as detectFaceLandmarksTiny,Pa as detectLandmarks,_a as detectSingleFace,co as draw,M as env,To as euclideanDistance,Tr as extendWithAge,vr as extendWithFaceDescriptor,Ut as extendWithFaceDetection,hr as extendWithFaceExpressions,ye as extendWithFaceLandmarks,Fr as extendWithGender,ue as extractFaceTensors,de as extractFaces,Rn as fetchImage,ro as fetchJson,On as fetchNetWeights,Jt as fetchOrThrow,U as getContext2dOrThrow,Xt as getMediaDimensions,to as imageTensorToCanvas,eo as imageToSquare,Mn as inverseSigmoid,jr as iou,rr as isMediaElement,Be as isMediaLoaded,qn as isWithAge,xt as isWithFaceDetection,ao as isWithFaceExpressions,Kt as isWithFaceLandmarks,Jn as isWithGender,Ta as loadAgeGenderModel,Fa as loadFaceDetectionModel,va as loadFaceExpressionModel,ba as loadFaceLandmarkModel,ga as loadFaceLandmarkTinyModel,ya as loadFaceRecognitionModel,xn as loadSsdMobilenetv1Model,ha as loadTinyFaceDetectorModel,xa as loadTinyYolov2Model,oo as loadWeightMap,wa as locateFaces,$n as matchDimensions,Hr as minBbox,D as nets,Yr as nonMaxSuppression,pt as normalize,Gr as padToSquare,la as predictAgeAndGender,fa as recognizeFaceExpressions,gn as resizeResults,Vt as resolveInput,En as shuffleArray,ke as sigmoid,ln as ssdMobilenetv1,Ca as tf,ma as tinyFaceDetector,pa as tinyYolov2,I as toNetInput,Br as utils,ho as validateConfig,La as version};
//# sourceMappingURL=face-api.esm-nobundle.js.map
