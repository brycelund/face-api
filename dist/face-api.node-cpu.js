
  /*
  Face-API
  homepage: <https://github.com/vladmandic/face-api>
  author: <https://github.com/vladmandic>'
  */

var aa=Object.create,ur=Object.defineProperty,sa=Object.getPrototypeOf,ia=Object.prototype.hasOwnProperty,ca=Object.getOwnPropertyNames,ma=Object.getOwnPropertyDescriptor;var lr=r=>ur(r,"__esModule",{value:!0});var fr=(r,e)=>()=>(e||(e={exports:{}},r(e.exports,e)),e.exports),zt=(r,e)=>{for(var t in e)ur(r,t,{get:e[t],enumerable:!0})},pa=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ca(e))!ia.call(r,o)&&o!=="default"&&ur(r,o,{get:()=>e[o],enumerable:!(t=ma(e,o))||t.enumerable});return r},x=r=>pa(lr(ur(r!=null?aa(sa(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var T=fr(Kr=>{var ua=Object.create,Qr=Object.defineProperty,la=Object.getPrototypeOf,fa=Object.prototype.hasOwnProperty,da=Object.getOwnPropertyNames,ha=Object.getOwnPropertyDescriptor,Jo=r=>Qr(r,"__esModule",{value:!0}),Zo=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of da(e))!fa.call(r,o)&&o!=="default"&&Qr(r,o,{get:()=>e[o],enumerable:!(t=ha(e,o))||t.enumerable});return r},ba=r=>Zo(Jo(Qr(r!=null?ua(la(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);Jo(Kr);Zo(Kr,ba(require("@tensorflow/tfjs")))});var rn=fr((Fa,tn)=>{lr(Fa);zt(Fa,{isNodejs:()=>Pa});function Pa(){return typeof global=="object"&&!0&&typeof tn!="undefined"&&typeof process!="undefined"&&!!process.version}});var fn=fr(Ma=>{lr(Ma);zt(Ma,{FetchError:()=>$,Headers:()=>Z,Request:()=>Ee,Response:()=>oe,default:()=>$a});var re=x(require("stream")),vo=x(require("http")),Tr=x(require("url")),on=x(require("https")),Oe=x(require("zlib")),Ca=re.default.Readable,Pe=Symbol("buffer"),To=Symbol("type"),ot=class{constructor(){this[To]="";let e=arguments[0],t=arguments[1],o=[],n=0;if(e){let s=e,i=Number(s.length);for(let c=0;c<i;c++){let m=s[c],p;m instanceof Buffer?p=m:ArrayBuffer.isView(m)?p=Buffer.from(m.buffer,m.byteOffset,m.byteLength):m instanceof ArrayBuffer?p=Buffer.from(m):m instanceof ot?p=m[Pe]:p=Buffer.from(typeof m=="string"?m:String(m)),n+=p.length,o.push(p)}}this[Pe]=Buffer.concat(o);let a=t&&t.type!==void 0&&String(t.type).toLowerCase();a&&!/[^\u0020-\u007E]/.test(a)&&(this[To]=a)}get size(){return this[Pe].length}get type(){return this[To]}text(){return Promise.resolve(this[Pe].toString())}arrayBuffer(){let e=this[Pe],t=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);return Promise.resolve(t)}stream(){let e=new Ca;return e._read=function(){},e.push(this[Pe]),e.push(null),e}toString(){return"[object Blob]"}slice(){let e=this.size,t=arguments[0],o=arguments[1],n,a;t===void 0?n=0:t<0?n=Math.max(e+t,0):n=Math.min(t,e),o===void 0?a=e:o<0?a=Math.max(e+o,0):a=Math.min(o,e);let s=Math.max(a-n,0),c=this[Pe].slice(n,n+s),m=new ot([],{type:arguments[2]});return m[Pe]=c,m}};Object.defineProperties(ot.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});Object.defineProperty(ot.prototype,Symbol.toStringTag,{value:"Blob",writable:!1,enumerable:!1,configurable:!0});function $(r,e,t){Error.call(this,r),this.message=r,this.type=e,t&&(this.code=this.errno=t.code),Error.captureStackTrace(this,this.constructor)}$.prototype=Object.create(Error.prototype);$.prototype.constructor=$;$.prototype.name="FetchError";var wo;try{wo=require("encoding").convert}catch(r){}var _e=Symbol("Body internals"),nn=re.default.PassThrough;function B(r){var e=this,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=t.size;let n=o===void 0?0:o;var a=t.timeout;let s=a===void 0?0:a;r==null?r=null:an(r)?r=Buffer.from(r.toString()):Jt(r)||Buffer.isBuffer(r)||(Object.prototype.toString.call(r)==="[object ArrayBuffer]"?r=Buffer.from(r):ArrayBuffer.isView(r)?r=Buffer.from(r.buffer,r.byteOffset,r.byteLength):r instanceof re.default||(r=Buffer.from(String(r)))),this[_e]={body:r,disturbed:!1,error:null},this.size=n,this.timeout=s,r instanceof re.default&&r.on("error",function(i){let c=i.name==="AbortError"?i:new $(`Invalid response body while trying to fetch ${e.url}: ${i.message}`,"system",i);e[_e].error=c})}B.prototype={get body(){return this[_e].body},get bodyUsed(){return this[_e].disturbed},arrayBuffer(){return wt.call(this).then(function(r){return r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength)})},blob(){let r=this.headers&&this.headers.get("content-type")||"";return wt.call(this).then(function(e){return Object.assign(new ot([],{type:r.toLowerCase()}),{[Pe]:e})})},json(){var r=this;return wt.call(this).then(function(e){try{return JSON.parse(e.toString())}catch(t){return B.Promise.reject(new $(`invalid json response body at ${r.url} reason: ${t.message}`,"invalid-json"))}})},text(){return wt.call(this).then(function(r){return r.toString()})},buffer(){return wt.call(this)},textConverted(){var r=this;return wt.call(this).then(function(e){return Na(e,r.headers)})}};Object.defineProperties(B.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}});B.mixIn=function(r){for(let e of Object.getOwnPropertyNames(B.prototype))if(!(e in r)){let t=Object.getOwnPropertyDescriptor(B.prototype,e);Object.defineProperty(r,e,t)}};function wt(){var r=this;if(this[_e].disturbed)return B.Promise.reject(new TypeError(`body used already for: ${this.url}`));if(this[_e].disturbed=!0,this[_e].error)return B.Promise.reject(this[_e].error);let e=this.body;if(e===null)return B.Promise.resolve(Buffer.alloc(0));if(Jt(e)&&(e=e.stream()),Buffer.isBuffer(e))return B.Promise.resolve(e);if(!(e instanceof re.default))return B.Promise.resolve(Buffer.alloc(0));let t=[],o=0,n=!1;return new B.Promise(function(a,s){let i;r.timeout&&(i=setTimeout(function(){n=!0,s(new $(`Response timeout while trying to fetch ${r.url} (over ${r.timeout}ms)`,"body-timeout"))},r.timeout)),e.on("error",function(c){c.name==="AbortError"?(n=!0,s(c)):s(new $(`Invalid response body while trying to fetch ${r.url}: ${c.message}`,"system",c))}),e.on("data",function(c){if(!(n||c===null)){if(r.size&&o+c.length>r.size){n=!0,s(new $(`content size at ${r.url} over limit: ${r.size}`,"max-size"));return}o+=c.length,t.push(c)}}),e.on("end",function(){if(!n){clearTimeout(i);try{a(Buffer.concat(t,o))}catch(c){s(new $(`Could not create Buffer from response body for ${r.url}: ${c.message}`,"system",c))}}})})}function Na(r,e){if(typeof wo!="function")throw new Error("The package `encoding` must be installed to use the textConverted() function");let t=e.get("content-type"),o="utf-8",n,a;return t&&(n=/charset=([^;]*)/i.exec(t)),a=r.slice(0,1024).toString(),!n&&a&&(n=/<meta.+?charset=(['"])(.+?)\1/i.exec(a)),!n&&a&&(n=/<meta[\s]+?http-equiv=(['"])content-type\1[\s]+?content=(['"])(.+?)\2/i.exec(a),n||(n=/<meta[\s]+?content=(['"])(.+?)\1[\s]+?http-equiv=(['"])content-type\3/i.exec(a),n&&n.pop()),n&&(n=/charset=(.*)/i.exec(n.pop()))),!n&&a&&(n=/<\?xml.+?encoding=(['"])(.+?)\1/i.exec(a)),n&&(o=n.pop(),(o==="gb2312"||o==="gbk")&&(o="gb18030")),wo(r,"UTF-8",o).toString()}function an(r){return typeof r!="object"||typeof r.append!="function"||typeof r.delete!="function"||typeof r.get!="function"||typeof r.getAll!="function"||typeof r.has!="function"||typeof r.set!="function"?!1:r.constructor.name==="URLSearchParams"||Object.prototype.toString.call(r)==="[object URLSearchParams]"||typeof r.sort=="function"}function Jt(r){return typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&typeof r.constructor=="function"&&typeof r.constructor.name=="string"&&/^(Blob|File)$/.test(r.constructor.name)&&/^(Blob|File)$/.test(r[Symbol.toStringTag])}function sn(r){let e,t,o=r.body;if(r.bodyUsed)throw new Error("cannot clone body after it is used");return o instanceof re.default&&typeof o.getBoundary!="function"&&(e=new nn,t=new nn,o.pipe(e),o.pipe(t),r[_e].body=e,o=t),o}function cn(r){return r===null?null:typeof r=="string"?"text/plain;charset=UTF-8":an(r)?"application/x-www-form-urlencoded;charset=UTF-8":Jt(r)?r.type||null:Buffer.isBuffer(r)||Object.prototype.toString.call(r)==="[object ArrayBuffer]"||ArrayBuffer.isView(r)?null:typeof r.getBoundary=="function"?`multipart/form-data;boundary=${r.getBoundary()}`:r instanceof re.default?null:"text/plain;charset=UTF-8"}function mn(r){let e=r.body;return e===null?0:Jt(e)?e.size:Buffer.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"&&(e._lengthRetrievers&&e._lengthRetrievers.length==0||e.hasKnownLength&&e.hasKnownLength())?e.getLengthSync():null}function La(r,e){let t=e.body;t===null?r.end():Jt(t)?t.stream().pipe(r):Buffer.isBuffer(t)?(r.write(t),r.end()):t.pipe(r)}B.Promise=global.Promise;var pn=/[^\^_`a-zA-Z\-0-9!#$%&'*+.|~]/,Fo=/[^\t\x20-\x7e\x80-\xff]/;function Zt(r){if(r=`${r}`,pn.test(r)||r==="")throw new TypeError(`${r} is not a legal HTTP header name`)}function un(r){if(r=`${r}`,Fo.test(r))throw new TypeError(`${r} is not a legal HTTP header value`)}function Ft(r,e){e=e.toLowerCase();for(let t in r)if(t.toLowerCase()===e)return t}var k=Symbol("map"),Z=class{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0;if(this[k]=Object.create(null),e instanceof Z){let t=e.raw(),o=Object.keys(t);for(let n of o)for(let a of t[n])this.append(n,a);return}if(e!=null)if(typeof e=="object"){let t=e[Symbol.iterator];if(t!=null){if(typeof t!="function")throw new TypeError("Header pairs must be iterable");let o=[];for(let n of e){if(typeof n!="object"||typeof n[Symbol.iterator]!="function")throw new TypeError("Each header pair must be iterable");o.push(Array.from(n))}for(let n of o){if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");this.append(n[0],n[1])}}else for(let o of Object.keys(e)){let n=e[o];this.append(o,n)}}else throw new TypeError("Provided initializer must be an object")}get(e){e=`${e}`,Zt(e);let t=Ft(this[k],e);return t===void 0?null:this[k][t].join(", ")}forEach(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0,o=Po(this),n=0;for(;n<o.length;){var a=o[n];let s=a[0],i=a[1];e.call(t,i,s,this),o=Po(this),n++}}set(e,t){e=`${e}`,t=`${t}`,Zt(e),un(t);let o=Ft(this[k],e);this[k][o!==void 0?o:e]=[t]}append(e,t){e=`${e}`,t=`${t}`,Zt(e),un(t);let o=Ft(this[k],e);o!==void 0?this[k][o].push(t):this[k][e]=[t]}has(e){return e=`${e}`,Zt(e),Ft(this[k],e)!==void 0}delete(e){e=`${e}`,Zt(e);let t=Ft(this[k],e);t!==void 0&&delete this[k][t]}raw(){return this[k]}keys(){return _o(this,"key")}values(){return _o(this,"value")}[Symbol.iterator](){return _o(this,"key+value")}};Z.prototype.entries=Z.prototype[Symbol.iterator];Object.defineProperty(Z.prototype,Symbol.toStringTag,{value:"Headers",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(Z.prototype,{get:{enumerable:!0},forEach:{enumerable:!0},set:{enumerable:!0},append:{enumerable:!0},has:{enumerable:!0},delete:{enumerable:!0},keys:{enumerable:!0},values:{enumerable:!0},entries:{enumerable:!0}});function Po(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"key+value";return Object.keys(r[k]).sort().map(e==="key"?function(o){return o.toLowerCase()}:e==="value"?function(o){return r[k][o].join(", ")}:function(o){return[o.toLowerCase(),r[k][o].join(", ")]})}var Do=Symbol("internal");function _o(r,e){let t=Object.create(Eo);return t[Do]={target:r,kind:e,index:0},t}var Eo=Object.setPrototypeOf({next(){if(!this||Object.getPrototypeOf(this)!==Eo)throw new TypeError("Value of `this` is not a HeadersIterator");var r=this[Do];let e=r.target,t=r.kind,o=r.index,n=Po(e,t),a=n.length;return o>=a?{value:void 0,done:!0}:(this[Do].index=o+1,{value:n[o],done:!1})}},Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]())));Object.defineProperty(Eo,Symbol.toStringTag,{value:"HeadersIterator",writable:!1,enumerable:!1,configurable:!0});function Sa(r){let e=Object.assign({__proto__:null},r[k]),t=Ft(r[k],"Host");return t!==void 0&&(e[t]=e[t][0]),e}function ka(r){let e=new Z;for(let t of Object.keys(r))if(!pn.test(t))if(Array.isArray(r[t]))for(let o of r[t])Fo.test(o)||(e[k][t]===void 0?e[k][t]=[o]:e[k][t].push(o));else Fo.test(r[t])||(e[k][t]=[r[t]]);return e}var $e=Symbol("Response internals"),Ia=vo.default.STATUS_CODES,oe=class{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};B.call(this,e,t);let o=t.status||200,n=new Z(t.headers);if(e!=null&&!n.has("Content-Type")){let a=cn(e);a&&n.append("Content-Type",a)}this[$e]={url:t.url,status:o,statusText:t.statusText||Ia[o],headers:n,counter:t.counter}}get url(){return this[$e].url||""}get status(){return this[$e].status}get ok(){return this[$e].status>=200&&this[$e].status<300}get redirected(){return this[$e].counter>0}get statusText(){return this[$e].statusText}get headers(){return this[$e].headers}clone(){return new oe(sn(this),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected})}};B.mixIn(oe.prototype);Object.defineProperties(oe.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});Object.defineProperty(oe.prototype,Symbol.toStringTag,{value:"Response",writable:!1,enumerable:!1,configurable:!0});var De=Symbol("Request internals"),Mo=Tr.default.parse,Aa=Tr.default.format,Ba="destroy"in re.default.Readable.prototype;function wr(r){return typeof r=="object"&&typeof r[De]=="object"}function Wa(r){let e=r&&typeof r=="object"&&Object.getPrototypeOf(r);return!!(e&&e.constructor.name==="AbortSignal")}var Ee=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o;wr(e)?o=Mo(e.url):(e&&e.href?o=Mo(e.href):o=Mo(`${e}`),e={});let n=t.method||e.method||"GET";if(n=n.toUpperCase(),(t.body!=null||wr(e)&&e.body!==null)&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");let a=t.body!=null?t.body:wr(e)&&e.body!==null?sn(e):null;B.call(this,a,{timeout:t.timeout||e.timeout||0,size:t.size||e.size||0});let s=new Z(t.headers||e.headers||{});if(a!=null&&!s.has("Content-Type")){let c=cn(a);c&&s.append("Content-Type",c)}let i=wr(e)?e.signal:null;if("signal"in t&&(i=t.signal),i!=null&&!Wa(i))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[De]={method:n,redirect:t.redirect||e.redirect||"follow",headers:s,parsedURL:o,signal:i},this.follow=t.follow!==void 0?t.follow:e.follow!==void 0?e.follow:20,this.compress=t.compress!==void 0?t.compress:e.compress!==void 0?e.compress:!0,this.counter=t.counter||e.counter||0,this.agent=t.agent||e.agent}get method(){return this[De].method}get url(){return Aa(this[De].parsedURL)}get headers(){return this[De].headers}get redirect(){return this[De].redirect}get signal(){return this[De].signal}clone(){return new Ee(this)}};B.mixIn(Ee.prototype);Object.defineProperty(Ee.prototype,Symbol.toStringTag,{value:"Request",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(Ee.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}});function Ra(r){let e=r[De].parsedURL,t=new Z(r[De].headers);if(t.has("Accept")||t.set("Accept","*/*"),!e.protocol||!e.hostname)throw new TypeError("Only absolute URLs are supported");if(!/^https?:$/.test(e.protocol))throw new TypeError("Only HTTP(S) protocols are supported");if(r.signal&&r.body instanceof re.default.Readable&&!Ba)throw new Error("Cancellation of streamed requests with AbortSignal is not supported in node < 8");let o=null;if(r.body==null&&/^(POST|PUT)$/i.test(r.method)&&(o="0"),r.body!=null){let a=mn(r);typeof a=="number"&&(o=String(a))}o&&t.set("Content-Length",o),t.has("User-Agent")||t.set("User-Agent","node-fetch/1.0 (+https://github.com/bitinn/node-fetch)"),r.compress&&!t.has("Accept-Encoding")&&t.set("Accept-Encoding","gzip,deflate");let n=r.agent;return typeof n=="function"&&(n=n(e)),!t.has("Connection")&&!n&&t.set("Connection","close"),Object.assign({},e,{method:r.method,headers:Sa(t),agent:n})}function Kt(r){Error.call(this,r),this.type="aborted",this.message=r,Error.captureStackTrace(this,this.constructor)}Kt.prototype=Object.create(Error.prototype);Kt.prototype.constructor=Kt;Kt.prototype.name="AbortError";var ln=re.default.PassThrough,Oa=Tr.default.resolve;function je(r,e){if(!je.Promise)throw new Error("native promise missing, set fetch.Promise to your favorite alternative");return B.Promise=je.Promise,new je.Promise(function(t,o){let n=new Ee(r,e),a=Ra(n),s=(a.protocol==="https:"?on.default:vo.default).request,i=n.signal,c=null,m=function(){let F=new Kt("The user aborted a request.");o(F),n.body&&n.body instanceof re.default.Readable&&n.body.destroy(F),!(!c||!c.body)&&c.body.emit("error",F)};if(i&&i.aborted){m();return}let p=function(){m(),f()},u=s(a),l;i&&i.addEventListener("abort",p);function f(){u.abort(),i&&i.removeEventListener("abort",p),clearTimeout(l)}n.timeout&&u.once("socket",function(h){l=setTimeout(function(){o(new $(`network timeout at: ${n.url}`,"request-timeout")),f()},n.timeout)}),u.on("error",function(h){o(new $(`request to ${n.url} failed, reason: ${h.message}`,"system",h)),f()}),u.on("response",function(h){clearTimeout(l);let F=ka(h.headers);if(je.isRedirect(h.statusCode)){let L=F.get("Location"),I=L===null?null:Oa(n.url,L);switch(n.redirect){case"error":o(new $(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),f();return;case"manual":if(I!==null)try{F.set("Location",I)}catch(Q){o(Q)}break;case"follow":if(I===null)break;if(n.counter>=n.follow){o(new $(`maximum redirect reached at: ${n.url}`,"max-redirect")),f();return}let R={headers:new Z(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:n.body,signal:n.signal,timeout:n.timeout,size:n.size};if(h.statusCode!==303&&n.body&&mn(n)===null){o(new $("Cannot follow redirect with body being a readable stream","unsupported-redirect")),f();return}(h.statusCode===303||(h.statusCode===301||h.statusCode===302)&&n.method==="POST")&&(R.method="GET",R.body=void 0,R.headers.delete("content-length")),t(je(new Ee(I,R))),f();return}}h.once("end",function(){i&&i.removeEventListener("abort",p)});let b=h.pipe(new ln),g={url:n.url,status:h.statusCode,statusText:h.statusMessage,headers:F,size:n.size,timeout:n.timeout,counter:n.counter},v=F.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||v===null||h.statusCode===204||h.statusCode===304){c=new oe(b,g),t(c);return}let w={flush:Oe.default.Z_SYNC_FLUSH,finishFlush:Oe.default.Z_SYNC_FLUSH};if(v=="gzip"||v=="x-gzip"){b=b.pipe(Oe.default.createGunzip(w)),c=new oe(b,g),t(c);return}if(v=="deflate"||v=="x-deflate"){h.pipe(new ln).once("data",function(I){(I[0]&15)==8?b=b.pipe(Oe.default.createInflate()):b=b.pipe(Oe.default.createInflateRaw()),c=new oe(b,g),t(c)});return}if(v=="br"&&typeof Oe.default.createBrotliDecompress=="function"){b=b.pipe(Oe.default.createBrotliDecompress()),c=new oe(b,g),t(c);return}c=new oe(b,g),t(c)}),La(u,n)})}je.isRedirect=function(r){return r===301||r===302||r===303||r===307||r===308};je.Promise=global.Promise;var $a=je});var hn=fr((nt,dn)=>{var Qt=fn(),ja=Qt.default||Qt,Co=function(r,e){return/^\/\//.test(r)&&(r="https:"+r),ja.call(this,r,e)};dn.exports=nt=Co;nt.fetch=Co;nt.Headers=Qt.Headers;nt.Request=Qt.Request;nt.Response=Qt.Response;nt.default=Co});lr(exports);zt(exports,{AgeGenderNet:()=>Ar,BoundingBox:()=>gt,Box:()=>_,ComposableTask:()=>ce,ComputeAllFaceDescriptorsTask:()=>qe,ComputeFaceDescriptorsTaskBase:()=>Yr,ComputeSingleFaceDescriptorTask:()=>Xe,DetectAllFaceLandmarksTask:()=>Ur,DetectAllFacesTask:()=>pr,DetectFaceLandmarksTaskBase:()=>Gr,DetectFacesTaskBase:()=>qr,DetectSingleFaceLandmarksTask:()=>Vr,DetectSingleFaceTask:()=>Xr,Dimensions:()=>O,FACE_EXPRESSION_LABELS:()=>So,FaceDetection:()=>M,FaceDetectionNet:()=>Hn,FaceExpressionNet:()=>kr,FaceExpressions:()=>Ye,FaceLandmark68Net:()=>Lt,FaceLandmark68TinyNet:()=>Br,FaceLandmarkNet:()=>Nn,FaceLandmarks:()=>J,FaceLandmarks5:()=>Qo,FaceLandmarks68:()=>yt,FaceMatch:()=>Gt,FaceMatcher:()=>Zr,FaceRecognitionNet:()=>kt,Gender:()=>Ce,LabeledBox:()=>Ut,LabeledFaceDescriptors:()=>we,NetInput:()=>Fe,NeuralNetwork:()=>W,ObjectDetection:()=>Be,Point:()=>y,PredictedBox:()=>en,Rect:()=>xt,SsdMobilenetv1:()=>mt,SsdMobilenetv1Options:()=>ae,TinyFaceDetector:()=>Rt,TinyFaceDetectorOptions:()=>zr,TinyYolov2:()=>Bt,TinyYolov2Options:()=>ye,allFaces:()=>Ss,allFacesSsdMobilenetv1:()=>oa,allFacesTinyYolov2:()=>Ls,awaitMediaLoaded:()=>bo,bufferToImage:()=>go,computeFaceDescriptor:()=>gs,createCanvas:()=>rt,createCanvasFromMedia:()=>Xt,createFaceDetectionNet:()=>ps,createFaceRecognitionNet:()=>Qa,createSsdMobilenetv1:()=>jn,createTinyFaceDetector:()=>ks,createTinyYolov2:()=>fs,detectAllFaces:()=>Jr,detectFaceLandmarks:()=>ta,detectFaceLandmarksTiny:()=>bs,detectLandmarks:()=>Cs,detectSingleFace:()=>Ns,draw:()=>Bo,env:()=>D,euclideanDistance:()=>qo,extendWithAge:()=>$r,extendWithFaceDescriptor:()=>Or,extendWithFaceDetection:()=>Qe,extendWithFaceExpressions:()=>Ir,extendWithFaceLandmarks:()=>Nt,extendWithGender:()=>jr,extractFaceTensors:()=>Tt,extractFaces:()=>vt,fetchImage:()=>za,fetchJson:()=>No,fetchNetWeights:()=>Ya,fetchOrThrow:()=>at,getContext2dOrThrow:()=>Y,getMediaDimensions:()=>tt,imageTensorToCanvas:()=>xo,imageToSquare:()=>yo,inverseSigmoid:()=>ya,iou:()=>no,isMediaElement:()=>yr,isMediaLoaded:()=>qt,isWithAge:()=>es,isWithFaceDetection:()=>be,isWithFaceExpressions:()=>ko,isWithFaceLandmarks:()=>it,isWithGender:()=>ts,loadAgeGenderModel:()=>Ds,loadFaceDetectionModel:()=>Es,loadFaceExpressionModel:()=>_s,loadFaceLandmarkModel:()=>ws,loadFaceLandmarkTinyModel:()=>Fs,loadFaceRecognitionModel:()=>Ps,loadSsdMobilenetv1Model:()=>ra,loadTinyFaceDetectorModel:()=>vs,loadTinyYolov2Model:()=>Ts,loadWeightMap:()=>Lo,locateFaces:()=>Ms,matchDimensions:()=>Ga,minBbox:()=>ao,nets:()=>P,nonMaxSuppression:()=>so,normalize:()=>pe,padToSquare:()=>io,predictAgeAndGender:()=>ys,recognizeFaceExpressions:()=>xs,resizeResults:()=>na,resolveInput:()=>et,shuffleArray:()=>xa,sigmoid:()=>Yt,ssdMobilenetv1:()=>ea,tf:()=>Is,tinyFaceDetector:()=>ds,tinyYolov2:()=>hs,toNetInput:()=>E,utils:()=>eo,validateConfig:()=>Ho,version:()=>Ws});var Is=x(T());var Bo={};zt(Bo,{AnchorPosition:()=>ge,DrawBox:()=>gr,DrawBoxOptions:()=>ho,DrawFaceLandmarks:()=>Ao,DrawFaceLandmarksOptions:()=>Io,DrawTextField:()=>Re,DrawTextFieldOptions:()=>Vt,drawContour:()=>ve,drawDetections:()=>Ea,drawFaceExpressions:()=>Ua,drawFaceLandmarks:()=>Va});function ve(r,e,t=!1){if(r.beginPath(),e.slice(1).forEach(({x:o,y:n},a)=>{let s=e[a];r.moveTo(s.x,s.y),r.lineTo(o,n)}),t){let o=e[e.length-1],n=e[0];if(!o||!n)return;r.moveTo(o.x,o.y),r.lineTo(n.x,n.y)}r.stroke()}var eo={};zt(eo,{computeReshapedDimensions:()=>oo,getCenterPoint:()=>Ke,isDimensions:()=>hr,isEven:()=>dr,isFloat:()=>ro,isTensor:()=>Je,isTensor1D:()=>ga,isTensor2D:()=>to,isTensor3D:()=>Te,isTensor4D:()=>X,isValidNumber:()=>me,isValidProbablitiy:()=>bt,range:()=>de,round:()=>Ze});var Ko=x(T());var O=class{constructor(e,t){if(!me(e)||!me(t))throw new Error(`Dimensions.constructor - expected width and height to be valid numbers, instead have ${JSON.stringify({width:e,height:t})}`);this._width=e,this._height=t}get width(){return this._width}get height(){return this._height}reverse(){return new O(1/this.width,1/this.height)}};function Je(r,e){return r instanceof Ko.Tensor&&r.shape.length===e}function ga(r){return Je(r,1)}function to(r){return Je(r,2)}function Te(r){return Je(r,3)}function X(r){return Je(r,4)}function ro(r){return r%1!=0}function dr(r){return r%2==0}function Ze(r,e=2){let t=10**e;return Math.floor(r*t)/t}function hr(r){return r&&r.width&&r.height}function oo({width:r,height:e},t){let o=t/Math.max(e,r);return new O(Math.round(r*o),Math.round(e*o))}function Ke(r){return r.reduce((e,t)=>e.add(t),new y(0,0)).div(new y(r.length,r.length))}function de(r,e,t){return Array(r).fill(0).map((o,n)=>e+n*t)}function me(r){return!!r&&r!==Infinity&&r!==-Infinity&&!Number.isNaN(r)||r===0}function bt(r){return me(r)&&r>=0&&r<=1}var y=class{constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}add(e){return new y(this.x+e.x,this.y+e.y)}sub(e){return new y(this.x-e.x,this.y-e.y)}mul(e){return new y(this.x*e.x,this.y*e.y)}div(e){return new y(this.x/e.x,this.y/e.y)}abs(){return new y(Math.abs(this.x),Math.abs(this.y))}magnitude(){return Math.sqrt(this.x**2+this.y**2)}floor(){return new y(Math.floor(this.x),Math.floor(this.y))}};var _=class{static isRect(e){return!!e&&[e.x,e.y,e.width,e.height].every(me)}static assertIsValidBox(e,t,o=!1){if(!_.isRect(e))throw new Error(`${t} - invalid box: ${JSON.stringify(e)}, expected object with properties x, y, width, height`);if(!o&&(e.width<0||e.height<0))throw new Error(`${t} - width (${e.width}) and height (${e.height}) must be positive numbers`)}constructor(e,t=!0){let o=e||{},n=[o.left,o.top,o.right,o.bottom].every(me),a=[o.x,o.y,o.width,o.height].every(me);if(!a&&!n)throw new Error(`Box.constructor - expected box to be IBoundingBox | IRect, instead have ${JSON.stringify(o)}`);let[s,i,c,m]=a?[o.x,o.y,o.width,o.height]:[o.left,o.top,o.right-o.left,o.bottom-o.top];_.assertIsValidBox({x:s,y:i,width:c,height:m},"Box.constructor",t),this._x=s,this._y=i,this._width=c,this._height=m}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get area(){return this.width*this.height}get topLeft(){return new y(this.left,this.top)}get topRight(){return new y(this.right,this.top)}get bottomLeft(){return new y(this.left,this.bottom)}get bottomRight(){return new y(this.right,this.bottom)}round(){let[e,t,o,n]=[this.x,this.y,this.width,this.height].map(a=>Math.round(a));return new _({x:e,y:t,width:o,height:n})}floor(){let[e,t,o,n]=[this.x,this.y,this.width,this.height].map(a=>Math.floor(a));return new _({x:e,y:t,width:o,height:n})}toSquare(){let{x:e,y:t,width:o,height:n}=this,a=Math.abs(o-n);return o<n&&(e-=a/2,o+=a),n<o&&(t-=a/2,n+=a),new _({x:e,y:t,width:o,height:n})}rescale(e){let t=hr(e)?e.width:e,o=hr(e)?e.height:e;return new _({x:this.x*t,y:this.y*o,width:this.width*t,height:this.height*o})}pad(e,t){let[o,n,a,s]=[this.x-e/2,this.y-t/2,this.width+e,this.height+t];return new _({x:o,y:n,width:a,height:s})}clipAtImageBorders(e,t){let{x:o,y:n,right:a,bottom:s}=this,i=Math.max(o,0),c=Math.max(n,0),m=a-i,p=s-c,u=Math.min(m,e-i),l=Math.min(p,t-c);return new _({x:i,y:c,width:u,height:l}).floor()}shift(e,t){let{width:o,height:n}=this,a=this.x+e,s=this.y+t;return new _({x:a,y:s,width:o,height:n})}padAtBorders(e,t){let o=this.width+1,n=this.height+1,a=1,s=1,i=o,c=n,m=this.left,p=this.top,u=this.right,l=this.bottom;return u>t&&(i=-u+t+o,u=t),l>e&&(c=-l+e+n,l=e),m<1&&(c=2-m,m=1),p<1&&(c=2-p,p=1),{dy:s,edy:c,dx:a,edx:i,y:p,ey:l,x:m,ex:u,w:o,h:n}}calibrate(e){return new _({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()}};var gt=class extends _{constructor(e,t,o,n,a=!1){super({left:e,top:t,right:o,bottom:n},a)}};var Be=class{constructor(e,t,o,n,a){this._imageDims=new O(a.width,a.height),this._score=e,this._classScore=t,this._className=o,this._box=new _(n).rescale(this._imageDims)}get score(){return this._score}get classScore(){return this._classScore}get className(){return this._className}get box(){return this._box}get imageDims(){return this._imageDims}get imageWidth(){return this.imageDims.width}get imageHeight(){return this.imageDims.height}get relativeBox(){return new _(this._box).rescale(this.imageDims.reverse())}forSize(e,t){return new Be(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:t})}};var M=class extends Be{constructor(e,t,o){super(e,e,"",t,o)}forSize(e,t){let{score:o,relativeBox:n,imageDims:a}=super.forSize(e,t);return new M(o,n,a)}};function no(r,e,t=!0){let o=Math.max(0,Math.min(r.right,e.right)-Math.max(r.left,e.left)),n=Math.max(0,Math.min(r.bottom,e.bottom)-Math.max(r.top,e.top)),a=o*n;return t?a/(r.area+e.area-a):a/Math.min(r.area,e.area)}function ao(r){let e=r.map(i=>i.x),t=r.map(i=>i.y),o=e.reduce((i,c)=>c<i?c:i,Infinity),n=t.reduce((i,c)=>c<i?c:i,Infinity),a=e.reduce((i,c)=>i<c?c:i,0),s=t.reduce((i,c)=>i<c?c:i,0);return new gt(o,n,a,s)}function so(r,e,t,o=!0){let n=e.map((s,i)=>({score:s,boxIndex:i})).sort((s,i)=>s.score-i.score).map(s=>s.boxIndex),a=[];for(;n.length>0;){let s=n.pop();a.push(s);let i=n,c=[];for(let m=0;m<i.length;m++){let p=i[m],u=r[s],l=r[p];c.push(no(u,l,o))}n=n.filter((m,p)=>c[p]<=t)}return a}var he=x(T());function pe(r,e){return he.tidy(()=>{let[t,o,n]=e,a=he.fill([...r.shape.slice(0,3),1],t,"float32"),s=he.fill([...r.shape.slice(0,3),1],o,"float32"),i=he.fill([...r.shape.slice(0,3),1],n,"float32"),c=he.concat([a,s,i],3);return he.sub(r,c)})}var We=x(T());function io(r,e=!1){return We.tidy(()=>{let[t,o]=r.shape.slice(1);if(t===o)return r;let n=Math.abs(t-o),a=Math.round(n*(e?.5:1)),s=t>o?2:1,i=l=>{let f=r.shape.slice();return f[s]=l,We.fill(f,0,"float32")},c=i(a),m=n-c.shape[s],u=[e&&m?i(m):null,r,c].filter(l=>!!l).map(l=>We.cast(l,"float32"));return We.concat(u,s)})}function xa(r){let e=r.slice();for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[o],e[o]=n}return e}function Yt(r){return 1/(1+Math.exp(-r))}function ya(r){return Math.log(r/(1-r))}var xt=class extends _{constructor(e,t,o,n,a=!1){super({x:e,y:t,width:o,height:n},a)}};var va=.5,Ta=.43,wa=.45,J=class{constructor(e,t,o=new y(0,0)){let{width:n,height:a}=t;this._imgDims=new O(n,a),this._shift=o,this._positions=e.map(s=>s.mul(new y(n,a)).add(o))}get shift(){return new y(this._shift.x,this._shift.y)}get imageWidth(){return this._imgDims.width}get imageHeight(){return this._imgDims.height}get positions(){return this._positions}get relativePositions(){return this._positions.map(e=>e.sub(this._shift).div(new y(this.imageWidth,this.imageHeight)))}forSize(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})}shiftBy(e,t){return new this.constructor(this.relativePositions,this._imgDims,new y(e,t))}shiftByPoint(e){return this.shiftBy(e.x,e.y)}align(e,t={}){if(e){let a=e instanceof M?e.box.floor():new _(e);return this.shiftBy(a.x,a.y).align(null,t)}let{useDlibAlignment:o,minBoxPadding:n}={useDlibAlignment:!1,minBoxPadding:.2,...t};return o?this.alignDlib():this.alignMinBbox(n)}alignDlib(){let e=this.getRefPointsForAlignment(),[t,o,n]=e,a=u=>n.sub(u).magnitude(),s=(a(t)+a(o))/2,i=Math.floor(s/wa),c=Ke(e),m=Math.floor(Math.max(0,c.x-va*i)),p=Math.floor(Math.max(0,c.y-Ta*i));return new xt(m,p,Math.min(i,this.imageWidth+m),Math.min(i,this.imageHeight+p))}alignMinBbox(e){let t=ao(this.positions);return t.pad(t.width*e,t.height*e)}getRefPointsForAlignment(){throw new Error("getRefPointsForAlignment not implemented by base class")}};var Qo=class extends J{getRefPointsForAlignment(){let e=this.positions;return[e[0],e[1],Ke([e[3],e[4]])]}};var yt=class extends J{getJawOutline(){return this.positions.slice(0,17)}getLeftEyeBrow(){return this.positions.slice(17,22)}getRightEyeBrow(){return this.positions.slice(22,27)}getNose(){return this.positions.slice(27,36)}getLeftEye(){return this.positions.slice(36,42)}getRightEye(){return this.positions.slice(42,48)}getMouth(){return this.positions.slice(48,68)}getRefPointsForAlignment(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(Ke)}};var Gt=class{constructor(e,t){this._label=e,this._distance=t}get label(){return this._label}get distance(){return this._distance}toString(e=!0){return`${this.label}${e?` (${Ze(this.distance)})`:""}`}};var Ut=class extends _{static assertIsValidLabeledBox(e,t){if(_.assertIsValidBox(e,t),!me(e.label))throw new Error(`${t} - expected property label (${e.label}) to be a number`)}constructor(e,t){super(e);this._label=t}get label(){return this._label}};var we=class{constructor(e,t){if(typeof e!="string")throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(t)||t.some(o=>!(o instanceof Float32Array)))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e,this._descriptors=t}get label(){return this._label}get descriptors(){return this._descriptors}toJSON(){return{label:this.label,descriptors:this.descriptors.map(e=>Array.from(e))}}static fromJSON(e){let t=e.descriptors.map(o=>new Float32Array(o));return new we(e.label,t)}};var en=class extends Ut{static assertIsValidPredictedBox(e,t){if(Ut.assertIsValidLabeledBox(e,t),!bt(e.score)||!bt(e.classScore))throw new Error(`${t} - expected properties score (${e.score}) and (${e.classScore}) to be a number between [0, 1]`)}constructor(e,t,o,n){super(e,t);this._score=o,this._classScore=n}get score(){return this._score}get classScore(){return this._classScore}};function be(r){return r.detection instanceof M}function Qe(r,e){return{...r,...{detection:e}}}function co(){let r=window.fetch;if(!r)throw new Error("fetch - missing fetch implementation for browser environment");return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:()=>document.createElement("canvas"),createImageElement:()=>document.createElement("img"),fetch:r,readFile:()=>{throw new Error("readFile - filesystem not available for browser environment")}}}function br(r){let e="";if(!r)try{r=require("fs")}catch(o){e=o.toString()}return{readFile:r?o=>new Promise((n,a)=>{r.readFile(o,(s,i)=>s?a(s):n(i))}):()=>{throw new Error(`readFile - failed to require fs in nodejs environment with error: ${e}`)}}}function mo(){let r=global.Canvas||global.HTMLCanvasElement,e=global.Image||global.HTMLImageElement,t=()=>{if(r)return new r;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},o=()=>{if(e)return new e;throw new Error("createImageElement - missing Image implementation for nodejs environment")},n=global.fetch,a=br();return{Canvas:r||class{},CanvasRenderingContext2D:global.CanvasRenderingContext2D||class{},Image:e||class{},ImageData:global.ImageData||class{},Video:global.HTMLVideoElement||class{},createCanvasElement:t,createImageElement:o,fetch:n,...a}}function po(){return typeof window=="object"&&typeof document!="undefined"&&typeof HTMLImageElement!="undefined"&&typeof HTMLCanvasElement!="undefined"&&typeof HTMLVideoElement!="undefined"&&typeof ImageData!="undefined"&&typeof CanvasRenderingContext2D!="undefined"}var uo=x(rn()),A;function _a(){if(!A)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return A}function lo(r){A=r}function fo(){return po()?lo(co()):(0,uo.isNodejs)()?lo(mo()):null}function Da(r){if(A||fo(),!A)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");let{Canvas:e=A.Canvas,Image:t=A.Image}=r;A.Canvas=e,A.Image=t,A.createCanvasElement=r.createCanvasElement||(()=>new e),A.createImageElement=r.createImageElement||(()=>new t),A.ImageData=r.ImageData||A.ImageData,A.Video=r.Video||A.Video,A.fetch=r.fetch||A.fetch,A.readFile=r.readFile||A.readFile}var D={getEnv:_a,setEnv:lo,initialize:fo,createBrowserEnv:co,createFileSystem:br,createNodejsEnv:mo,monkeyPatch:Da,isBrowser:po,isNodejs:uo.isNodejs};fo();function et(r){return!D.isNodejs()&&typeof r=="string"?document.getElementById(r):r}function Y(r){let{Canvas:e,CanvasRenderingContext2D:t}=D.getEnv();if(r instanceof t)return r;let o=et(r);if(!(o instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");let n=o.getContext("2d");if(!n)throw new Error("resolveContext2d - canvas 2d context is null");return n}var ge;(function(r){r.TOP_LEFT="TOP_LEFT",r.TOP_RIGHT="TOP_RIGHT",r.BOTTOM_LEFT="BOTTOM_LEFT",r.BOTTOM_RIGHT="BOTTOM_RIGHT"})(ge||(ge={}));var Vt=class{constructor(e={}){let{anchorPosition:t,backgroundColor:o,fontColor:n,fontSize:a,fontStyle:s,padding:i}=e;this.anchorPosition=t||ge.TOP_LEFT,this.backgroundColor=o||"rgba(0, 0, 0, 0.5)",this.fontColor=n||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=s||"Georgia",this.padding=i||4}},Re=class{constructor(e,t,o={}){this.text=typeof e=="string"?[e]:e instanceof Re?e.text:e,this.anchor=t,this.options=new Vt(o)}measureWidth(e){let{padding:t}=this.options;return this.text.map(o=>e.measureText(o).width).reduce((o,n)=>o<n?n:o,0)+2*t}measureHeight(){let{fontSize:e,padding:t}=this.options;return this.text.length*e+2*t}getUpperLeft(e,t){let{anchorPosition:o}=this.options,n=o===ge.BOTTOM_RIGHT||o===ge.TOP_RIGHT,a=o===ge.BOTTOM_LEFT||o===ge.BOTTOM_RIGHT,s=this.measureWidth(e),i=this.measureHeight(),c=n?this.anchor.x-s:this.anchor.x,m=a?this.anchor.y-i:this.anchor.y;if(t){let{width:p,height:u}=t,l=Math.max(Math.min(c,p-s),0),f=Math.max(Math.min(m,u-i),0);return{x:l,y:f}}return{x:c,y:m}}draw(e){let t=et(e),o=Y(t),{backgroundColor:n,fontColor:a,fontSize:s,fontStyle:i,padding:c}=this.options;o.font=`${s}px ${i}`;let m=this.measureWidth(o),p=this.measureHeight();o.fillStyle=n;let u=this.getUpperLeft(o,t);o.fillRect(u.x,u.y,m,p),o.fillStyle=a,this.text.forEach((l,f)=>{let h=c+u.x,F=c+u.y+(f+1)*s;o.fillText(l,h,F)})}};var ho=class{constructor(e={}){let{boxColor:t,lineWidth:o,label:n,drawLabelOptions:a}=e;this.boxColor=t||"rgba(0, 0, 255, 1)",this.lineWidth=o||2,this.label=n;let s={anchorPosition:ge.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new Vt({...s,...a})}},gr=class{constructor(e,t={}){this.box=new _(e),this.options=new ho(t)}draw(e){let t=Y(e),{boxColor:o,lineWidth:n}=this.options,{x:a,y:s,width:i,height:c}=this.box;t.strokeStyle=o,t.lineWidth=n,t.strokeRect(a,s,i,c);let{label:m}=this.options;m&&new Re([m],{x:a-n/2,y:s},this.options.drawLabelOptions).draw(e)}};function Ea(r,e){(Array.isArray(e)?e:[e]).forEach(o=>{let n=o instanceof M?o.score:be(o)?o.detection.score:void 0,a=o instanceof M?o.box:be(o)?o.detection.box:new _(o),s=n?`${Ze(n)}`:void 0;new gr(a,{label:s}).draw(r)})}var Ct=x(T());function qt(r){let{Image:e,Video:t}=D.getEnv();return r instanceof e&&r.complete||r instanceof t&&r.readyState>=3}function bo(r){return new Promise((e,t)=>{if(r instanceof D.getEnv().Canvas||qt(r))return e(null);function o(a){!a.currentTarget||(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",o),t(a))}function n(a){!a.currentTarget||(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",o),e(a))}r.addEventListener("load",n),r.addEventListener("error",o)})}function go(r){return new Promise((e,t)=>{r instanceof Blob||t(new Error("bufferToImage - expected buf to be of type: Blob"));let o=new FileReader;o.onload=()=>{typeof o.result!="string"&&t(new Error("bufferToImage - expected reader.result to be a string, in onload"));let n=D.getEnv().createImageElement();n.onload=()=>e(n),n.onerror=t,n.src=o.result},o.onerror=t,o.readAsDataURL(r)})}function tt(r){let{Image:e,Video:t}=D.getEnv();return r instanceof e?new O(r.naturalWidth,r.naturalHeight):r instanceof t?new O(r.videoWidth,r.videoHeight):new O(r.width,r.height)}function rt({width:r,height:e}){let{createCanvasElement:t}=D.getEnv(),o=t();return o.width=r,o.height=e,o}function Xt(r,e){let{ImageData:t}=D.getEnv();if(!(r instanceof t)&&!qt(r))throw new Error("createCanvasFromMedia - media has not finished loading yet");let{width:o,height:n}=e||tt(r),a=rt({width:o,height:n});return r instanceof t?Y(a).putImageData(r,0,0):Y(a).drawImage(r,0,0,o,n),a}var xr=x(T());async function xo(r,e){let t=e||D.getEnv().createCanvasElement(),[o,n,a]=r.shape.slice(X(r)?1:0),s=xr.tidy(()=>r.as3D(o,n,a).toInt());return await xr.browser.toPixels(s,t),s.dispose(),t}function yr(r){let{Image:e,Canvas:t,Video:o}=D.getEnv();return r instanceof e||r instanceof t||r instanceof o}var te=x(T());function yo(r,e,t=!1){let{Image:o,Canvas:n}=D.getEnv();if(!(r instanceof o||r instanceof n))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");if(e<=0)return rt({width:1,height:1});let a=tt(r),s=e/Math.max(a.height,a.width),i=s*a.width,c=s*a.height,m=rt({width:e,height:e}),p=r instanceof n?r:Xt(r),u=Math.abs(i-c)/2,l=t&&i<c?u:0,f=t&&c<i?u:0;return p.width>0&&p.height>0&&Y(m).drawImage(p,l,f,i,c),m}var Fe=class{constructor(e,t=!1){this._imageTensors=[];this._canvases=[];this._treatAsBatchInput=!1;this._inputDimensions=[];if(!Array.isArray(e))throw new Error(`NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have ${e}`);this._treatAsBatchInput=t,this._batchSize=e.length,e.forEach((o,n)=>{if(Te(o)){this._imageTensors[n]=o,this._inputDimensions[n]=o.shape;return}if(X(o)){let s=o.shape[0];if(s!==1)throw new Error(`NetInput - tf.Tensor4D with batchSize ${s} passed, but not supported in input array`);this._imageTensors[n]=o,this._inputDimensions[n]=o.shape.slice(1);return}let a=o instanceof D.getEnv().Canvas?o:Xt(o);this._canvases[n]=a,this._inputDimensions[n]=[a.height,a.width,3]})}get imageTensors(){return this._imageTensors}get canvases(){return this._canvases}get isBatchInput(){return this.batchSize>1||this._treatAsBatchInput}get batchSize(){return this._batchSize}get inputDimensions(){return this._inputDimensions}get inputSize(){return this._inputSize}get reshapedInputDimensions(){return de(this.batchSize,0,1).map((e,t)=>this.getReshapedInputDimensions(t))}getInput(e){return this.canvases[e]||this.imageTensors[e]}getInputDimensions(e){return this._inputDimensions[e]}getInputHeight(e){return this._inputDimensions[e][0]}getInputWidth(e){return this._inputDimensions[e][1]}getReshapedInputDimensions(e){if(typeof this.inputSize!="number")throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");let t=this.getInputWidth(e),o=this.getInputHeight(e);return oo({width:t,height:o},this.inputSize)}toBatchTensor(e,t=!0){return this._inputSize=e,te.tidy(()=>{let o=de(this.batchSize,0,1).map(a=>{let s=this.getInput(a);if(s instanceof te.Tensor){let i=X(s)?s:s.expandDims();return i=io(i,t),(i.shape[1]!==e||i.shape[2]!==e)&&(i=te.image.resizeBilinear(i,[e,e])),i.as3D(e,e,3)}if(s instanceof D.getEnv().Canvas)return te.browser.fromPixels(yo(s,e,t));throw new Error(`toBatchTensor - at batchIdx ${a}, expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have ${s}`)});return te.stack(o.map(a=>te.cast(a,"float32"))).as4D(this.batchSize,e,e,3)})}};async function E(r){if(r instanceof Fe)return r;let e=Array.isArray(r)?r:[r];if(!e.length)throw new Error("toNetInput - empty array passed as input");let t=n=>Array.isArray(r)?` at input index ${n}:`:"",o=e.map(et);return o.forEach((n,a)=>{if(!yr(n)&&!Te(n)&&!X(n))throw typeof e[a]=="string"?new Error(`toNetInput -${t(a)} string passed, but could not resolve HTMLElement for element id ${e[a]}`):new Error(`toNetInput -${t(a)} expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id`);if(X(n)){let s=n.shape[0];if(s!==1)throw new Error(`toNetInput -${t(a)} tf.Tensor4D with batchSize ${s} passed, but not supported in input array`)}}),await Promise.all(o.map(n=>yr(n)&&bo(n))),new Fe(o,Array.isArray(r))}async function vt(r,e){let{Canvas:t}=D.getEnv(),o=r;if(!(r instanceof t)){let s=await E(r);if(s.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");let i=s.getInput(0);o=i instanceof t?i:await xo(i)}let n=Y(o);return e.map(s=>s instanceof M?s.forSize(o.width,o.height).box.floor():s).map(s=>s.clipAtImageBorders(o.width,o.height)).map(({x:s,y:i,width:c,height:m})=>{let p=rt({width:c,height:m});return c>0&&m>0&&Y(p).putImageData(n.getImageData(s,i,c,m),0,0),p})}var vr=x(T());async function Tt(r,e){if(!Te(r)&&!X(r))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(X(r)&&r.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return vr.tidy(()=>{let[t,o,n]=r.shape.slice(X(r)?1:0);return e.map(i=>i instanceof M?i.forSize(o,t).box:i).map(i=>i.clipAtImageBorders(o,t)).map(({x:i,y:c,width:m,height:p})=>vr.slice3d(r.as3D(t,o,n),[c,i,0],[p,m,n]))})}var Ha=hn();async function at(r,e){let t=await Ha(r,e);if(!(t.status<400))throw new Error(`failed to fetch: (${t.status}) ${t.statusText}, from url: ${t.url}`);return t}async function za(r){let e=await at(r),t=await e.blob();if(!t.type.startsWith("image/"))throw new Error(`fetchImage - expected blob type to be of type image/*, instead have: ${t.type}, for url: ${e.url}`);return go(t)}async function No(r){return(await at(r)).json()}async function Ya(r){return new Float32Array(await(await at(r)).arrayBuffer())}var bn=x(T());function Fr(r,e){let t=`${e}-weights_manifest.json`;if(!r)return{modelBaseUri:"",manifestUri:t};if(r==="/")return{modelBaseUri:"/",manifestUri:`/${t}`};let o=r.startsWith("http://")?"http://":r.startsWith("https://")?"https://":"";r=r.replace(o,"");let n=r.split("/").filter(i=>i),a=r.endsWith(".json")?n[n.length-1]:t,s=o+(r.endsWith(".json")?n.slice(0,n.length-1):n).join("/");return s=r.startsWith("/")?`/${s}`:s,{modelBaseUri:s,manifestUri:s==="/"?`/${a}`:`${s}/${a}`}}async function Lo(r,e){let{manifestUri:t,modelBaseUri:o}=Fr(r,e),n=await No(t);return bn.io.loadWeights(n,o)}function Ga(r,e,t=!1){let{width:o,height:n}=t?tt(e):e;return r.width=o,r.height=n,{width:o,height:n}}var ze=x(T());var Me=x(T());var W=class{constructor(e){this._params=void 0;this._paramMappings=[];this._name=e}get params(){return this._params}get paramMappings(){return this._paramMappings}get isLoaded(){return!!this.params}getParamFromPath(e){let{obj:t,objProp:o}=this.traversePropertyPath(e);return t[o]}reassignParamFromPath(e,t){let{obj:o,objProp:n}=this.traversePropertyPath(e);o[n].dispose(),o[n]=t}getParamList(){return this._paramMappings.map(({paramPath:e})=>({path:e,tensor:this.getParamFromPath(e)}))}getTrainableParams(){return this.getParamList().filter(e=>e.tensor instanceof Me.Variable)}getFrozenParams(){return this.getParamList().filter(e=>!(e.tensor instanceof Me.Variable))}variable(){this.getFrozenParams().forEach(({path:e,tensor:t})=>{this.reassignParamFromPath(e,t.variable())})}freeze(){this.getTrainableParams().forEach(({path:e,tensor:t})=>{let o=Me.tensor(t.dataSync());t.dispose(),this.reassignParamFromPath(e,o)})}dispose(e=!0){this.getParamList().forEach(t=>{if(e&&t.tensor.isDisposed)throw new Error(`param tensor has already been disposed for path ${t.path}`);t.tensor.dispose()}),this._params=void 0}serializeParams(){return new Float32Array(this.getParamList().map(({tensor:e})=>Array.from(e.dataSync())).reduce((e,t)=>e.concat(t)))}async load(e){if(e instanceof Float32Array){this.extractWeights(e);return}await this.loadFromUri(e)}async loadFromUri(e){if(e&&typeof e!="string")throw new Error(`${this._name}.loadFromUri - expected model uri`);let t=await Lo(e,this.getDefaultModelName());this.loadFromWeightMap(t)}async loadFromDisk(e){if(e&&typeof e!="string")throw new Error(`${this._name}.loadFromDisk - expected model file path`);let{readFile:t}=D.getEnv(),{manifestUri:o,modelBaseUri:n}=Fr(e,this.getDefaultModelName()),a=m=>Promise.all(m.map(p=>t(p).then(u=>u.buffer))),s=Me.io.weightsLoaderFactory(a),i=JSON.parse((await t(o)).toString()),c=await s(i,n);this.loadFromWeightMap(c)}loadFromWeightMap(e){let{paramMappings:t,params:o}=this.extractParamsFromWeightMap(e);this._paramMappings=t,this._params=o}extractWeights(e){let{paramMappings:t,params:o}=this.extractParams(e);this._paramMappings=t,this._params=o}traversePropertyPath(e){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");let t=e.split("/").reduce((a,s)=>{if(!a.nextObj.hasOwnProperty(s))throw new Error(`traversePropertyPath - object does not have property ${s}, for path ${e}`);return{obj:a.nextObj,objProp:s,nextObj:a.nextObj[s]}},{nextObj:this.params}),{obj:o,objProp:n}=t;if(!o||!n||!(o[n]instanceof Me.Tensor))throw new Error(`traversePropertyPath - parameter is not a tensor, for path ${e}`);return{obj:o,objProp:n}}};var C=x(T());var Pt=x(T());function G(r,e,t){return Pt.tidy(()=>{let o=Pt.separableConv2d(r,e.depthwise_filter,e.pointwise_filter,t,"same");return o=Pt.add(o,e.bias),o})}function Pr(r,e,t=!1){return C.tidy(()=>{let o=C.relu(t?C.add(C.conv2d(r,e.conv0.filters,[2,2],"same"),e.conv0.bias):G(r,e.conv0,[2,2])),n=G(o,e.conv1,[1,1]),a=C.relu(C.add(o,n)),s=G(a,e.conv2,[1,1]);return C.relu(C.add(o,C.add(n,s)))})}function er(r,e,t=!1,o=!0){return C.tidy(()=>{let n=C.relu(t?C.add(C.conv2d(r,e.conv0.filters,o?[2,2]:[1,1],"same"),e.conv0.bias):G(r,e.conv0,o?[2,2]:[1,1])),a=G(n,e.conv1,[1,1]),s=C.relu(C.add(n,a)),i=G(s,e.conv2,[1,1]),c=C.relu(C.add(n,C.add(a,i))),m=G(c,e.conv3,[1,1]);return C.relu(C.add(n,C.add(a,C.add(i,m))))})}var He=x(T());function st(r,e,t="same",o=!1){return He.tidy(()=>{let n=He.add(He.conv2d(r,e.filters,[1,1],t),e.bias);return o?He.relu(n):n})}function j(r,e){Object.keys(r).forEach(t=>{e.some(o=>o.originalPath===t)||r[t].dispose()})}var _r=x(T());function _t(r,e){return(t,o,n,a)=>{let s=_r.tensor4d(r(t*o*n*n),[n,n,t,o]),i=_r.tensor1d(r(o));return e.push({paramPath:`${a}/filters`},{paramPath:`${a}/bias`}),{filters:s,bias:i}}}var Dr=x(T());function Er(r,e){return(t,o,n)=>{let a=Dr.tensor2d(r(t*o),[t,o]),s=Dr.tensor1d(r(o));return e.push({paramPath:`${n}/weights`},{paramPath:`${n}/bias`}),{weights:a,bias:s}}}var tr=x(T());var Mr=class{constructor(e,t,o){this.depthwise_filter=e;this.pointwise_filter=t;this.bias=o}};function Dt(r,e){return(t,o,n)=>{let a=tr.tensor4d(r(3*3*t),[3,3,t,1]),s=tr.tensor4d(r(t*o),[1,1,t,o]),i=tr.tensor1d(r(o));return e.push({paramPath:`${n}/depthwise_filter`},{paramPath:`${n}/pointwise_filter`},{paramPath:`${n}/bias`}),new Mr(a,s,i)}}function Et(r){return e=>{let t=r(`${e}/depthwise_filter`,4),o=r(`${e}/pointwise_filter`,4),n=r(`${e}/bias`,1);return new Mr(t,o,n)}}function U(r,e){return(t,o,n)=>{let a=r[t];if(!Je(a,o))throw new Error(`expected weightMap[${t}] to be a Tensor${o}D, instead have ${a}`);return e.push({originalPath:t,paramPath:n||t}),a}}function H(r){let e=r;function t(n){let a=e.slice(0,n);return e=e.slice(n),a}function o(){return e}return{extractWeights:t,getRemainingWeights:o}}function Cr(r,e){let t=_t(r,e),o=Dt(r,e);function n(s,i,c,m=!1){let p=m?t(s,i,3,`${c}/conv0`):o(s,i,`${c}/conv0`),u=o(i,i,`${c}/conv1`),l=o(i,i,`${c}/conv2`);return{conv0:p,conv1:u,conv2:l}}function a(s,i,c,m=!1){let{conv0:p,conv1:u,conv2:l}=n(s,i,c,m),f=o(i,i,`${c}/conv3`);return{conv0:p,conv1:u,conv2:l,conv3:f}}return{extractDenseBlock3Params:n,extractDenseBlock4Params:a}}function gn(r){let e=[],{extractWeights:t,getRemainingWeights:o}=H(r),{extractDenseBlock4Params:n}=Cr(t,e),a=n(3,32,"dense0",!0),s=n(32,64,"dense1"),i=n(64,128,"dense2"),c=n(128,256,"dense3");if(o().length!==0)throw new Error(`weights remaing after extract: ${o().length}`);return{paramMappings:e,params:{dense0:a,dense1:s,dense2:i,dense3:c}}}function Nr(r){return e=>{let t=r(`${e}/filters`,4),o=r(`${e}/bias`,1);return{filters:t,bias:o}}}function Lr(r,e){let t=U(r,e),o=Nr(t),n=Et(t);function a(i,c=!1){let m=c?o(`${i}/conv0`):n(`${i}/conv0`),p=n(`${i}/conv1`),u=n(`${i}/conv2`);return{conv0:m,conv1:p,conv2:u}}function s(i,c=!1){let m=c?o(`${i}/conv0`):n(`${i}/conv0`),p=n(`${i}/conv1`),u=n(`${i}/conv2`),l=n(`${i}/conv3`);return{conv0:m,conv1:p,conv2:u,conv3:l}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:s}}function xn(r){let e=[],{extractDenseBlock4Params:t}=Lr(r,e),o={dense0:t("dense0",!0),dense1:t("dense1"),dense2:t("dense2"),dense3:t("dense3")};return j(r,e),{params:o,paramMappings:e}}var rr=class extends W{constructor(){super("FaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceFeatureExtractor - load model before inference");return ze.tidy(()=>{let o=ze.cast(e.toBatchTensor(112,!0),"float32"),a=pe(o,[122.782,117.001,104.298]).div(ze.scalar(255)),s=er(a,t.dense0,!0);return s=er(s,t.dense1),s=er(s,t.dense2),s=er(s,t.dense3),s=ze.avgPool(s,[7,7],[2,2],"valid"),s})}async forward(e){return this.forwardInput(await E(e))}getDefaultModelName(){return"face_feature_extractor_model"}extractParamsFromWeightMap(e){return xn(e)}extractParams(e){return gn(e)}};var Tn=x(T());var Mt=x(T());function or(r,e){return Mt.tidy(()=>Mt.add(Mt.matMul(r,e.weights),e.bias))}function yn(r,e,t){let o=[],{extractWeights:n,getRemainingWeights:a}=H(r),i=Er(n,o)(e,t,"fc");if(a().length!==0)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:o,params:{fc:i}}}function vn(r){let e=[],t=U(r,e);function o(a){let s=t(`${a}/weights`,2),i=t(`${a}/bias`,1);return{weights:s,bias:i}}let n={fc:o("fc")};return j(r,e),{params:n,paramMappings:e}}function Sr(r){let e={},t={};return Object.keys(r).forEach(o=>{let n=o.startsWith("fc")?t:e;n[o]=r[o]}),{featureExtractorMap:e,classifierMap:t}}var nr=class extends W{constructor(e,t){super(e);this._faceFeatureExtractor=t}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return Tn.tidy(()=>{let o=e instanceof Fe?this.faceFeatureExtractor.forwardInput(e):e;return or(o.as2D(o.shape[0],-1),t.fc)})}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:o}=this.extractClassifierParams(e);this._params=t,this._paramMappings=o}extractClassifierParams(e){return yn(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:o}=Sr(e);return this.faceFeatureExtractor.loadFromWeightMap(t),vn(o)}extractParams(e){let t=this.getClassifierChannelsIn(),o=this.getClassifierChannelsOut(),n=o*t+o,a=e.slice(0,e.length-n),s=e.slice(e.length-n);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(s)}};var So=["neutral","happy","sad","angry","fearful","disgusted","surprised"],Ye=class{constructor(e){if(e.length!==7)throw new Error(`FaceExpressions.constructor - expected probabilities.length to be 7, have: ${e.length}`);So.forEach((t,o)=>{this[t]=e[o]})}asSortedArray(){return So.map(e=>({expression:e,probability:this[e]})).sort((e,t)=>t.probability-e.probability)}};var kr=class extends nr{constructor(e=new rr){super("FaceExpressionNet",e)}forwardInput(e){return Ct.tidy(()=>Ct.softmax(this.runNet(e)))}async forward(e){return this.forwardInput(await E(e))}async predictExpressions(e){let t=await E(e),o=await this.forwardInput(t),n=await Promise.all(Ct.unstack(o).map(async s=>{let i=await s.data();return s.dispose(),i}));o.dispose();let a=n.map(s=>new Ye(s));return t.isBatchInput?a:a[0]}getDefaultModelName(){return"face_expression_model"}getClassifierChannelsIn(){return 256}getClassifierChannelsOut(){return 7}};function ko(r){return r.expressions instanceof Ye}function Ir(r,e){return{...r,...{expressions:e}}}function Ua(r,e,t=.1,o){(Array.isArray(e)?e:[e]).forEach(a=>{let s=a instanceof Ye?a:ko(a)?a.expressions:void 0;if(!s)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");let c=s.asSortedArray().filter(u=>u.probability>t),m=be(a)?a.detection.box.bottomLeft:o||new y(0,0);new Re(c.map(u=>`${u.expression} (${Ze(u.probability)})`),m).draw(r)})}function it(r){return be(r)&&r.landmarks instanceof J&&r.unshiftedLandmarks instanceof J&&r.alignedRect instanceof M}function Nt(r,e){let{box:t}=r.detection,o=e.shiftBy(t.x,t.y),n=o.align(),{imageDims:a}=r.detection,s=new M(r.detection.score,n.rescale(a.reverse()),a);return{...r,...{landmarks:o,unshiftedLandmarks:e,alignedRect:s}}}var Io=class{constructor(e={}){let{drawLines:t=!0,drawPoints:o=!0,lineWidth:n,lineColor:a,pointSize:s,pointColor:i}=e;this.drawLines=t,this.drawPoints=o,this.lineWidth=n||1,this.pointSize=s||2,this.lineColor=a||"rgba(0, 255, 255, 1)",this.pointColor=i||"rgba(255, 0, 255, 1)"}},Ao=class{constructor(e,t={}){this.faceLandmarks=e,this.options=new Io(t)}draw(e){let t=Y(e),{drawLines:o,drawPoints:n,lineWidth:a,lineColor:s,pointSize:i,pointColor:c}=this.options;if(o&&this.faceLandmarks instanceof yt&&(t.strokeStyle=s,t.lineWidth=a,ve(t,this.faceLandmarks.getJawOutline()),ve(t,this.faceLandmarks.getLeftEyeBrow()),ve(t,this.faceLandmarks.getRightEyeBrow()),ve(t,this.faceLandmarks.getNose()),ve(t,this.faceLandmarks.getLeftEye(),!0),ve(t,this.faceLandmarks.getRightEye(),!0),ve(t,this.faceLandmarks.getMouth(),!0)),n){t.strokeStyle=c,t.fillStyle=c;let m=p=>{t.beginPath(),t.arc(p.x,p.y,i,0,2*Math.PI),t.fill()};this.faceLandmarks.positions.forEach(m)}}};function Va(r,e){(Array.isArray(e)?e:[e]).forEach(o=>{let n=o instanceof J?o:it(o)?o.landmarks:void 0;if(!n)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new Ao(n).draw(r)})}var wn="0.30.3";var xe=x(T());var S=x(T());function qa(r,e){let t=_t(r,e),o=Dt(r,e);function n(s,i,c){let m=o(s,i,`${c}/separable_conv0`),p=o(i,i,`${c}/separable_conv1`),u=t(s,i,1,`${c}/expansion_conv`);return{separable_conv0:m,separable_conv1:p,expansion_conv:u}}function a(s,i){let c=o(s,s,`${i}/separable_conv0`),m=o(s,s,`${i}/separable_conv1`),p=o(s,s,`${i}/separable_conv2`);return{separable_conv0:c,separable_conv1:m,separable_conv2:p}}return{extractConvParams:t,extractSeparableConvParams:o,extractReductionBlockParams:n,extractMainBlockParams:a}}function Fn(r,e){let t=[],{extractWeights:o,getRemainingWeights:n}=H(r),{extractConvParams:a,extractSeparableConvParams:s,extractReductionBlockParams:i,extractMainBlockParams:c}=qa(o,t),m=a(3,32,3,"entry_flow/conv_in"),p=i(32,64,"entry_flow/reduction_block_0"),u=i(64,128,"entry_flow/reduction_block_1"),l={conv_in:m,reduction_block_0:p,reduction_block_1:u},f={};de(e,0,1).forEach(g=>{f[`main_block_${g}`]=c(128,`middle_flow/main_block_${g}`)});let h=i(128,256,"exit_flow/reduction_block"),F=s(256,512,"exit_flow/separable_conv"),b={reduction_block:h,separable_conv:F};if(n().length!==0)throw new Error(`weights remaing after extract: ${n().length}`);return{paramMappings:t,params:{entry_flow:l,middle_flow:f,exit_flow:b}}}function Xa(r,e){let t=U(r,e),o=Nr(t),n=Et(t);function a(i){let c=n(`${i}/separable_conv0`),m=n(`${i}/separable_conv1`),p=o(`${i}/expansion_conv`);return{separable_conv0:c,separable_conv1:m,expansion_conv:p}}function s(i){let c=n(`${i}/separable_conv0`),m=n(`${i}/separable_conv1`),p=n(`${i}/separable_conv2`);return{separable_conv0:c,separable_conv1:m,separable_conv2:p}}return{extractConvParams:o,extractSeparableConvParams:n,extractReductionBlockParams:a,extractMainBlockParams:s}}function Pn(r,e){let t=[],{extractConvParams:o,extractSeparableConvParams:n,extractReductionBlockParams:a,extractMainBlockParams:s}=Xa(r,t),i=o("entry_flow/conv_in"),c=a("entry_flow/reduction_block_0"),m=a("entry_flow/reduction_block_1"),p={conv_in:i,reduction_block_0:c,reduction_block_1:m},u={};de(e,0,1).forEach(F=>{u[`main_block_${F}`]=s(`middle_flow/main_block_${F}`)});let l=a("exit_flow/reduction_block"),f=n("exit_flow/separable_conv"),h={reduction_block:l,separable_conv:f};return j(r,t),{params:{entry_flow:p,middle_flow:u,exit_flow:h},paramMappings:t}}function _n(r,e,t){return S.add(S.conv2d(r,e.filters,t,"same"),e.bias)}function Wo(r,e,t=!0){let o=t?S.relu(r):r;return o=G(o,e.separable_conv0,[1,1]),o=G(S.relu(o),e.separable_conv1,[1,1]),o=S.maxPool(o,[3,3],[2,2],"same"),o=S.add(o,_n(r,e.expansion_conv,[2,2])),o}function Ja(r,e){let t=G(S.relu(r),e.separable_conv0,[1,1]);return t=G(S.relu(t),e.separable_conv1,[1,1]),t=G(S.relu(t),e.separable_conv2,[1,1]),t=S.add(t,r),t}var Ro=class extends W{constructor(e){super("TinyXception");this._numMainBlocks=e}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyXception - load model before inference");return S.tidy(()=>{let o=S.cast(e.toBatchTensor(112,!0),"float32"),a=pe(o,[122.782,117.001,104.298]).div(S.scalar(256)),s=S.relu(_n(a,t.entry_flow.conv_in,[2,2]));return s=Wo(s,t.entry_flow.reduction_block_0,!1),s=Wo(s,t.entry_flow.reduction_block_1),de(this._numMainBlocks,0,1).forEach(i=>{s=Ja(s,t.middle_flow[`main_block_${i}`])}),s=Wo(s,t.exit_flow.reduction_block),s=S.relu(G(s,t.exit_flow.separable_conv,[1,1])),s})}async forward(e){return this.forwardInput(await E(e))}getDefaultModelName(){return"tiny_xception_model"}extractParamsFromWeightMap(e){return Pn(e,this._numMainBlocks)}extractParams(e){return Fn(e,this._numMainBlocks)}};function Dn(r){let e=[],{extractWeights:t,getRemainingWeights:o}=H(r),n=Er(t,e),a=n(512,1,"fc/age"),s=n(512,2,"fc/gender");if(o().length!==0)throw new Error(`weights remaing after extract: ${o().length}`);return{paramMappings:e,params:{fc:{age:a,gender:s}}}}function En(r){let e=[],t=U(r,e);function o(a){let s=t(`${a}/weights`,2),i=t(`${a}/bias`,1);return{weights:s,bias:i}}let n={fc:{age:o("fc/age"),gender:o("fc/gender")}};return j(r,e),{params:n,paramMappings:e}}var Ce;(function(r){r.FEMALE="female",r.MALE="male"})(Ce||(Ce={}));var Ar=class extends W{constructor(e=new Ro(2)){super("AgeGenderNet");this._faceFeatureExtractor=e}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return xe.tidy(()=>{let o=e instanceof Fe?this.faceFeatureExtractor.forwardInput(e):e,n=xe.avgPool(o,[7,7],[2,2],"valid").as2D(o.shape[0],-1),a=or(n,t.fc.age).as1D(),s=or(n,t.fc.gender);return{age:a,gender:s}})}forwardInput(e){return xe.tidy(()=>{let{age:t,gender:o}=this.runNet(e);return{age:t,gender:xe.softmax(o)}})}async forward(e){return this.forwardInput(await E(e))}async predictAgeAndGender(e){let t=await E(e),o=await this.forwardInput(t),n=xe.unstack(o.age),a=xe.unstack(o.gender),s=n.map((c,m)=>({ageTensor:c,genderTensor:a[m]})),i=await Promise.all(s.map(async({ageTensor:c,genderTensor:m})=>{let p=(await c.data())[0],u=(await m.data())[0],l=u>.5,f=l?Ce.MALE:Ce.FEMALE,h=l?u:1-u;return c.dispose(),m.dispose(),{age:p,gender:f,genderProbability:h}}));return o.age.dispose(),o.gender.dispose(),t.isBatchInput?i:i[0]}getDefaultModelName(){return"age_gender_model"}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:o}=this.extractClassifierParams(e);this._params=t,this._paramMappings=o}extractClassifierParams(e){return Dn(e)}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:o}=Sr(e);return this.faceFeatureExtractor.loadFromWeightMap(t),En(o)}extractParams(e){let t=512*1+1+(512*2+2),o=e.slice(0,e.length-t),n=e.slice(e.length-t);return this.faceFeatureExtractor.extractWeights(o),this.extractClassifierParams(n)}};var V=x(T());var ar=class extends nr{postProcess(e,t,o){let n=o.map(({width:s,height:i})=>{let c=t/Math.max(i,s);return{width:s*c,height:i*c}}),a=n.length;return V.tidy(()=>{let s=(u,l)=>V.stack([V.fill([68],u,"float32"),V.fill([68],l,"float32")],1).as2D(1,136).as1D(),i=(u,l)=>{let{width:f,height:h}=n[u];return l(f,h)?Math.abs(f-h)/2:0},c=u=>i(u,(l,f)=>l<f),m=u=>i(u,(l,f)=>f<l);return e.mul(V.fill([a,136],t,"float32")).sub(V.stack(Array.from(Array(a),(u,l)=>s(c(l),m(l))))).div(V.stack(Array.from(Array(a),(u,l)=>s(n[l].width,n[l].height))))})}forwardInput(e){return V.tidy(()=>{let t=this.runNet(e);return this.postProcess(t,e.inputSize,e.inputDimensions.map(([o,n])=>({height:o,width:n})))})}async forward(e){return this.forwardInput(await E(e))}async detectLandmarks(e){let t=await E(e),o=V.tidy(()=>V.unstack(this.forwardInput(t))),n=await Promise.all(o.map(async(a,s)=>{let i=Array.from(await a.data()),c=i.filter((p,u)=>dr(u)),m=i.filter((p,u)=>!dr(u));return new yt(Array(68).fill(0).map((p,u)=>new y(c[u],m[u])),{height:t.getInputHeight(s),width:t.getInputWidth(s)})}));return o.forEach(a=>a.dispose()),t.isBatchInput?n:n[0]}getClassifierChannelsOut(){return 136}};var Lt=class extends ar{constructor(e=new rr){super("FaceLandmark68Net",e)}getDefaultModelName(){return"face_landmark_68_model"}getClassifierChannelsIn(){return 256}};var Ge=x(T());function Mn(r){let e=[],{extractDenseBlock3Params:t}=Lr(r,e),o={dense0:t("dense0",!0),dense1:t("dense1"),dense2:t("dense2")};return j(r,e),{params:o,paramMappings:e}}function Cn(r){let e=[],{extractWeights:t,getRemainingWeights:o}=H(r),{extractDenseBlock3Params:n}=Cr(t,e),a=n(3,32,"dense0",!0),s=n(32,64,"dense1"),i=n(64,128,"dense2");if(o().length!==0)throw new Error(`weights remaing after extract: ${o().length}`);return{paramMappings:e,params:{dense0:a,dense1:s,dense2:i}}}var Oo=class extends W{constructor(){super("TinyFaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyFaceFeatureExtractor - load model before inference");return Ge.tidy(()=>{let o=Ge.cast(e.toBatchTensor(112,!0),"float32"),a=pe(o,[122.782,117.001,104.298]).div(Ge.scalar(255)),s=Pr(a,t.dense0,!0);return s=Pr(s,t.dense1),s=Pr(s,t.dense2),s=Ge.avgPool(s,[14,14],[2,2],"valid"),s})}async forward(e){return this.forwardInput(await E(e))}getDefaultModelName(){return"face_feature_extractor_tiny_model"}extractParamsFromWeightMap(e){return Mn(e)}extractParams(e){return Cn(e)}};var Br=class extends ar{constructor(e=new Oo){super("FaceLandmark68TinyNet",e)}getDefaultModelName(){return"face_landmark_68_tiny_model"}getClassifierChannelsIn(){return 128}};var Nn=class extends Lt{};var K=x(T());var St=x(T());var Wr=x(T());function Ln(r,e){return Wr.add(Wr.mul(r,e.weights),e.biases)}function $o(r,e,t,o,n="same"){let{filters:a,bias:s}=e.conv,i=St.conv2d(r,a,t,n);return i=St.add(i,s),i=Ln(i,e.scale),o?St.relu(i):i}function Sn(r,e){return $o(r,e,[1,1],!0)}function jo(r,e){return $o(r,e,[1,1],!1)}function Rr(r,e){return $o(r,e,[2,2],!0,"valid")}var q=x(T());function Za(r,e){function t(i,c,m){let p=r(i),u=p.length/(c*m*m);if(ro(u))throw new Error(`depth has to be an integer: ${u}, weights.length: ${p.length}, numFilters: ${c}, filterSize: ${m}`);return q.tidy(()=>q.transpose(q.tensor4d(p,[c,u,m,m]),[2,3,1,0]))}function o(i,c,m,p){let u=t(i,c,m),l=q.tensor1d(r(c));return e.push({paramPath:`${p}/filters`},{paramPath:`${p}/bias`}),{filters:u,bias:l}}function n(i,c){let m=q.tensor1d(r(i)),p=q.tensor1d(r(i));return e.push({paramPath:`${c}/weights`},{paramPath:`${c}/biases`}),{weights:m,biases:p}}function a(i,c,m,p){let u=o(i,c,m,`${p}/conv`),l=n(c,`${p}/scale`);return{conv:u,scale:l}}function s(i,c,m,p,u=!1){let l=a((u?.5:1)*i,c,m,`${p}/conv1`),f=a(i,c,m,`${p}/conv2`);return{conv1:l,conv2:f}}return{extractConvLayerParams:a,extractResidualLayerParams:s}}function kn(r){let{extractWeights:e,getRemainingWeights:t}=H(r),o=[],{extractConvLayerParams:n,extractResidualLayerParams:a}=Za(e,o),s=n(4704,32,7,"conv32_down"),i=a(9216,32,3,"conv32_1"),c=a(9216,32,3,"conv32_2"),m=a(9216,32,3,"conv32_3"),p=a(36864,64,3,"conv64_down",!0),u=a(36864,64,3,"conv64_1"),l=a(36864,64,3,"conv64_2"),f=a(36864,64,3,"conv64_3"),h=a(147456,128,3,"conv128_down",!0),F=a(147456,128,3,"conv128_1"),b=a(147456,128,3,"conv128_2"),g=a(589824,256,3,"conv256_down",!0),v=a(589824,256,3,"conv256_1"),w=a(589824,256,3,"conv256_2"),L=a(589824,256,3,"conv256_down_out"),I=q.tidy(()=>q.transpose(q.tensor2d(e(256*128),[128,256]),[1,0]));if(o.push({paramPath:"fc"}),t().length!==0)throw new Error(`weights remaing after extract: ${t().length}`);return{params:{conv32_down:s,conv32_1:i,conv32_2:c,conv32_3:m,conv64_down:p,conv64_1:u,conv64_2:l,conv64_3:f,conv128_down:h,conv128_1:F,conv128_2:b,conv256_down:g,conv256_1:v,conv256_2:w,conv256_down_out:L,fc:I},paramMappings:o}}function Ka(r,e){let t=U(r,e);function o(s){let i=t(`${s}/scale/weights`,1),c=t(`${s}/scale/biases`,1);return{weights:i,biases:c}}function n(s){let i=t(`${s}/conv/filters`,4),c=t(`${s}/conv/bias`,1),m=o(s);return{conv:{filters:i,bias:c},scale:m}}function a(s){return{conv1:n(`${s}/conv1`),conv2:n(`${s}/conv2`)}}return{extractConvLayerParams:n,extractResidualLayerParams:a}}function In(r){let e=[],{extractConvLayerParams:t,extractResidualLayerParams:o}=Ka(r,e),n=t("conv32_down"),a=o("conv32_1"),s=o("conv32_2"),i=o("conv32_3"),c=o("conv64_down"),m=o("conv64_1"),p=o("conv64_2"),u=o("conv64_3"),l=o("conv128_down"),f=o("conv128_1"),h=o("conv128_2"),F=o("conv256_down"),b=o("conv256_1"),g=o("conv256_2"),v=o("conv256_down_out"),{fc:w}=r;if(e.push({originalPath:"fc",paramPath:"fc"}),!to(w))throw new Error(`expected weightMap[fc] to be a Tensor2D, instead have ${w}`);let L={conv32_down:n,conv32_1:a,conv32_2:s,conv32_3:i,conv64_down:c,conv64_1:m,conv64_2:p,conv64_3:u,conv128_down:l,conv128_1:f,conv128_2:h,conv256_down:F,conv256_1:b,conv256_2:g,conv256_down_out:v,fc:w};return j(r,e),{params:L,paramMappings:e}}var z=x(T());function ue(r,e){let t=Sn(r,e.conv1);return t=jo(t,e.conv2),t=z.add(t,r),t=z.relu(t),t}function sr(r,e){let t=Rr(r,e.conv1);t=jo(t,e.conv2);let o=z.avgPool(r,2,2,"valid"),n=z.zeros(o.shape),a=o.shape[3]!==t.shape[3];if(o.shape[1]!==t.shape[1]||o.shape[2]!==t.shape[2]){let i=[...t.shape];i[1]=1;let c=z.zeros(i);t=z.concat([t,c],1);let m=[...t.shape];m[2]=1;let p=z.zeros(m);t=z.concat([t,p],2)}return o=a?z.concat([o,n],3):o,t=z.add(o,t),t=z.relu(t),t}var kt=class extends W{constructor(){super("FaceRecognitionNet")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceRecognitionNet - load model before inference");return K.tidy(()=>{let o=K.cast(e.toBatchTensor(150,!0),"float32"),a=pe(o,[122.782,117.001,104.298]).div(K.scalar(256)),s=Rr(a,t.conv32_down);s=K.maxPool(s,3,2,"valid"),s=ue(s,t.conv32_1),s=ue(s,t.conv32_2),s=ue(s,t.conv32_3),s=sr(s,t.conv64_down),s=ue(s,t.conv64_1),s=ue(s,t.conv64_2),s=ue(s,t.conv64_3),s=sr(s,t.conv128_down),s=ue(s,t.conv128_1),s=ue(s,t.conv128_2),s=sr(s,t.conv256_down),s=ue(s,t.conv256_1),s=ue(s,t.conv256_2),s=sr(s,t.conv256_down_out);let i=s.mean([1,2]);return K.matMul(i,t.fc)})}async forward(e){return this.forwardInput(await E(e))}async computeFaceDescriptor(e){var a;if((a=e==null?void 0:e.shape)==null?void 0:a.some(s=>s<=0))return new Float32Array(128);let t=await E(e),o=K.tidy(()=>K.unstack(this.forwardInput(t))),n=await Promise.all(o.map(s=>s.data()));return o.forEach(s=>s.dispose()),t.isBatchInput?n:n[0]}getDefaultModelName(){return"face_recognition_model"}extractParamsFromWeightMap(e){return In(e)}extractParams(e){return kn(e)}};function Qa(r){let e=new kt;return e.extractWeights(r),e}function Or(r,e){return{...r,...{descriptor:e}}}function es(r){return typeof r.age=="number"}function $r(r,e){return{...r,...{age:e}}}function ts(r){return(r.gender===Ce.MALE||r.gender===Ce.FEMALE)&&bt(r.genderProbability)}function jr(r,e,t){return{...r,...{gender:e,genderProbability:t}}}var fe=x(T());var le=x(T());function rs(r,e){function t(c,m){let p=le.tensor4d(r(3*3*c),[3,3,c,1]),u=le.tensor1d(r(c)),l=le.tensor1d(r(c)),f=le.tensor1d(r(c)),h=le.tensor1d(r(c));return e.push({paramPath:`${m}/filters`},{paramPath:`${m}/batch_norm_scale`},{paramPath:`${m}/batch_norm_offset`},{paramPath:`${m}/batch_norm_mean`},{paramPath:`${m}/batch_norm_variance`}),{filters:p,batch_norm_scale:u,batch_norm_offset:l,batch_norm_mean:f,batch_norm_variance:h}}function o(c,m,p,u,l){let f=le.tensor4d(r(c*m*p*p),[p,p,c,m]),h=le.tensor1d(r(m));return e.push({paramPath:`${u}/filters`},{paramPath:`${u}/${l?"batch_norm_offset":"bias"}`}),{filters:f,bias:h}}function n(c,m,p,u){let{filters:l,bias:f}=o(c,m,p,u,!0);return{filters:l,batch_norm_offset:f}}function a(c,m,p){let u=t(c,`${p}/depthwise_conv`),l=n(c,m,1,`${p}/pointwise_conv`);return{depthwise_conv:u,pointwise_conv:l}}function s(){let c=n(3,32,3,"mobilenetv1/conv_0"),m=a(32,64,"mobilenetv1/conv_1"),p=a(64,128,"mobilenetv1/conv_2"),u=a(128,128,"mobilenetv1/conv_3"),l=a(128,256,"mobilenetv1/conv_4"),f=a(256,256,"mobilenetv1/conv_5"),h=a(256,512,"mobilenetv1/conv_6"),F=a(512,512,"mobilenetv1/conv_7"),b=a(512,512,"mobilenetv1/conv_8"),g=a(512,512,"mobilenetv1/conv_9"),v=a(512,512,"mobilenetv1/conv_10"),w=a(512,512,"mobilenetv1/conv_11"),L=a(512,1024,"mobilenetv1/conv_12"),I=a(1024,1024,"mobilenetv1/conv_13");return{conv_0:c,conv_1:m,conv_2:p,conv_3:u,conv_4:l,conv_5:f,conv_6:h,conv_7:F,conv_8:b,conv_9:g,conv_10:v,conv_11:w,conv_12:L,conv_13:I}}function i(){let c=n(1024,256,1,"prediction_layer/conv_0"),m=n(256,512,3,"prediction_layer/conv_1"),p=n(512,128,1,"prediction_layer/conv_2"),u=n(128,256,3,"prediction_layer/conv_3"),l=n(256,128,1,"prediction_layer/conv_4"),f=n(128,256,3,"prediction_layer/conv_5"),h=n(256,64,1,"prediction_layer/conv_6"),F=n(64,128,3,"prediction_layer/conv_7"),b=o(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),g=o(512,9,1,"prediction_layer/box_predictor_0/class_predictor"),v=o(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),w=o(1024,18,1,"prediction_layer/box_predictor_1/class_predictor"),L=o(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),I=o(512,18,1,"prediction_layer/box_predictor_2/class_predictor"),R=o(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),Q=o(256,18,1,"prediction_layer/box_predictor_3/class_predictor"),ee=o(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),ke=o(256,18,1,"prediction_layer/box_predictor_4/class_predictor"),Ie=o(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),Ae=o(128,18,1,"prediction_layer/box_predictor_5/class_predictor");return{conv_0:c,conv_1:m,conv_2:p,conv_3:u,conv_4:l,conv_5:f,conv_6:h,conv_7:F,box_predictor_0:{box_encoding_predictor:b,class_predictor:g},box_predictor_1:{box_encoding_predictor:v,class_predictor:w},box_predictor_2:{box_encoding_predictor:L,class_predictor:I},box_predictor_3:{box_encoding_predictor:R,class_predictor:Q},box_predictor_4:{box_encoding_predictor:ee,class_predictor:ke},box_predictor_5:{box_encoding_predictor:Ie,class_predictor:Ae}}}return{extractMobilenetV1Params:s,extractPredictionLayerParams:i}}function An(r){let e=[],{extractWeights:t,getRemainingWeights:o}=H(r),{extractMobilenetV1Params:n,extractPredictionLayerParams:a}=rs(t,e),s=n(),i=a(),m={extra_dim:le.tensor3d(t(5118*4),[1,5118,4])};if(e.push({paramPath:"output_layer/extra_dim"}),o().length!==0)throw new Error(`weights remaing after extract: ${o().length}`);return{params:{mobilenetv1:s,prediction_layer:i,output_layer:m},paramMappings:e}}function os(r,e){let t=U(r,e);function o(m,p,u){let l=t(`${m}/Conv2d_${p}_pointwise/weights`,4,`${u}/filters`),f=t(`${m}/Conv2d_${p}_pointwise/convolution_bn_offset`,1,`${u}/batch_norm_offset`);return{filters:l,batch_norm_offset:f}}function n(m){let p=`mobilenetv1/conv_${m}`,u=`MobilenetV1/Conv2d_${m}_depthwise`,l=`${p}/depthwise_conv`,f=`${p}/pointwise_conv`,h=t(`${u}/depthwise_weights`,4,`${l}/filters`),F=t(`${u}/BatchNorm/gamma`,1,`${l}/batch_norm_scale`),b=t(`${u}/BatchNorm/beta`,1,`${l}/batch_norm_offset`),g=t(`${u}/BatchNorm/moving_mean`,1,`${l}/batch_norm_mean`),v=t(`${u}/BatchNorm/moving_variance`,1,`${l}/batch_norm_variance`);return{depthwise_conv:{filters:h,batch_norm_scale:F,batch_norm_offset:b,batch_norm_mean:g,batch_norm_variance:v},pointwise_conv:o("MobilenetV1",m,f)}}function a(){return{conv_0:o("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:n(1),conv_2:n(2),conv_3:n(3),conv_4:n(4),conv_5:n(5),conv_6:n(6),conv_7:n(7),conv_8:n(8),conv_9:n(9),conv_10:n(10),conv_11:n(11),conv_12:n(12),conv_13:n(13)}}function s(m,p){let u=t(`${m}/weights`,4,`${p}/filters`),l=t(`${m}/biases`,1,`${p}/bias`);return{filters:u,bias:l}}function i(m){let p=s(`Prediction/BoxPredictor_${m}/BoxEncodingPredictor`,`prediction_layer/box_predictor_${m}/box_encoding_predictor`),u=s(`Prediction/BoxPredictor_${m}/ClassPredictor`,`prediction_layer/box_predictor_${m}/class_predictor`);return{box_encoding_predictor:p,class_predictor:u}}function c(){return{conv_0:o("Prediction",0,"prediction_layer/conv_0"),conv_1:o("Prediction",1,"prediction_layer/conv_1"),conv_2:o("Prediction",2,"prediction_layer/conv_2"),conv_3:o("Prediction",3,"prediction_layer/conv_3"),conv_4:o("Prediction",4,"prediction_layer/conv_4"),conv_5:o("Prediction",5,"prediction_layer/conv_5"),conv_6:o("Prediction",6,"prediction_layer/conv_6"),conv_7:o("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:i(0),box_predictor_1:i(1),box_predictor_2:i(2),box_predictor_3:i(3),box_predictor_4:i(4),box_predictor_5:i(5)}}return{extractMobilenetV1Params:a,extractPredictionLayerParams:c}}function Bn(r){let e=[],{extractMobilenetV1Params:t,extractPredictionLayerParams:o}=os(r,e),n=r["Output/extra_dim"];if(e.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!Te(n))throw new Error(`expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have ${n}`);let a={mobilenetv1:t(),prediction_layer:o(),output_layer:{extra_dim:n}};return j(r,e),{params:a,paramMappings:e}}var Ne=x(T());var Ue=x(T());function ne(r,e,t){return Ue.tidy(()=>{let o=Ue.conv2d(r,e.filters,t,"same");return o=Ue.add(o,e.batch_norm_offset),Ue.clipByValue(o,0,6)})}var ns=.0010000000474974513;function as(r,e,t){return Ne.tidy(()=>{let o=Ne.depthwiseConv2d(r,e.filters,t,"same");return o=Ne.batchNorm(o,e.batch_norm_mean,e.batch_norm_variance,e.batch_norm_offset,e.batch_norm_scale,ns),Ne.clipByValue(o,0,6)})}function ss(r){return[2,4,6,12].some(e=>e===r)?[2,2]:[1,1]}function Wn(r,e){return Ne.tidy(()=>{let t,o=ne(r,e.conv_0,[2,2]);if([e.conv_1,e.conv_2,e.conv_3,e.conv_4,e.conv_5,e.conv_6,e.conv_7,e.conv_8,e.conv_9,e.conv_10,e.conv_11,e.conv_12,e.conv_13].forEach((a,s)=>{let i=s+1,c=ss(i);o=as(o,a.depthwise_conv,c),o=ne(o,a.pointwise_conv,[1,1]),i===11&&(t=o)}),t===null)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:o,conv11:t}})}function is(r,e,t){let o=r.arraySync(),n=Math.min(o[e][0],o[e][2]),a=Math.min(o[e][1],o[e][3]),s=Math.max(o[e][0],o[e][2]),i=Math.max(o[e][1],o[e][3]),c=Math.min(o[t][0],o[t][2]),m=Math.min(o[t][1],o[t][3]),p=Math.max(o[t][0],o[t][2]),u=Math.max(o[t][1],o[t][3]),l=(s-n)*(i-a),f=(p-c)*(u-m);if(l<=0||f<=0)return 0;let h=Math.max(n,c),F=Math.max(a,m),b=Math.min(s,p),g=Math.min(i,u),v=Math.max(b-h,0)*Math.max(g-F,0);return v/(l+f-v)}function Rn(r,e,t,o,n){let a=r.shape[0],s=Math.min(t,a),i=e.map((p,u)=>({score:p,boxIndex:u})).filter(p=>p.score>n).sort((p,u)=>u.score-p.score),c=p=>p<=o?1:0,m=[];return i.forEach(p=>{if(m.length>=s)return;let u=p.score;for(let l=m.length-1;l>=0;--l){let f=is(r,p.boxIndex,m[l]);if(f!==0&&(p.score*=c(f),p.score<=n))break}u===p.score&&m.push(p.boxIndex)}),m}var d=x(T());function cs(r){let e=d.unstack(d.transpose(r,[1,0])),t=[d.sub(e[2],e[0]),d.sub(e[3],e[1])],o=[d.add(e[0],d.div(t[0],d.scalar(2))),d.add(e[1],d.div(t[1],d.scalar(2)))];return{sizes:t,centers:o}}function ms(r,e){let{sizes:t,centers:o}=cs(r),n=d.unstack(d.transpose(e,[1,0])),a=d.div(d.mul(d.exp(d.div(n[2],d.scalar(5))),t[0]),d.scalar(2)),s=d.add(d.mul(d.div(n[0],d.scalar(10)),t[0]),o[0]),i=d.div(d.mul(d.exp(d.div(n[3],d.scalar(5))),t[1]),d.scalar(2)),c=d.add(d.mul(d.div(n[1],d.scalar(10)),t[1]),o[1]);return d.transpose(d.stack([d.sub(s,a),d.sub(c,i),d.add(s,a),d.add(c,i)]),[1,0])}function On(r,e,t){return d.tidy(()=>{let o=r.shape[0],n=ms(d.reshape(d.tile(t.extra_dim,[o,1,1]),[-1,4]),d.reshape(r,[-1,4]));n=d.reshape(n,[o,n.shape[0]/o,4]);let a=d.sigmoid(d.slice(e,[0,0,1],[-1,-1,-1])),s=d.slice(a,[0,0,0],[-1,-1,1]);s=d.reshape(s,[o,s.shape[1]]);let i=d.unstack(n),c=d.unstack(s);return{boxes:i,scores:c}})}var cr=x(T());var ir=x(T());function ct(r,e){return ir.tidy(()=>{let t=r.shape[0],o=ir.reshape(st(r,e.box_encoding_predictor),[t,-1,1,4]),n=ir.reshape(st(r,e.class_predictor),[t,-1,3]);return{boxPredictionEncoding:o,classPrediction:n}})}function $n(r,e,t){return cr.tidy(()=>{let o=ne(r,t.conv_0,[1,1]),n=ne(o,t.conv_1,[2,2]),a=ne(n,t.conv_2,[1,1]),s=ne(a,t.conv_3,[2,2]),i=ne(s,t.conv_4,[1,1]),c=ne(i,t.conv_5,[2,2]),m=ne(c,t.conv_6,[1,1]),p=ne(m,t.conv_7,[2,2]),u=ct(e,t.box_predictor_0),l=ct(r,t.box_predictor_1),f=ct(n,t.box_predictor_2),h=ct(s,t.box_predictor_3),F=ct(c,t.box_predictor_4),b=ct(p,t.box_predictor_5),g=cr.concat([u.boxPredictionEncoding,l.boxPredictionEncoding,f.boxPredictionEncoding,h.boxPredictionEncoding,F.boxPredictionEncoding,b.boxPredictionEncoding],1),v=cr.concat([u.classPrediction,l.classPrediction,f.classPrediction,h.classPrediction,F.classPrediction,b.classPrediction],1);return{boxPredictions:g,classPredictions:v}})}var ae=class{constructor({minConfidence:e,maxResults:t}={}){this._name="SsdMobilenetv1Options";if(this._minConfidence=e||.5,this._maxResults=t||100,typeof this._minConfidence!="number"||this._minConfidence<=0||this._minConfidence>=1)throw new Error(`${this._name} - expected minConfidence to be a number between 0 and 1`);if(typeof this._maxResults!="number")throw new Error(`${this._name} - expected maxResults to be a number`)}get minConfidence(){return this._minConfidence}get maxResults(){return this._maxResults}};var mt=class extends W{constructor(){super("SsdMobilenetv1")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("SsdMobilenetv1 - load model before inference");return fe.tidy(()=>{let o=fe.cast(e.toBatchTensor(512,!1),"float32"),n=fe.sub(fe.mul(o,fe.scalar(.007843137718737125)),fe.scalar(1)),a=Wn(n,t.mobilenetv1),{boxPredictions:s,classPredictions:i}=$n(a.out,a.conv11,t.prediction_layer);return On(s,i,t.output_layer)})}async forward(e){return this.forwardInput(await E(e))}async locateFaces(e,t={}){let{maxResults:o,minConfidence:n}=new ae(t),a=await E(e),{boxes:s,scores:i}=this.forwardInput(a),c=s[0],m=i[0];for(let w=1;w<s.length;w++)s[w].dispose(),i[w].dispose();let p=Array.from(await m.data()),l=Rn(c,p,o,.5,n),f=a.getReshapedInputDimensions(0),h=a.inputSize,F=h/f.width,b=h/f.height,g=c.arraySync(),v=l.map(w=>{let[L,I]=[Math.max(0,g[w][0]),Math.min(1,g[w][2])].map(ee=>ee*b),[R,Q]=[Math.max(0,g[w][1]),Math.min(1,g[w][3])].map(ee=>ee*F);return new M(p[w],new xt(R,L,Q-R,I-L),{height:a.getInputHeight(0),width:a.getInputWidth(0)})});return c.dispose(),m.dispose(),v}getDefaultModelName(){return"ssd_mobilenetv1_model"}extractParamsFromWeightMap(e){return Bn(e)}extractParams(e){return An(e)}};function jn(r){let e=new mt;return e.extractWeights(r),e}function ps(r){return jn(r)}var Hn=class extends mt{};var zn=.4,Yn=[new y(.738768,.874946),new y(2.42204,2.65704),new y(4.30971,7.04493),new y(10.246,4.59428),new y(12.6868,11.8741)],Gn=[new y(1.603231,2.094468),new y(6.041143,7.080126),new y(2.882459,3.518061),new y(4.266906,5.178857),new y(9.041765,10.66308)],Un=[117.001,114.697,97.404],Vn="tiny_yolov2_model",qn="tiny_yolov2_separable_conv_model";var N=x(T());var Hr=r=>typeof r=="number";function Ho(r){if(!r)throw new Error(`invalid config: ${r}`);if(typeof r.withSeparableConvs!="boolean")throw new Error(`config.withSeparableConvs has to be a boolean, have: ${r.withSeparableConvs}`);if(!Hr(r.iouThreshold)||r.iouThreshold<0||r.iouThreshold>1)throw new Error(`config.iouThreshold has to be a number between [0, 1], have: ${r.iouThreshold}`);if(!Array.isArray(r.classes)||!r.classes.length||!r.classes.every(e=>typeof e=="string"))throw new Error(`config.classes has to be an array class names: string[], have: ${JSON.stringify(r.classes)}`);if(!Array.isArray(r.anchors)||!r.anchors.length||!r.anchors.map(e=>e||{}).every(e=>Hr(e.x)&&Hr(e.y)))throw new Error(`config.anchors has to be an array of { x: number, y: number }, have: ${JSON.stringify(r.anchors)}`);if(r.meanRgb&&(!Array.isArray(r.meanRgb)||r.meanRgb.length!==3||!r.meanRgb.every(Hr)))throw new Error(`config.meanRgb has to be an array of shape [number, number, number], have: ${JSON.stringify(r.meanRgb)}`)}var ie=x(T());var se=x(T());function It(r){return se.tidy(()=>{let e=se.mul(r,se.scalar(.10000000149011612));return se.add(se.relu(se.sub(r,e)),e)})}function Le(r,e){return ie.tidy(()=>{let t=ie.pad(r,[[0,0],[1,1],[1,1],[0,0]]);return t=ie.conv2d(t,e.conv.filters,[1,1],"valid"),t=ie.sub(t,e.bn.sub),t=ie.mul(t,e.bn.truediv),t=ie.add(t,e.conv.bias),It(t)})}var Ve=x(T());function Se(r,e){return Ve.tidy(()=>{let t=Ve.pad(r,[[0,0],[1,1],[1,1],[0,0]]);return t=Ve.separableConv2d(t,e.depthwise_filter,e.pointwise_filter,[1,1],"valid"),t=Ve.add(t,e.bias),It(t)})}var zo=x(T());function us(r,e){let t=_t(r,e);function o(s,i){let c=zo.tensor1d(r(s)),m=zo.tensor1d(r(s));return e.push({paramPath:`${i}/sub`},{paramPath:`${i}/truediv`}),{sub:c,truediv:m}}function n(s,i,c){let m=t(s,i,3,`${c}/conv`),p=o(i,`${c}/bn`);return{conv:m,bn:p}}let a=Dt(r,e);return{extractConvParams:t,extractConvWithBatchNormParams:n,extractSeparableConvParams:a}}function Xn(r,e,t,o){let{extractWeights:n,getRemainingWeights:a}=H(r),s=[],{extractConvParams:i,extractConvWithBatchNormParams:c,extractSeparableConvParams:m}=us(n,s),p;if(e.withSeparableConvs){let[u,l,f,h,F,b,g,v,w]=o,L=e.isFirstLayerConv2d?i(u,l,3,"conv0"):m(u,l,"conv0"),I=m(l,f,"conv1"),R=m(f,h,"conv2"),Q=m(h,F,"conv3"),ee=m(F,b,"conv4"),ke=m(b,g,"conv5"),Ie=v?m(g,v,"conv6"):void 0,Ae=w?m(v,w,"conv7"):void 0,ht=i(w||v||g,5*t,1,"conv8");p={conv0:L,conv1:I,conv2:R,conv3:Q,conv4:ee,conv5:ke,conv6:Ie,conv7:Ae,conv8:ht}}else{let[u,l,f,h,F,b,g,v,w]=o,L=c(u,l,"conv0"),I=c(l,f,"conv1"),R=c(f,h,"conv2"),Q=c(h,F,"conv3"),ee=c(F,b,"conv4"),ke=c(b,g,"conv5"),Ie=c(g,v,"conv6"),Ae=c(v,w,"conv7"),ht=i(w,5*t,1,"conv8");p={conv0:L,conv1:I,conv2:R,conv3:Q,conv4:ee,conv5:ke,conv6:Ie,conv7:Ae,conv8:ht}}if(a().length!==0)throw new Error(`weights remaing after extract: ${a().length}`);return{params:p,paramMappings:s}}function ls(r,e){let t=U(r,e);function o(i){let c=t(`${i}/sub`,1),m=t(`${i}/truediv`,1);return{sub:c,truediv:m}}function n(i){let c=t(`${i}/filters`,4),m=t(`${i}/bias`,1);return{filters:c,bias:m}}function a(i){let c=n(`${i}/conv`),m=o(`${i}/bn`);return{conv:c,bn:m}}let s=Et(t);return{extractConvParams:n,extractConvWithBatchNormParams:a,extractSeparableConvParams:s}}function Jn(r,e){let t=[],{extractConvParams:o,extractConvWithBatchNormParams:n,extractSeparableConvParams:a}=ls(r,t),s;if(e.withSeparableConvs){let i=e.filterSizes&&e.filterSizes.length||9;s={conv0:e.isFirstLayerConv2d?o("conv0"):a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:i>7?a("conv6"):void 0,conv7:i>8?a("conv7"):void 0,conv8:o("conv8")}}else s={conv0:n("conv0"),conv1:n("conv1"),conv2:n("conv2"),conv3:n("conv3"),conv4:n("conv4"),conv5:n("conv5"),conv6:n("conv6"),conv7:n("conv7"),conv8:o("conv8")};return j(r,t),{params:s,paramMappings:t}}var ye=class{constructor({inputSize:e,scoreThreshold:t}={}){this._name="TinyYolov2Options";if(this._inputSize=e||416,this._scoreThreshold=t||.5,typeof this._inputSize!="number"||this._inputSize%32!=0)throw new Error(`${this._name} - expected inputSize to be a number divisible by 32`);if(typeof this._scoreThreshold!="number"||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(`${this._name} - expected scoreThreshold to be a number between 0 and 1`)}get inputSize(){return this._inputSize}get scoreThreshold(){return this._scoreThreshold}};var Yo=class extends W{constructor(e){super("TinyYolov2");Ho(e),this._config=e}get config(){return this._config}get withClassScores(){return this.config.withClassScores||this.config.classes.length>1}get boxEncodingSize(){return 5+(this.withClassScores?this.config.classes.length:0)}runTinyYolov2(e,t){let o=Le(e,t.conv0);return o=N.maxPool(o,[2,2],[2,2],"same"),o=Le(o,t.conv1),o=N.maxPool(o,[2,2],[2,2],"same"),o=Le(o,t.conv2),o=N.maxPool(o,[2,2],[2,2],"same"),o=Le(o,t.conv3),o=N.maxPool(o,[2,2],[2,2],"same"),o=Le(o,t.conv4),o=N.maxPool(o,[2,2],[2,2],"same"),o=Le(o,t.conv5),o=N.maxPool(o,[2,2],[1,1],"same"),o=Le(o,t.conv6),o=Le(o,t.conv7),st(o,t.conv8,"valid",!1)}runMobilenet(e,t){let o=this.config.isFirstLayerConv2d?It(st(e,t.conv0,"valid",!1)):Se(e,t.conv0);return o=N.maxPool(o,[2,2],[2,2],"same"),o=Se(o,t.conv1),o=N.maxPool(o,[2,2],[2,2],"same"),o=Se(o,t.conv2),o=N.maxPool(o,[2,2],[2,2],"same"),o=Se(o,t.conv3),o=N.maxPool(o,[2,2],[2,2],"same"),o=Se(o,t.conv4),o=N.maxPool(o,[2,2],[2,2],"same"),o=Se(o,t.conv5),o=N.maxPool(o,[2,2],[1,1],"same"),o=t.conv6?Se(o,t.conv6):o,o=t.conv7?Se(o,t.conv7):o,st(o,t.conv8,"valid",!1)}forwardInput(e,t){let{params:o}=this;if(!o)throw new Error("TinyYolov2 - load model before inference");return N.tidy(()=>{let n=N.cast(e.toBatchTensor(t,!1),"float32");return n=this.config.meanRgb?pe(n,this.config.meanRgb):n,n=n.div(N.scalar(256)),this.config.withSeparableConvs?this.runMobilenet(n,o):this.runTinyYolov2(n,o)})}async forward(e,t){return this.forwardInput(await E(e),t)}async detect(e,t={}){let{inputSize:o,scoreThreshold:n}=new ye(t),a=await E(e),s=await this.forwardInput(a,o),i=N.tidy(()=>N.unstack(s)[0].expandDims()),c={width:a.getInputWidth(0),height:a.getInputHeight(0)},m=await this.extractBoxes(i,a.getReshapedInputDimensions(0),n);s.dispose(),i.dispose();let p=m.map(b=>b.box),u=m.map(b=>b.score),l=m.map(b=>b.classScore),f=m.map(b=>this.config.classes[b.label]);return so(p.map(b=>b.rescale(o)),u,this.config.iouThreshold,!0).map(b=>new Be(u[b],l[b],f[b],p[b],c))}getDefaultModelName(){return""}extractParamsFromWeightMap(e){return Jn(e,this.config)}extractParams(e){let t=this.config.filterSizes||Yo.DEFAULT_FILTER_SIZES,o=t?t.length:void 0;if(o!==7&&o!==8&&o!==9)throw new Error(`TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found ${o} filterSizes in config`);return Xn(e,this.config,this.boxEncodingSize,t)}async extractBoxes(e,t,o){let{width:n,height:a}=t,s=Math.max(n,a),i=s/n,c=s/a,m=e.shape[1],p=this.config.anchors.length,[u,l,f]=N.tidy(()=>{let g=e.reshape([m,m,p,this.boxEncodingSize]),v=g.slice([0,0,0,0],[m,m,p,4]),w=g.slice([0,0,0,4],[m,m,p,1]),L=this.withClassScores?N.softmax(g.slice([0,0,0,5],[m,m,p,this.config.classes.length]),3):N.scalar(0);return[v,w,L]}),h=[],F=await l.array(),b=await u.array();for(let g=0;g<m;g++)for(let v=0;v<m;v++)for(let w=0;w<p;w++){let L=Yt(F[g][v][w][0]);if(!o||L>o){let I=(v+Yt(b[g][v][w][0]))/m*i,R=(g+Yt(b[g][v][w][1]))/m*c,Q=Math.exp(b[g][v][w][2])*this.config.anchors[w].x/m*i,ee=Math.exp(b[g][v][w][3])*this.config.anchors[w].y/m*c,ke=I-Q/2,Ie=R-ee/2,Ae={row:g,col:v,anchor:w},{classScore:ht,label:Xo}=this.withClassScores?await this.extractPredictedClass(f,Ae):{classScore:1,label:0};h.push({box:new gt(ke,Ie,ke+Q,Ie+ee),score:L,classScore:L*ht,label:Xo,...Ae})}}return u.dispose(),l.dispose(),f.dispose(),h}async extractPredictedClass(e,t){let{row:o,col:n,anchor:a}=t,s=await e.array();return Array(this.config.classes.length).fill(0).map((i,c)=>s[o][n][a][c]).map((i,c)=>({classScore:i,label:c})).reduce((i,c)=>i.classScore>c.classScore?i:c)}},At=Yo;At.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];var Bt=class extends At{constructor(e=!0){let t={withSeparableConvs:e,iouThreshold:zn,classes:["face"],...e?{anchors:Gn,meanRgb:Un}:{anchors:Yn,withClassScores:!0}};super(t)}get withSeparableConvs(){return this.config.withSeparableConvs}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map(n=>new M(n.score,n.relativeBox,{width:n.imageWidth,height:n.imageHeight}))}getDefaultModelName(){return this.withSeparableConvs?qn:Vn}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}};function fs(r,e=!0){let t=new Bt(e);return t.extractWeights(r),t}var zr=class extends ye{constructor(){super(...arguments);this._name="TinyFaceDetectorOptions"}};var ce=class{async then(e){return e(await this.run())}async run(){throw new Error("ComposableTask - run is not implemented")}};var mr=x(T());var Go=x(T());async function pt(r,e,t,o,n=({alignedRect:a})=>a){let a=r.map(c=>it(c)?n(c):c.detection),s=o||(e instanceof Go.Tensor?await Tt(e,a):await vt(e,a)),i=await t(s);return s.forEach(c=>c instanceof Go.Tensor&&c.dispose()),i}async function Wt(r,e,t,o,n){return pt([r],e,async a=>t(a[0]),o,n)}var Zn=.4,Kn=[new y(1.603231,2.094468),new y(6.041143,7.080126),new y(2.882459,3.518061),new y(4.266906,5.178857),new y(9.041765,10.66308)],Qn=[117.001,114.697,97.404];var Rt=class extends At{constructor(){let e={withSeparableConvs:!0,iouThreshold:Zn,classes:["face"],anchors:Kn,meanRgb:Qn,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};super(e)}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map(n=>new M(n.score,n.relativeBox,{width:n.imageWidth,height:n.imageHeight}))}getDefaultModelName(){return"tiny_face_detector_model"}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}};var P={ssdMobilenetv1:new mt,tinyFaceDetector:new Rt,tinyYolov2:new Bt,faceLandmark68Net:new Lt,faceLandmark68TinyNet:new Br,faceRecognitionNet:new kt,faceExpressionNet:new kr,ageGenderNet:new Ar},ea=(r,e)=>P.ssdMobilenetv1.locateFaces(r,e),ds=(r,e)=>P.tinyFaceDetector.locateFaces(r,e),hs=(r,e)=>P.tinyYolov2.locateFaces(r,e),ta=r=>P.faceLandmark68Net.detectLandmarks(r),bs=r=>P.faceLandmark68TinyNet.detectLandmarks(r),gs=r=>P.faceRecognitionNet.computeFaceDescriptor(r),xs=r=>P.faceExpressionNet.predictExpressions(r),ys=r=>P.ageGenderNet.predictAgeAndGender(r),ra=r=>P.ssdMobilenetv1.load(r),vs=r=>P.tinyFaceDetector.load(r),Ts=r=>P.tinyYolov2.load(r),ws=r=>P.faceLandmark68Net.load(r),Fs=r=>P.faceLandmark68TinyNet.load(r),Ps=r=>P.faceRecognitionNet.load(r),_s=r=>P.faceExpressionNet.load(r),Ds=r=>P.ageGenderNet.load(r),Es=ra,Ms=ea,Cs=ta;var Uo=class extends ce{constructor(e,t,o){super();this.parentTask=e;this.input=t;this.extractedFaces=o}},jt=class extends Uo{async run(){let e=await this.parentTask,t=await pt(e,this.input,async o=>Promise.all(o.map(n=>P.faceExpressionNet.predictExpressions(n))),this.extractedFaces);return e.map((o,n)=>Ir(o,t[n]))}withAgeAndGender(){return new Ot(this,this.input)}},Ht=class extends Uo{async run(){let e=await this.parentTask;if(!e)return;let t=await Wt(e,this.input,o=>P.faceExpressionNet.predictExpressions(o),this.extractedFaces);return Ir(e,t)}withAgeAndGender(){return new $t(this,this.input)}},ft=class extends jt{withAgeAndGender(){return new ut(this,this.input)}withFaceDescriptors(){return new qe(this,this.input)}},dt=class extends Ht{withAgeAndGender(){return new lt(this,this.input)}withFaceDescriptor(){return new Xe(this,this.input)}};var Vo=class extends ce{constructor(e,t,o){super();this.parentTask=e;this.input=t;this.extractedFaces=o}},Ot=class extends Vo{async run(){let e=await this.parentTask,t=await pt(e,this.input,async o=>Promise.all(o.map(n=>P.ageGenderNet.predictAgeAndGender(n))),this.extractedFaces);return e.map((o,n)=>{let{age:a,gender:s,genderProbability:i}=t[n];return $r(jr(o,s,i),a)})}withFaceExpressions(){return new jt(this,this.input)}},$t=class extends Vo{async run(){let e=await this.parentTask;if(!e)return;let{age:t,gender:o,genderProbability:n}=await Wt(e,this.input,a=>P.ageGenderNet.predictAgeAndGender(a),this.extractedFaces);return $r(jr(e,o,n),t)}withFaceExpressions(){return new Ht(this,this.input)}},ut=class extends Ot{withFaceExpressions(){return new ft(this,this.input)}withFaceDescriptors(){return new qe(this,this.input)}},lt=class extends $t{withFaceExpressions(){return new dt(this,this.input)}withFaceDescriptor(){return new Xe(this,this.input)}};var Yr=class extends ce{constructor(e,t){super();this.parentTask=e;this.input=t}},qe=class extends Yr{async run(){let e=await this.parentTask;return(await pt(e,this.input,o=>Promise.all(o.map(n=>P.faceRecognitionNet.computeFaceDescriptor(n))),null,o=>o.landmarks.align(null,{useDlibAlignment:!0}))).map((o,n)=>Or(e[n],o))}withFaceExpressions(){return new ft(this,this.input)}withAgeAndGender(){return new ut(this,this.input)}},Xe=class extends Yr{async run(){let e=await this.parentTask;if(!e)return;let t=await Wt(e,this.input,o=>P.faceRecognitionNet.computeFaceDescriptor(o),null,o=>o.landmarks.align(null,{useDlibAlignment:!0}));return Or(e,t)}withFaceExpressions(){return new dt(this,this.input)}withAgeAndGender(){return new lt(this,this.input)}};var Gr=class extends ce{constructor(e,t,o){super();this.parentTask=e;this.input=t;this.useTinyLandmarkNet=o}get landmarkNet(){return this.useTinyLandmarkNet?P.faceLandmark68TinyNet:P.faceLandmark68Net}},Ur=class extends Gr{async run(){let e=await this.parentTask,t=e.map(a=>a.detection),o=this.input instanceof mr.Tensor?await Tt(this.input,t):await vt(this.input,t),n=await Promise.all(o.map(a=>this.landmarkNet.detectLandmarks(a)));return o.forEach(a=>a instanceof mr.Tensor&&a.dispose()),e.map((a,s)=>Nt(a,n[s]))}withFaceExpressions(){return new ft(this,this.input)}withAgeAndGender(){return new ut(this,this.input)}withFaceDescriptors(){return new qe(this,this.input)}},Vr=class extends Gr{async run(){let e=await this.parentTask;if(!e)return;let{detection:t}=e,o=this.input instanceof mr.Tensor?await Tt(this.input,[t]):await vt(this.input,[t]),n=await this.landmarkNet.detectLandmarks(o[0]);return o.forEach(a=>a instanceof mr.Tensor&&a.dispose()),Nt(e,n)}withFaceExpressions(){return new dt(this,this.input)}withAgeAndGender(){return new lt(this,this.input)}withFaceDescriptor(){return new Xe(this,this.input)}};var qr=class extends ce{constructor(e,t=new ae){super();this.input=e;this.options=t}},pr=class extends qr{async run(){let{input:e,options:t}=this,o=t instanceof zr?n=>P.tinyFaceDetector.locateFaces(n,t):t instanceof ae?n=>P.ssdMobilenetv1.locateFaces(n,t):t instanceof ye?n=>P.tinyYolov2.locateFaces(n,t):null;if(!o)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return o(e)}runAndExtendWithFaceDetections(){return new Promise(async e=>{let t=await this.run();e(t.map(o=>Qe({},o)))})}withFaceLandmarks(e=!1){return new Ur(this.runAndExtendWithFaceDetections(),this.input,e)}withFaceExpressions(){return new jt(this.runAndExtendWithFaceDetections(),this.input)}withAgeAndGender(){return new Ot(this.runAndExtendWithFaceDetections(),this.input)}},Xr=class extends qr{async run(){let e=await new pr(this.input,this.options),t=e[0];return e.forEach(o=>{o.score>t.score&&(t=o)}),t}runAndExtendWithFaceDetection(){return new Promise(async e=>{let t=await this.run();e(t?Qe({},t):void 0)})}withFaceLandmarks(e=!1){return new Vr(this.runAndExtendWithFaceDetection(),this.input,e)}withFaceExpressions(){return new Ht(this.runAndExtendWithFaceDetection(),this.input)}withAgeAndGender(){return new $t(this.runAndExtendWithFaceDetection(),this.input)}};function Ns(r,e=new ae){return new Xr(r,e)}function Jr(r,e=new ae){return new pr(r,e)}async function oa(r,e){return Jr(r,new ae(e?{minConfidence:e}:{})).withFaceLandmarks().withFaceDescriptors()}async function Ls(r,e={}){return Jr(r,new ye(e)).withFaceLandmarks().withFaceDescriptors()}var Ss=oa;function qo(r,e){if(r.length!==e.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");let t=Array.from(r),o=Array.from(e);return Math.sqrt(t.map((n,a)=>n-o[a]).reduce((n,a)=>n+a**2,0))}var Zr=class{constructor(e,t=.6){this._distanceThreshold=t;let o=Array.isArray(e)?e:[e];if(!o.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");let n=1,a=()=>`person ${n++}`;this._labeledDescriptors=o.map(s=>{if(s instanceof we)return s;if(s instanceof Float32Array)return new we(a(),[s]);if(s.descriptor&&s.descriptor instanceof Float32Array)return new we(a(),[s.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}get labeledDescriptors(){return this._labeledDescriptors}get distanceThreshold(){return this._distanceThreshold}computeMeanDistance(e,t){return t.map(o=>qo(o,e)).reduce((o,n)=>o+n,0)/(t.length||1)}matchDescriptor(e){return this.labeledDescriptors.map(({descriptors:t,label:o})=>new Gt(o,this.computeMeanDistance(e,t))).reduce((t,o)=>t.distance<o.distance?t:o)}findBestMatch(e){let t=this.matchDescriptor(e);return t.distance<this.distanceThreshold?t:new Gt("unknown",t.distance)}toJSON(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(e=>e.toJSON())}}static fromJSON(e){let t=e.labeledDescriptors.map(o=>we.fromJSON(o));return new Zr(t,e.distanceThreshold)}};function ks(r){let e=new Rt;return e.extractWeights(r),e}function na(r,e){let{width:t,height:o}=new O(e.width,e.height);if(t<=0||o<=0)throw new Error(`resizeResults - invalid dimensions: ${JSON.stringify({width:t,height:o})}`);if(Array.isArray(r))return r.map(n=>na(n,{width:t,height:o}));if(it(r)){let n=r.detection.forSize(t,o),a=r.unshiftedLandmarks.forSize(n.box.width,n.box.height);return Nt(Qe(r,n),a)}return be(r)?Qe(r,r.detection.forSize(t,o)):r instanceof J||r instanceof M?r.forSize(t,o):r}var As=typeof process!="undefined",Bs=typeof navigator!="undefined"&&typeof navigator.userAgent!="undefined",Ws={faceapi:wn,node:As,browser:Bs};
//# sourceMappingURL=face-api.node-cpu.js.map
